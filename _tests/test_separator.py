import sys

sys.path.append('../_src/')

import logging

logger = logging.getLogger('lab')
logger.setLevel(logging.DEBUG)
handler = logging.StreamHandler(sys.stdout)
formatter = logging.Formatter('%(message)s')
handler.setFormatter(formatter)
logger.addHandler(handler)

import unittest

import numpy as np

np.set_printoptions(linewidth=np.inf)

from eos import (
  pr78,
)

from lab import (
  SimpleSeparator,
  GasSeparator,
  MultiSeparator,
)


class sep(unittest.TestCase):

  def test_01(self):
    yi = np.array([0.078407, 0.862017, 0.033332, 0.013233, 0.006012, 0.004636,
                   0.001919, 0.000432, 1.2e-5])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,-0.01087,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    sep = SimpleSeparator(pr)
    res = sep.run(yi)
    pass

  def test_02(self):
    yi = np.array([0.078407, 0.862017, 0.033332, 0.013233, 0.006012, 0.004636,
                   0.001919, 0.000432, 1.2e-5])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,-0.01087,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    sep = GasSeparator(pr)
    res = sep.run(yi)
    pass

  def test_03(self):
    yi = np.array([0.078407, 0.862017, 0.033332, 0.013233, 0.006012, 0.004636,
                   0.001919, 0.000432, 1.2e-5])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,-0.01087,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    code = ('def main 4;'
            'def oil 1;'
            'flash main 0 7e6 223.15;'
            'move 1 main 0 oil 0;'
            'move 0 main 0 main 1;'
            'flash main 1 4.5e6 238.15;'
            'move 1 main 1 oil 0;'
            'move 0 main 1 main 2;'
            'flash main 2 2e6 258.15;'
            # 'move 1 main 2 oil 0;'
            'move 0 main 2 main 3;'
            'flash main 3 101325. 293.15;'
            # 'move 1 main 3 oil 0;'
            'flash oil 0 101325. 293.15;'
            'move 0 oil 0 main 3;'
            'flash main 3 101325. 293.15;'
            'flash oil 0 101325. 293.15')
    sep = MultiSeparator(pr, code, 2)
    res = sep.run(yi)
    pass

  def test_04(self):
    yi = np.array([0.0392035, 0.4310085, 0.016666, 0.0066165, 0.003006,
                   0.002318, 0.0009595, 0.000216, 6e-6, 0.5])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698, 217.6]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580, 647.3])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005, 0.344])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653, 0.232])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021, 18.015]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,
      -0.01087,
      0.11000, 0.49070, 0.54690, 0.48000, 0.48000, 0.48000,  0.48000,
       0.48000, 0.48000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    sep = GasSeparator(pr, maxNp=3, maxiter=53)
    res = sep.run(yi)
    pass


if __name__ == '__main__':
  unittest.main(verbosity=0)
