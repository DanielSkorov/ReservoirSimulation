import sys

sys.path.append('../_src/')

import logging

logger = logging.getLogger('flash')
logger.setLevel(logging.DEBUG)
handler = logging.StreamHandler(sys.stdout)
formatter = logging.Formatter('%(message)s')
handler.setFormatter(formatter)
logger.addHandler(handler)

import unittest

import numpy as np

np.set_printoptions(linewidth=np.inf)

from eos import (
  pr78,
)

from flash import (
  flashNpPT,
)


class flashnp(unittest.TestCase):

  def test_01(self):
    P = 6e6
    T = 10. + 273.15
    yi = np.array([0.9, 0.1])
    Pci = np.array([7.37646e6, 4.600155e6])
    Tci = np.array([304.2, 190.6])
    wi = np.array([0.225, 0.008])
    mwi = np.array([0.04401, 0.016043])
    vsi = np.array([0., 0.])
    dij = np.array([0.025])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    flash = flashNpPT(pr, maxiter=7)
    res = flash.run(P, T, yi)
    pass

  def test_02(self):
    P = 17e6
    T = 68. + 273.15
    yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573])
    Pci = np.array([4.599e6, 4.872e6, 4.248e6, 3.796e6, 2.398e6])
    Tci = np.array([190.56, 305.32, 369.83, 425.12, 551.02])
    wi = np.array([0.012, 0.100, 0.152, 0.200, 0.414])
    mwi = np.array([0.016043, 0.03007, 0.044097, 0.058123, 0.120])
    vsi = np.array([-0.1595, -0.1134, -0.0863, -0.0675, 0.05661])
    dij = np.array([
      0.002689,
      0.008537, 0.001662,
      0.014748, 0.004914, 0.000866,
      0.039265, 0.021924, 0.011676, 0.006228,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    flash = flashNpPT(pr, maxiter=5)
    res = flash.run(P, T, yi)
    pass

  def test_03(self):
    P = 1e6
    T = 160.
    yi = np.array([0.9430, 0.0270, 0.0074, 0.0049, 0.0027, 0.0010, 0.0140])
    Pci = np.array([4.599, 4.872, 4.248, 3.796, 3.370, 3.025, 3.400]) * 1e6
    Tci = np.array([190.56, 305.32, 369.83, 425.12, 469.70, 507.60, 126.20])
    wi = np.array([0.0115, 0.0995, 0.1523, 0.2002, 0.2515, 0.3013, 0.0377])
    mwi = np.array([0.0160, 0.0301, 0.0441, 0.0581, 0.0722, 0.0860, 0.0280])
    vsi = np.array([0., 0., 0., 0., 0., 0., 0.])
    dij = np.array([
      0.00269,
      0.00854, 0.00166,
      0.01475, 0.00491, 0.00087,
      0.02064, 0.00858, 0.00271, 0.00051,
      0.02535, 0.01175, 0.00462, 0.00149, 0.0002,
      0.02500, 0.06000, 0.09000, 0.09500, 0.11000, 0.11000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    flash = flashNpPT(pr, maxiter=9)
    res = flash.run(P, T, yi)
    pass

  def test_04(self):
    P = 8.7625e6
    T = 316.48
    yi = np.array([
      0.590516, 0.028933, 0.072729, 0.081162, 0.131012, 0.064671, 0.030977,
    ])
    Pci = np.array([73.36, 45.99, 45.53, 33.68, 20.95, 15.88, 15.84]) * 1e5
    Tci = np.array([304.20, 166.67, 338.81, 466.12, 611.11, 777.78, 972.22])
    wi = np.array([0.225, 0.008, 0.126, 0.244, 0.639, 1.000, 1.281])
    vsi = np.array([0., 0., 0., 0., 0., 0., 0.])
    mwi = np.array([0.044, 0.016, 0.037, 0.072, 0.161, 0.312, 0.495])
    dij = np.array([
      0.05,
      0.05, 0.00853,
      0.05, 0.02064, 0.00271,
      0.09, 0.05428, 0.02079, 0.00863,
      0.09, 0.09301, 0.04829, 0.02887, 0.00615,
      0.09, 0.12546, 0.07402, 0.05002, 0.01794, 0.00316,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
    flash = flashNpPT(pr, maxiter=10)
    res = flash.run(P, T, yi)
    pass

  def test_05(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([0.1, 0.6, 0.3])
    Pci = np.array([4.600155, 3.2890095, 22.04832]) * 1e6
    Tci = np.array([190.6, 507.5, 647.3])
    wi = np.array([0.008, 0.27504, 0.344])
    vsi = np.array([0., 0., 0.])
    mwi = np.array([0.016043, 0.086, 0.018015])
    dij = np.array([
      0.0253,
      0.4907, 0.48,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='ss', maxNp=3, maxiter=5)
    res = flash.run(P, T, yi)
    pass

  def test_06(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([0.1, 0.6, 0.3])
    Pci = np.array([4.600155, 3.2890095, 22.04832]) * 1e6
    Tci = np.array([190.6, 507.5, 647.3])
    wi = np.array([0.008, 0.27504, 0.344])
    vsi = np.array([0., 0., 0.])
    mwi = np.array([0.016043, 0.086, 0.018015])
    dij = np.array([
      0.0253,
      0.4907, 0.48,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='qnss', maxNp=3, maxiter=5)
    res = flash.run(P, T, yi)
    pass

  def test_07(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([0.1, 0.6, 0.3])
    Pci = np.array([4.600155, 3.2890095, 22.04832]) * 1e6
    Tci = np.array([190.6, 507.5, 647.3])
    wi = np.array([0.008, 0.27504, 0.344])
    vsi = np.array([0., 0., 0.])
    mwi = np.array([0.016043, 0.086, 0.018015])
    dij = np.array([
      0.0253,
      0.4907, 0.48,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='newton', maxNp=3, maxiter=3)
    res = flash.run(P, T, yi)
    pass

  def test_08(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([0.1, 0.6, 0.3])
    Pci = np.array([4.600155, 3.2890095, 22.04832]) * 1e6
    Tci = np.array([190.6, 507.5, 647.3])
    wi = np.array([0.008, 0.27504, 0.344])
    vsi = np.array([0., 0., 0.])
    mwi = np.array([0.016043, 0.086, 0.018015])
    dij = np.array([
      0.0253,
      0.4907, 0.48,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='ss-newton', maxNp=3, maxiter=5)
    res = flash.run(P, T, yi)
    pass

  def test_09(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([0.1, 0.6, 0.3])
    Pci = np.array([4.600155, 3.2890095, 22.04832]) * 1e6
    Tci = np.array([190.6, 507.5, 647.3])
    wi = np.array([0.008, 0.27504, 0.344])
    vsi = np.array([0., 0., 0.])
    mwi = np.array([0.016043, 0.086, 0.018015])
    dij = np.array([
      0.0253,
      0.4907, 0.48,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='qnss-newton', maxNp=3, maxiter=5)
    res = flash.run(P, T, yi)
    pass

  def test_10(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([8.69598534e-4, 2.02037952e-2, 3.35627532e-3, 3.32035291e-3,
                   2.82846887e-3, 3.61391271e-3, 1.78758545e-3, 4.15960699e-4,
                   1.15631214e-5, 9.63592487e-1])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698, 217.6]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580, 647.3])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005, 0.344])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653, 0.232])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021, 18.015]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,
      -0.01087,
      0.11000, 0.49070, 0.54690, 0.48000, 0.48000, 0.48000,  0.48000,
       0.48000, 0.48000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='ss', maxNp=3, maxiter=8)
    res = flash.run(P, T, yi)
    pass

  def test_11(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([8.69598534e-4, 2.02037952e-2, 3.35627532e-3, 3.32035291e-3,
                   2.82846887e-3, 3.61391271e-3, 1.78758545e-3, 4.15960699e-4,
                   1.15631214e-5, 9.63592487e-1])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698, 217.6]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580, 647.3])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005, 0.344])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653, 0.232])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021, 18.015]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,
      -0.01087,
      0.11000, 0.49070, 0.54690, 0.48000, 0.48000, 0.48000,  0.48000,
       0.48000, 0.48000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='qnss', maxNp=3, maxiter=35)
    res = flash.run(P, T, yi)
    pass

  def test_12(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([8.69598534e-4, 2.02037952e-2, 3.35627532e-3, 3.32035291e-3,
                   2.82846887e-3, 3.61391271e-3, 1.78758545e-3, 4.15960699e-4,
                   1.15631214e-5, 9.63592487e-1])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698, 217.6]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580, 647.3])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005, 0.344])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653, 0.232])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021, 18.015]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,
      -0.01087,
      0.11000, 0.49070, 0.54690, 0.48000, 0.48000, 0.48000,  0.48000,
       0.48000, 0.48000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='newton', maxNp=3, maxiter=4)
    res = flash.run(P, T, yi)
    pass

  def test_13(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([8.69598534e-4, 2.02037952e-2, 3.35627532e-3, 3.32035291e-3,
                   2.82846887e-3, 3.61391271e-3, 1.78758545e-3, 4.15960699e-4,
                   1.15631214e-5, 9.63592487e-1])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698, 217.6]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580, 647.3])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005, 0.344])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653, 0.232])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021, 18.015]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,
      -0.01087,
      0.11000, 0.49070, 0.54690, 0.48000, 0.48000, 0.48000,  0.48000,
       0.48000, 0.48000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='ss-newton', maxNp=3, maxiter=8)
    res = flash.run(P, T, yi)
    pass

  def test_14(self):
    P = 101325.
    T = 20. + 273.15
    yi = np.array([8.69598534e-4, 2.02037952e-2, 3.35627532e-3, 3.32035291e-3,
                   2.82846887e-3, 3.61391271e-3, 1.78758545e-3, 4.15960699e-4,
                   1.15631214e-5, 9.63592487e-1])
    Pci = np.array([32.789, 45.4, 48.2, 41.9, 37.022, 33.008, 20.794, 16.727,
                    11.698, 217.6]) * 101325.
    Tci = np.array([122.141, 190.6, 305.4, 369.8, 419.746, 482.781, 547.033,
                    674.011, 833.580, 647.3])
    wi = np.array([0.02946, 0.008, 0.098, 0.152, 0.18767, 0.25456, 0.31931,
                   0.32841, 0.43005, 0.344])
    vsi = np.array([-0.15670, -0.18633, -0.15018, -0.11403, -0.07789,
                    -0.02655, 0.01541, 0.10440, 0.22653, 0.232])
    mwi = np.array([27.385, 16.043, 30.070, 44.097, 58.124, 77.671, 103.418,
                    185.177, 298.021, 18.015]) / 1e3
    dij = np.array([
      0.00030,
      0.00035, 0.00566,
      0.00043, 0.01884, 0.00296,
      0.00121, 0.02884, 0.00874, 0.00087,
      0.00150, 0.04275, 0.01812, 0.00824, 0.00211,
      0.00176, 0.06061, 0.03113, 0.02758, 0.01329, 0.00564,
      0.00418, 0.15956, 0.10787, 0.07426, 0.04277, 0.02351, -0.00126,
      0.00630, 0.19705, 0.13549, 0.08406, 0.05104, 0.02627, -0.01284,
      -0.01087,
      0.11000, 0.49070, 0.54690, 0.48000, 0.48000, 0.48000,  0.48000,
       0.48000, 0.48000,
    ])
    pr = pr78(Pci, Tci, wi, mwi, vsi, dij, kvlevel=3)
    flash = flashNpPT(pr, method='qnss-newton', maxNp=3, maxiter=35)
    res = flash.run(P, T, yi)
    pass


if __name__ == '__main__':
  unittest.main(verbosity=0)
