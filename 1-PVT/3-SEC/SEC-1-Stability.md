---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 3.0.1
    jupytext_version: 1.16.3
kernelspec:
  display_name: Python 3 (ipykernel)
  language: python
  name: python3
---

(pvt-sec-stability)=
# Определение стабильности фазового состояния системы

В данном разделе будут представлены критерии стабильности фазового состояния системы, позволяющие определить, является ли рассматриваемое фазовое состояние системы стабильным для различных формулировок ([PT-термодинамика](#pvt-sec-stability-pt) и [VT-термодинамика](pvt-sec-stability-vt)), а также численные алгоритмы и их реализации. Выбор той или иной формулировки зачастую определяется теми переменными, через которые удобнее выражать уравнение состояния. Проверка стабильности фазового равновесия является первым из двух последовательных шагов к определению равновесного фазового состояния системы.

(pvt-sec-stability-pt)=
## PT-термодинамика

(pvt-sec-stability-pt-theory)=
### Теоретические основы анализа стабильности фазового состояния системы

Пусть некоторая многокомпонентная макроскопическая система находится в равновесном состоянии и характеризуется давлением $P$, температурой $T$ и количеством вещества всех компонентов $n_i, \; i=1..N_c$, где $N_c$ – число компонентов, составляющих рассматриваемую систему. Можем ли мы использовать некоторое уравнение состояния для описания взаимосвязей между термодинамическими параметрами? Ответ на этот вопрос зависит от того, является ли рассматриваемая система гомогенной, то есть состоящей из одной сплошной фазы. Иными словами, является ли однофазное состояние рассматриваемой системы *стабильным*. Именно исследованию данного вопроса будет посвящен настоящий раздел. Однако, прежде чем переходить к рассмотрению темы стабильности фазового состояния системы, необходимо ввести ряд определений. Некоторые из них будут перекликаться с рассмотренными ранее темами, но при этом являться более обобщенными. Теоретическое изложение рассматриваемой проблемы соответствует работе \[[Baker et al, 1982](https://doi.org/10.2118/9806-PA)\].

```{admonition} Определение
:class: tip
Пусть имеется некоторая $j$-ая фаза, многофазной системы, состоящая из $N_c$ компонентов, при этом количество вещества компонентов в фазе $j$ определяется следующим [вектором](../../0-Math/0-LAB/LAB-1-Vectors.md):

$$ \mathbf{n}^j = \begin{bmatrix} n_1^j \\ n_2^j \\ \vdots \\ n_{N_c}^j \end{bmatrix}. $$

Если количество вещества компонентов в системе в целом определяется вектором

$$ \mathbf{n} = \begin{bmatrix} n_1 \\ n_2 \\ \vdots \\ n_{N_c} \end{bmatrix}, $$

то фаза $j$ является ***допустимой*** *(admissible)*, если

$$ 0 < n_i^j < n_i, \; i = 1 \ldots N_c.$$
```

Иными словами, фаза является *допустимой*, если количество вещества каждого компонента, в нее входящего, меньше количества вещества этого же компонента в системе в целом. Все дальнейшие выкладки будут касаться допустимых фаз, в которых представлены все компоненты, не взаимодействующие друг с другом с образованием новых компонентов, то есть не вступающие в реакции. Кроме того, необходимо отметить, что здесь и далее нижний индекс будет характеризовать некоторый компонент, а верхних – некоторую фазу. Для допустимых фаз справедливо следущее соотношение:

$$ \sum_{j=1}^{N_p} n_i^j = n_i, $$

где $N_p$ – количество фаз в системе. При известных и заданных давлении и температуре рассматриваемой системы, а также количествах вещества компонентов в ней [энергия Гиббса](../1-TD/TD-10-MixtureGibbsEnergy.md) некоторой фазы определяется количеством вещества каждого компонента в фазе, то есть:

$$ G^j = G^j \left( \mathbf{n}^j \right). $$

Учитывая [экстенсивность](../1-TD/TD-9-Observables.md#pvt-td-observables-extensive) энергии Гиббса, для многофазной системы справедливо следующее соотношение:

$$ G \left( \mathbf{n} \right) = G \left( \mathbf{n}^1, \, \mathbf{n}^2, \, \ldots \, , \mathbf{n}^j \right) = \sum_{j=1}^{N_p} G^j \left( \mathbf{n}^j \right). $$

```{admonition} Определение
:class: tip
Некоторое $\hat{K}$ состояние системы, характеризующееся $N_p$ количеством *допустимых* фаз, удовлетворяющих закону сохранения масс, является ***равновесным***, если:

$$ G \left( \hat{K} \right) = \min_l G^l \left( \hat{L} \right), $$

где минимум берется по всем состояниям $\hat{L}$, характеризующимся $K_p$ количеством *допустимых* фаз, удовлетворяющих закону сохранения масс.

```

В данном определении необходимо отметить два момента. Первый: *равновесное состояние* характеризуется минимумом энергии Гиббса всей многофазной системы. Более подробно это рассматривалось [ранее](../1-TD/TD-14-PhaseEquilibrium.md). Второй: для того чтобы доказать, что некоторое состояние $\hat{K}$ многофазной системы из $N_p$ является *равновесным*, мы можем рассмотреть множество других состояний $\hat{L}$, каждое из которых будет характеризоваться своим количеством фаз $K_p$, и если в состоянии $\hat{K}$ с количеством фаз $N_p$ энергия Гиббса меньше всего, то оно и будет равновесным.

Представленное в предыдущем определении условие идентификации равновесного состояния, по сути, аналогично условию нахождения [глобального минимума функции](https://en.wikipedia.org/wiki/Maximum_and_minimum). [Известно](https://en.wikipedia.org/wiki/First_derivative_test), что необходимым условием для соответствия некоторого точки (состояния) глобальному минимуму функции (энергии Гиббса) является равенство нулю производной в этой точке (этом состоянии). Такое состояние, в котором энергия Гиббса всей многофазной многокомпонентной системы характеризуется равенством нулю частной производной по количеству вещества $i$-го компонента в $j$-ой фазе при фиксированных давлении и температуре будет характеризоваться равенством химических потенциалов соответствующих компонентов в фазах.

```{admonition} Теорема
:class: danger
Пусть многофазная многокомпонентная система находится при фиксированных давлении $P$, температуре $T$ и количествах вещества компонентов в ней $n_i, \; i=1 \, \ldots \, N_c,$ в некотором состоянии $\hat{K}$ с количеством фаз $N_p$ с соответствующими количествами вещества компонентов $n_i^j, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p$. В этом состоянии частная производная энергии Гиббса всей системы по $n_i^j$ равна нулю:

$$ \left( \frac{\partial G}{\partial n_i^j} \right)_{P,T,n_k^l,k \neq i, l \neq j} = 0. $$

Тогда для такого состояния системы будет справедливо следующее равенство:

$$ \mu_i^j = \mu_i^{N_p}, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p. $$
```

Докажем  это следующим образом.

```{admonition} Доказательство
:class: proof
Учитывая экстенсивность энергии Гиббса, преобразуем частную производную энергии Гиббса всей системы по $n_i^j$ следующим образом:

$$ \begin{align}
\left( \frac{\partial G}{\partial n_i^j} \right)_{P,T,n_k^l, k \neq i, l \neq j}
&= \frac{\partial}{\partial n_i^j} \left( \sum_{l=1}^{N_p} G^l \left( n_k^l \right) \right)_{P,T,n_k^l, k \neq i, l \neq j} \\
&= \frac{\partial}{\partial n_i^j} \left( \sum_{l=1}^{N_p-1} G^l \left( n_k^l \right) \right)_{P,T,n_k^l, k \neq i, l \neq j} + \left( \frac{\partial G^{N_p} \left( n_k^{N_p} \right)}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i} \\
&= \sum_{l=1}^{N_p-1} \left( \frac{\partial G^l \left( n_k^l \right)}{\partial n_i^j} \right)_{P,T,n_k^l, k \neq i, l \neq j} + \left( \frac{\partial G^{N_p} \left( n_k^{N_p} \right)}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i}.
\end{align} $$

Принимая во внимание, что энергия Гиббса $j$-й фазы зависит от количеств вещества компонентов в этой $j$-й фазе, то есть:

$$ \left( \frac{\partial G^l \left( n_k^l \right)}{\partial n_i^j} \right)_{P,T,n_k^l, k \neq i, l \neq j} = 0, \; l \neq j, $$

частная производная энергии Гиббса всей системы по $n_i^j$:

$$ \left( \frac{\partial G}{\partial n_i^j} \right)_{P,T,n_k^l, k \neq i, l \neq j} = \left( \frac{\partial G^j \left( n_k^j \right)}{\partial n_i^j} \right)_{P,T,n_k^j, k \neq i} + \left( \frac{\partial G^{N_p} \left( n_k^{N_p} \right)}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i}. $$

Учитывая правило нахождение сложной функции, данное выражение преобразуется следующим образом:

$$ \left( \frac{\partial G}{\partial n_i^j} \right)_{P,T,n_k^l, k \neq i, l \neq j} = \left( \frac{\partial G^j \left( n_k^j \right)}{\partial n_i^j} \right)_{P,T,n_k^j, k \neq i} + \left( \frac{\partial n_k^{N_p}}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i} \left( \frac{\partial G^{N_p} \left( n_k^{N_p} \right)}{\partial n_k^{N_p}} \right)_{P,T,n_k^{N_p},k \neq i}. $$

Выразим из закона сохранения масс количество вещества $k$-го компонента в $N_p$-й фазе:

$$ \sum_{l=1}^{N_p} n_k^l = n_k \Rightarrow n_k^{N_p} = n_k - \sum_{l=1}^{N_p-1} n_k^l. $$

Тогда частная прозводная количества вещества $k$-го компонента в $l$-й фазе по количеству вещества $i$-го компонента в $j$-ой фазе:

$$ \left( \frac{\partial n_k^{N_p}}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i} = \left( \frac{\partial n_k}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i} - \sum_{l=1}^{N_p-1} \left( \frac{\partial n_k^l}{\partial n_i^j} \right)_{P,T,n_k^l,k \neq i,l \neq j} $$

Первое слагаемое в данном выражении равно нулю, поскольку количество вещества каждого компонента в системе в целом зафиксировано. Второе слагаемое можно представить следующим образом:

$$ \left( \frac{\partial n_k^l}{\partial n_i^j} \right)_{P,T,n_k^l,k \neq i,l \neq j} = \begin{cases} 1 & \mathrm{if} \; k=i \land l=j, \; k=1 \ldots N_c, \, l=1 \ldots N_p, \\ 0 & \mathrm{if} \; k \neq i \lor l \neq j, \; k=1 \ldots N_c, \, l=1 \ldots N_p. \end{cases} $$

Таким образом,

$$ \left( \frac{\partial n_k^{N_p}}{\partial n_i^j} \right)_{P,T,n_k^{N_p},k \neq i} = \begin{cases} -1 & \mathrm{if} \; k=i \land j=N_p, \\ 0 & \mathrm{if} \; k \neq i \lor j \neq N_p. \end{cases} $$

С учетом этого частная производная энергии Гиббса всей системы по $n_i^j$:

$$ \left( \frac{\partial G}{\partial n_i^j} \right)_{P,T,n_k^l, k \neq i, l \neq j} = \left( \frac{\partial G^j \left( n_k^j \right)}{\partial n_i^j} \right)_{P,T,n_k^j, k \neq i} - \left( \frac{\partial G^{N_p} \left( n_k^{N_p} \right)}{\partial n_i^{N_p}} \right)_{P,T,n_k^{N_p},k \neq i} = 0. $$

Поскольку частная производная энергии Гиббса некоторой фазы по количеству вещества $i$-го компонента в этой фазе при фиксированных давлении и температуре [соответствует](../1-TD/TD-10-MixtureGibbsEnergy.md) химическому потенциалу $i$-го компонента в этой фазе, то:

$$ \mu_i^j - \mu_i^{N_p} = 0, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p. $$

```

[Ранее](../1-TD/TD-15-Fugacity.md#pvt-td-fugacity-equilibrium) было показано, что для изотермического квази-стационарного процесса равенство химических потенциалов равносильно равенству летучестей.

Поскольу условие равенства нулю частной производной энергии Гиббса системы в целом по количеству вещества $i$-го компонента в $j$-ой фазе при фиксированных давлении и температуре является необходимым, но не достаточным, то рассматриваемая система может характеризоваться набором состояний, удовлетворяющих данному условию. Такие состояния будем называть *стационарными*.

```{admonition} Определение
:class: tip
Cостояние $\hat{L} = \left\{ \mathbf{n}^j, \; j = 1 \, \ldots K_p \right\}$ является ***стационарным***, если:

$$ \left( \frac{\partial G}{\partial n_i^j} \right)_{P,T,n_k^l,k \neq i, l \neq j} = 0, \; i=1 \, \ldots \, N_c, \; j = 1 \, \ldots K_p. $$

```

Центральным для анализа стабильности фазового состояния системы является положение, определяющее, что стационарное состояние системы может быть определено путем идентификации общих точек касательной [гиперплоскости](https://en.wikipedia.org/wiki/Hyperplane) к [гиперповерхности](https://en.wikipedia.org/wiki/Hypersurface) функции энергии Гиббса. Приставки "гипер" необходимы при рассмотрении $N_c$-мерного пространства. Например, для двух компонентов функция энергии Гиббса представляет собой кривую на плоскости, касательной к которой является прямая. Для трех компонентов функция энергии Гиббса представляет собой поверхность, а касательная к ней – плоскость. Для $N_c$ компонентов функция энергии Гиббса – гиперповерхность, касательная к ней – гиперплоскость. Далее под поверхностью и плоскостью будут пониматься именно гиперповерхность и гиперплоскость соответственно.

```{admonition} Теорема
:class: danger
Пусть $\hat{K}$ является некоторым состоянием системы, состоящей из $N_p$ допустимых фаз, удовлетворяющих закону сохранения масс, с известным количеством вещества компонентов в фазах $\mathbf{n}^j, \; j = 1 \, \ldots \, N_p$. Тогда $G \left( \hat{K} \right)$ является стационарной точкой тогда и только тогда, когда $G$ дифференциируема для всех $\mathbf{n}^j$ и поверхность $G$ имеет одинаковую касательную плоскость для каждого $\mathbf{n}^j$.
```

Приведем доказательство данной теоремы.

```{admonition} Доказательство
:class: proof
Пусть $L^j \left( \mathbf{r} \right)$ является касательной плоскостью к поверхности $G \left( \mathbf{r} \right)$ в точке $\mathbf{n}^j$, являющейся стационарной. Тогда [уравнение касательной](https://en.wikipedia.org/wiki/Tangent) плоскости $L^j \left( \mathbf{r} \right)$ к поверхности $G \left( \mathbf{r} \right)$ в точке $\mathbf{n}^j$ описывается следующим выражением:

$$ L^j \left( \mathbf{r} \right) = G \left( \mathbf{n}^j \right) + \sum_{i=1}^{N_c} \frac{\partial G}{\partial r_i} \bigg|_{n_i^j} \left( r_i - n_i^j \right). $$

Так как энергия Гиббса является экстенсивным параметром, то при фиксированных давлении и температуре для нее выполняется следующее [свойство](../1-TD/TD-10-MixtureGibbsEnergy.md):

$$ G \left( \mathbf{n}^j \right) = \sum_{i=1}^{N_c} \frac{\partial G}{\partial r_i} \bigg|_{n_i^j} n_i^j = \sum_{i=1}^{N_c} \mu_i^j n_i^j. $$

Подставляя данное выражение в уравнение касательной поверхности, получим:

$$ L^j \left( \mathbf{r} \right) = \sum_{i=1}^{N_c} \frac{\partial G}{\partial r_i} \bigg|_{n_i^j} n_i^j + \sum_{i=1}^{N_c} \frac{\partial G}{\partial r_i} \bigg|_{n_i^j} r_i - \sum_{i=1}^{N_c} \frac{\partial G}{\partial r_i} \bigg|_{n_i^j} n_i^j = \sum_{i=1}^{N_c} \frac{\partial G}{\partial r_i} \bigg|_{n_i^j} r_i = \sum_{i=1}^{N_c} \mu_i^j r_i. $$

Поскольку для стационарного состояния выполняется условие постоянства химического потенциала компонентов, то есть химический потенциал каждого компонента не зависит от фазы, то есть $\mu_i^j = \mu_i^{N_p}, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p-1,$ в соответствии с приведенной выше леммой, то $L^j \left( \mathbf{r} \right)$ также не будет зависеть от фазы $j$, следовательно, для всех $j$ в стационарном состоянии уравнение касательной плоскости к поверхности энергии Гиббса одинаково. Верно и обратное: если все $L^j$ одинаковы, то химические потенциалы компонентов равны, и состояние является стационарным.
```

Представленная выше теорема говорит о том, что в стационарном состоянии $\hat{K}$ касательная плоскость $L^j \left( \mathbf{r} \right)$ к поверхности энергии Гиббса $G \left( \mathbf{r} \right)$ одинакова для всех составов фаз $\mathbf{n}^j, \; j = 1 \, \ldots \, N_p,$ определяющих рассматриваемое стационарное состояние $\hat{K} = \left\{ \mathbf{n}^j, \; j = 1 \, \ldots N_p \right\}$. Однако в конечном счете нам необходимо установить, является ли стационарное состояние стабильным (равновесным). Для этого введем следующие обозначения.

Пусть $D \left( \mathbf{r} \right)$ является функцией разности между энергией Гиббса $G \left( \mathbf{r} \right)$ и функцией касательной плоскости к ней $L \left( \mathbf{r} \right)$:

$$ D \left( \mathbf{r} \right) = G \left( \mathbf{r} \right) - L \left( \mathbf{r} \right). $$

Для равновесного состояния (которое также является стационарным) в соответствии с представленной выше леммой преобразуем уравнение касательной плоскости:

$$ D \left( \mathbf{r} \right) = G \left( \mathbf{r} \right) - \sum_{i=1}^{N_c} \mu_i r_i.$$

Далее будет показано, что при любых значениях $\mathbf{r}$ в равновесном состоянии функция $D \left( \mathbf{r} \right)$ не принимает отрицательных значений. Однако прежде чем переходить к доказательству этого утверждения необходимо рассмотреть следующую лемму:

```{admonition} Лемма
:class: danger
Разница между энергией Гиббса системы в *любом состоянии*, состоящей из $K_p$ приемлемых фаз, компонентный состав которых $\mathbf{r}^k, \; k = 1 \, \ldots \, K_p,$ и удовлетворяющих закону сохранения масс, и энергией Гиббса в *стационарном состоянии* с $N_p$ приемлемыми фазами, компонентный состав которых $\mathbf{n}^j, \; j = 1 \, \ldots \, N_p,$ причем $K_p$ может быть неравно $N_p$, есть сумма $D \left( \mathbf{r}^k \right)$ по количеству фаз $K_p$, то есть:

$$ \sum_{k=1}^{K_p} G \left( \mathbf{r}^k \right) - \sum_{j=1}^{N_p} G \left( \mathbf{n}^j \right) = \sum_{k=1}^{K_p} D \left( \mathbf{r}^k \right). $$
```

Доказательство:

```{admonition} Доказательство
:class: proof
Поскольку система одна и та же, то выполняется закон сохранения масс:

$$ n_i = \sum_{j=1}^{N_p} n_i^j = \sum_{k=1}^{K_p} r_i^k, \; i = 1 \, \ldots \, N_c. $$

Для стационарного состояния характерно постоянство химического потенциала компонента $\mu_i^j$ среди всех фаз $j = 1 \ldots N_p$. То есть справедливо следующее равенство:

$$ \mu_i^j = \mu_i^{N_p}, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p. $$

Следовательно:

$$ \begin{align}
\sum_{j=1}^{N_p} G \left( \mathbf{n}^j \right)
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} \mu_i^j n_i^j \\
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} \mu_i^1 n_i^j \\
&= \sum_{i=1}^{N_c} \mu_i^1 \sum_{j=1}^{N_p} n_i^j \\
&= \sum_{i=1}^{N_c} \mu_i^1 \sum_{k=1}^{K_p} r_i^k \\
&= \sum_{k=1}^{K_p} \sum_{i=1}^{N_c} \mu_i^1 r_i^k \\
&= \sum_{k=1}^{K_p} L \left( \mathbf{r}^k \right).
\end{align} $$

Тогда

$$ \begin{align}
\sum_{k=1}^{K_p} G \left( \mathbf{r}^k \right) - \sum_{j=1}^{N_p} G \left( \mathbf{n}^j \right)
& = \sum_{k=1}^{K_p} G \left( \mathbf{r}^k \right) - \sum_{k=1}^{K_p} L \left( \mathbf{r}^k \right) \\
& = \sum_{k=1}^{K_p} \left( G \left( \mathbf{r}^k \right) - L \left( \mathbf{r}^k \right) \right) \\
& = \sum_{k=1}^{K_p} D \left( \mathbf{r}^k \right).
\end{align} $$
```

Теперь можем перейти к доказательству основной теоремы:

```{admonition} Теорема
:class: danger
Пусть система находится в некотором *стационарном* состоянии с количеством вещества в фазах $\mathbf{n}^j, j = 1 \, \ldots \, N_p,$ причем значение энергии Гиббса для всех значений $\mathbf{r}^k$ (количеств вещества компонентов в фазах $k, \; k = 1 \, \ldots \, K_p$) больше или равно касательной плоскости $L \left( \mathbf{r}^k \right)$, иными словами $D \left( \mathbf{r}^k \right) \geq 0, \; k = 1 \, \ldots \, K_p,$ тогда данное стационарное состояние является ***равновесным***.
```

Докажем данную теорему.

```{admonition} Доказательство
:class: proof
Рассмотрим любое состояние системы с количеством вещества $\mathbf{r}^k, \; k = 1 \, \ldots \, K_p$. Тогда из условия $D \left( \mathbf{r}^k \right) \geq 0, \; k = 1 \, \ldots \, K_p,$ следует, что

$$ \sum_{k=1}^{K_p} D \left( \mathbf{r}^k \right) \geq 0. $$

Согласно доказанной ранее лемме, данное неравество можно записать следующим образом:

$$ \sum_{k=1}^{K_p} G \left( \mathbf{r}^k \right) - \sum_{j=1}^{N_p} G \left( \mathbf{n}^j \right) \geq 0. $$

Или:

$$ \sum_{j=1}^{N_p} G \left( \mathbf{n}^j \right) \leq \sum_{k=1}^{K_p} G \left( \mathbf{r}^k \right). $$

То есть для любых $\mathbf{r}^k, \; k = 1 \, \ldots \, K_p,$ энергия Гиббса системы получается больше, чем при $\mathbf{n}^j$, то есть состояние с $\mathbf{n}^j$ характеризуется наименьшей энергией Гиббса, следовательно, оно является равновесным по определению.
```

В результате доказательства этой теоремы данное ранее определение равновесного состояния, как состояния, характеризующегося наименьшей энергией Гиббса, можно переформулировать следующим образом:

```{admonition} Определение
:class: tip
***Равновесным состоянием*** называется такое *стационарное* состояние системы, при котором касательная гиперплоскость к гиперповерхности энергии Гиббса, проведенная в точке с компонентным составом этого состояния, не пересекает гиперповерхность энергии Гиббса в любых других точках.
```

Таким образом, анализ стабильности некоторого стационарного состояния многофазной многокомпонентной системы можно проводить посредством исследования функции $D \left( \mathbf{r}^k \right)$, определяемой расстоянием от гиперповерхности энергии Гиббса до касательной гиперплоскости, проведенной в точке с рассматриваемым стационарным состоянием. Эту функцию обычно называют *TPD – tangent plane distance*. Прежде чем переходить к рассмотрению примеров анализа стабильности необходимо необходимо отметить, что для квази-стационарного изотермического процесса [справедливо](../1-TD/TD-15-Fugacity.md) следующее преобразование:

$$ \sum_{j=1}^{N_p} G \left( \mathbf{n}^j \right) = \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} \mu_i^j n_i^j = R T \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_i^j \ln f_i^j. $$

Тогда *приведенная энергия Гиббса*:

$$ \sum_{j=1}^{N_p} \tilde{G} \left( \mathbf{n^j} \right) = \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_i^j \ln f_i^j. $$

Рассмотрим применение анализа стабильности с использованием функции *TPD* на следующих примерах.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $40 \; ^{\circ} C$ и давлении $2 \; МПа$ с мольной долей метана $0.85$. Необходимо определить, является ли однофазное состояние данной системы стабильным.
```

````{dropdown} Решение
Для решения данной задачи будем использовать [уравнение состояния Пенга-Робинсона](../2-EOS/EOS-2-SRK-PR.md), реализованное [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/eos.py).

Импортирурем необходимые библиотеки:

``` python
import numpy as np
from matplotlib import pyplot as plt
import sys
sys.path.append('../../_src/')
from eos import pr78
```

Зададим исходные термобарические условия и компонентный состав.

``` python
P = np.float64(2e6) # Pressure [Pa]
T = np.float64(40. + 273.15) # Temperature [K]
yi = np.array([.15, .85]) # Mole fractions [fr.]
```

Зададим свойства компонентов, необходимые для уравнения состояния Пенга-Робинсона.

``` python
Pci = np.array([7.37646, 4.600155]) * 1e6 # Critical pressures [Pa]
Tci = np.array([304.2, 190.6]) # Critical temperatures [K]
wi = np.array([.225, .008]) # Acentric factors
mwi = np.array([0.04401, 0.016043]) # Molar mass [kg/gmole]
vsi = np.array([0., 0.]) # Volume shift parameters
dij = np.array([.025]) # Binary interaction parameters
```

Импортируем класс с уравнением состояния и проинициализируем его.

``` python
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Выполним расчет приведенной энергии Гиббса для всех возможных компонентных составов рассматриваемой смеси. Для расчета коэффициентов летучестей компонентов для различных составов воспользуемся методом `get_lnphiji_Zj`, принимающего в качестве аргументов давление, температуру и набор компонентных составов в виде двумерного массива, и возвращающего соответствующие коэффициенты летучести компонентов в виде двумерного массива и коэффициенты сверхсжимаемости в виде одномерного массива. Затем вычислим летучести компонентов и энергии Гиббса для соответствующих компонентных составов.

``` python
yj1 = np.linspace(1e-4, 0.9999, 100, endpoint=True)
yji = np.vstack([yj1, 1. - yj1]).T
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, yji)
lnfji = lnphiji + np.log(P * yji)
Gj = np.vecdot(yji, lnfji)
```

Теперь вычислим летучести компонентов для заданного компонентного состава. Для этого воспользуемся методом `get_lnfi`, принимающего на вход давление, температуру и компонентный состав в виде одномерного масива, и возвращающего логарифмы летучести компонентов в виде одномерного массива. Затем выслим значения касательной к функции энергии Гиббса в точке с рассматриваемым компонентным составом.

``` python
lnfi = pr.getPT_lnfi(P, T, yi)
Lj = yji.dot(lnfi)
```

Построим зависимости энергии Гиббса и касательной к ней от количества вещества диоксида углерода в системе.

``` python
fig1, ax1 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax1.plot(yj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная энергия Гиббса')
ax1.plot(yj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax1.grid()
ax1.set_xlim(0., 1.)
ax1.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax1.set_ylabel('Приведенная энергия Гиббса')
ax1.legend(loc=3)
plt.show()
```

```{glue:} glued_fig1
```

<br>
<br>

Из представленного результата видно, что при рассматриваемых термобарических условиях касательная, проведенная в точке с заданным компонентным составом, не пересекает функцию энергии Гиббса, следовательно, можно сделать вывод о том, что однофазное состояние является стабильным. Более того, учитывая выпуклую вниз форму функции энергии Гиббса, можно заключить, что при любых компонентных составах данная система будет стабильна в однофазовом состоянии при рассматриваемых термобарических условиях.

Вычислим и построим зависимость функции TPD от количества вещества диоксида углерода в системе.

``` python
Dj = Gj - Lj
fig2, ax2 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax2.plot(yj1, Dj, lw=2., c='lime', zorder=2)
ax2.grid()
ax2.set_xlim(0., 1.)
ax2.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax2.set_ylabel('Tangent plane distance (TPD)')
plt.show()
```

```{glue:} glued_fig2
```

<br>
<br>

Функция TPD на всем интервале количества вещества диоксида углерода в системе не принимает отрицательных значений, что также свидетельствует об отсутствии пересечении касательной и функции энергии Гиббса, то есть о стабильности однофазного состояния рассматриваемой системы.

````

```{code-cell} python
:tags: [remove-cell]

import numpy as np
from matplotlib import pyplot as plt
import sys
sys.path.append('../../_src/')
from eos import pr78

P = np.float64(2e6) # Pressure [Pa]
T = np.float64(40. + 273.15) # Temperature [K]
yi = np.array([.15, .85]) # Mole fractions [fr.]

Pci = np.array([7.37646, 4.600155]) * 1e6 # Critical pressures [Pa]
Tci = np.array([304.2, 190.6]) # Critical temperatures [K]
wi = np.array([.225, .008]) # Acentric factors
mwi = np.array([0.04401, 0.016043]) # Molar mass [kg/gmole]
vsi = np.array([0., 0.]) # Volume shift parameters
dij = np.array([.025]) # Binary interaction parameters

pr = pr78(Pci, Tci, wi, mwi, vsi, dij)

yj1 = np.linspace(1e-4, 0.9999, 100, endpoint=True)
yji = np.vstack([yj1, 1. - yj1]).T
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, yji)
lnfji = lnphiji + np.log(P * yji)
Gj = np.vecdot(yji, lnfji)

lnfi = pr.getPT_lnfi(P, T, yi)
Lj = yji.dot(lnfi)

fig1, ax1 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax1.plot(yj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная энергия Гиббса')
ax1.plot(yj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax1.grid()
ax1.set_xlim(0., 1.)
ax1.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax1.set_ylabel('Приведенная энергия Гиббса')
ax1.legend(loc=3)

Dj = Gj - Lj
fig2, ax2 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax2.plot(yj1, Dj, lw=2., c='lime', zorder=2)
ax2.grid()
ax2.set_xlim(0., 1.)
ax2.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax2.set_ylabel('Tangent plane distance (TPD)')

from myst_nb import glue
glue('glued_fig1', fig1)
glue('glued_fig2', fig2)
```

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $10 \; ^{\circ} C$ и давлении $6 \; МПа$ с мольной долей метана $0.1$. Необходимо определить, является ли однофазное состояние данной системы стабильным.
```

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = np.float64(6e6) # Pressure [Pa]
T = np.float64(10. + 273.15) # Temperature [K]
yi = np.array([.9, .1]) # Mole fractions [fr.]
```

Выполним расчет приведенной энергии Гиббса для всех возможных компонентных составов рассматриваемой смеси. Затем определим летучести компонентов и энергии Гиббса для соответствующих компонентных составов.

``` python
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, yji)
lnfji = lnphiji + np.log(P * yji)
Gj = np.vecdot(yji, lnfji)
```

Теперь вычислим летучести компонентов для заданного компонентного состава. Затем определим значения касательной к функции энергии Гиббса в точке с рассматриваемым компонентным составом.

``` python
lnfi = pr.getPT_lnfi(P, T, yi)
Lj = yji.dot(lnfi)
```

Построим зависимости энергии Гиббса и касательной к ней от количества вещества диоксида углерода в системе.

``` python
fig3, ax3 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax3.plot(yj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная энергия Гиббса')
ax3.plot(yj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax3.grid()
ax3.set_xlim(0., 1.)
ax3.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax3.set_ylabel('Приведенная энергия Гиббса')
ax3.legend(loc=4)
plt.show()
```

```{glue:} glued_fig3
```

<br>
<br>

Поскольку видно, что касательная, проведенная к функции энергии Гиббса в точке с рассматриваемым компонентным составом пересекает функцию энергии Гиббса, то однофазное состояние данной системы нестабильно. Построим зависимость функции TPD.

``` python
Dj = Gj - Lj
fig4, ax4 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax4.plot(yj1, Dj, lw=2., c='lime', zorder=2)
ax4.grid()
ax4.set_xlim(0., 1.)
ax4.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax4.set_ylabel('Tangent plane distance (TPD)')
plt.show()
```

```{glue:} glued_fig4
```

<br>
<br>

Функция TPD имеет отрицательные значения, что свидетельствует о пересечении касательной и функции энергии Гиббса, то есть о нестабильности однофазного состояния рассматриваемой системы.

````

```{code-cell} python
:tags: [remove-cell]

P = np.float64(6e6) # Pressure [Pa]
T = np.float64(10. + 273.15) # Temperature [K]
yi = np.array([.9, .1]) # Mole fractions [fr.]

lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, yji)
lnfji = lnphiji + np.log(P * yji)
Gj = np.vecdot(yji, lnfji)

lnfi = pr.getPT_lnfi(P, T, yi)
Lj = yji.dot(lnfi)

fig3, ax3 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax3.plot(yj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная энергия Гиббса')
ax3.plot(yj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax3.grid()
ax3.set_xlim(0., 1.)
ax3.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax3.set_ylabel('Приведенная энергия Гиббса')
ax3.legend(loc=4)

Dj = Gj - Lj
fig4, ax4 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax4.plot(yj1, Dj, lw=2., c='lime', zorder=2)
ax4.grid()
ax4.set_xlim(0., 1.)
ax4.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax4.set_ylabel('Tangent plane distance (TPD)')

glue('glued_fig3', fig3)
glue('glued_fig4', fig4)
```

(pvt-sec-stability-pt-num)=
### Численный подход к проверке стабильности фазового состояния системы

Представленные выше примеры наглядно демонстрируют применение графического метода, основанного на пересечении гиперповерхности функции энергии Гиббса и касательной гиперплоскости, проведенной в точке с заданным компонентным составом. Однако применение графического метода не подходит для решения задач гидродинамического моделирования. В связи с этим в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] был впервые представлен численный подход к проведению анализа стабильности, суть которого заключается в следующем. Для того чтобы определить, является ли фазовое состояние некоторой системы стабильным, необходимо понять, имеет ли функция *TPD (tangent plane distance)* отрицательные значения.

```{admonition} NB
:class: note
Необходимым критерием стабильности рассматриваемого фазового состояния системы с количествами вещества компонентов $\mathbf{n}$ является:

$$ \begin{align}
D \left( \mathbf{r} \right)
&= G \left( \mathbf{r} \right) - \sum_{i=1}^{N_c} \mu_i \left( \mathbf{z} \right) r_i \\
&= \sum_{i=1}^{N_c} \mu_i \left( \mathbf{y} \right) r_i - \sum_{i=1}^{N_c} \mu_i \left( \mathbf{z} \right) r_i \\
&= \sum_{i=1}^{N_c} r_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) \geq 0, \; \forall \, \mathbf{r} \, : \, \sum_{i=1}^{N_c} r_i \leq \sum_{i=1}^{N_c} n_i, \; \mathbf{r} > 0,
\end{align} $$

где:
$\mathbf{r}$ – произвольный состав рассматриваемой системы, моль;
$\mathbf{y} = \mathbf{r} / \sum_{i=1}^{N_c} r_i$ – мольные доли компонентов для произвольного состава, д.ед.;
$\mathbf{\mu} \left( \mathbf{y} \right)$ – химические потенциалы компонентов для произвольного состава системы, Дж/моль.;
$\mathbf{z} = \mathbf{n} / \sum_{i=1}^{N_c} n_i$ – заданный компонентный состав системы, д.ед.;
$\mathbf{\mu} \left( \mathbf{z} \right)$ – химические потенциалы компонентов для заданного компонентного состава системы, Дж/моль.
```

````{margin}
```{admonition} Дополнительно
:class: note
Важно отметить, что рассматриваемый подход к проверке стабильности фазового состояния однофазной системы можно использовать и для проверки стабильности многофазной системы: для этого достаточно проверить на стабильность компонентный состав любой из фаз, применив данный метод.
<!--- TODO: При условии, если свойства фаз рассчитываются с использованием одного и того же уравнения состояния. -->
```
````

Естественно, нет необходимости проверять значение функции TPD для всех составов системы, достаточно проверить значение функции TPD в ее глобальном минимуме: если в этой точке функция TPD неотрицательна, то систему можно считать стабильной. Однако поиск глобального минимума является достаточно сложной задачей для не выпуклых вниз функций. В связи с этим в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено заменить поиск глобального минимума функции TPD на проверку ее значений в локальных минимумах (стационарных точках). Для этого, задаваясь некоторым начальным приближением, находится первый локальный минимум, и проверяется значение функции TPD в нем. Если это значение меньше нуля, то рассматриваемое фазовое состояние считается нестабильным, и проверка заканчивается. Если же это значение неотрицательно, то рассматривается следующее начальное приближение. Алгоритм повторяется, пока не будут рассмотрены все начальные приближения. Если после рассмотрения всех начальных приближений не было получено отрицательное значение функции TPD, то система считается стабильной. Прежде чем переходить к рассмотрению реализаций данного алгоритма, необходимо получить условие стационарности (выражение, определяющее положение стационарных точек) функции TPD.

Для этого в представленном выше критерии стабильности фазового состояния системы разделим левую и правую часть на $\sum_{i=1}^{N_c} r_i > 0$:

$$ D \left( \mathbf{y} \right) = \sum_{i=1}^{N_c} y_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) .$$

Положение стационарных точек функции определяется равенством нулю частных производных по независимым переменным. В качестве независимых переменных будут выступать мольные доли компонентов $y_j, \; j = 1 \, \ldots \, N_c - 1,$ поскольку:

$$ y_{N_c} = 1 - \sum_{i=1}^{N_c-1} y_i. $$

Запишем и преобразуем выражение для частных производных функции TPD:

$$ \begin{align}
\frac{\partial D}{\partial y_j}
&= \sum_{i=1}^{N_c} \frac{\partial y_i}{\partial y_j} \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) + \sum_{i=1}^{N_c} y_i \frac{\partial \mu_i \left( \mathbf{y} \right)}{\partial y_j} \\
&= \sum_{i=1}^{N_c} \frac{\partial y_i}{\partial y_j} \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) \\
&= \left( \mu_j \left( \mathbf{y} \right) - \mu_j \left( \mathbf{z} \right) \right) - \left( \mu_{N_c} \left( \mathbf{y} \right) - \mu_{N_c} \left( \mathbf{z} \right) \right) \\
&= 0, \; j = 1 \, \ldots \, N_c - 1.
\end{align} $$

В процессе этого преобразования было использовано [соотношение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md) при постоянных давлении и температуре:

$$ \sum_{i=1}^{N_c} y_i \frac{\partial \mu_i \left( \mathbf{y} \right)}{\partial y_j} = 0. $$

Кроме того, частная производная $\frac{\partial y_i}{\partial y_j}$ принимает следующие значения:

$$ \frac{\partial y_i}{\partial y_j} = \begin{cases} 1, & i=j, \, i = 1 \, \ldots \, N_c -1; \\ -1, & i=j, \, i = N_c; \\ 0, & i \neq j. \end{cases} $$

Следовательно,

$$ \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) = \mu_{N_c} \left( \mathbf{y} \right) - \mu_{N_c} \left( \mathbf{z} \right) = K, \; i = 1 \, \ldots \, N_c - 1. $$

В данном выражении разность химических потенциалов последнего компонента обозначена константой $K$, поскольку она не зависит от индекса $i$, то есть является одинаковой (постоянной) для всех компонентов. Иными словами, разность химических потенциалов одинакова для соответствующих компонентов в стационарных точках функции TPD. Из этого следует, что касательные, проведенные к функции энергии Гиббса в точках, соответствующих стационарным точкам функции TPD, будут параллельны друг другу и касательной, проведенной в точке с рассматриваемым компонентным составом. Докажем данное утверждение.

```{admonition} Доказательство
:class: proof
Из приведенного выше соотношения выразим значения химического потенциала в точке, соответствующей стационарной точке функции TPD:

$$ \mu_i \left( \mathbf{y} \right) = \mu_i \left( \mathbf{z} \right) + K. $$

Тогда, согласно представленной выше теореме, уравнение касательной к функции энергии Гиббса в этой точке с компонентным составом $\mathbf{y}$:

$$ L_y \left( \mathbf{x} \right) = \sum_{i=1}^{N_c} \mu_i \left( \mathbf{y} \right) x_i = \sum_{i=1}^{N_c} \mu_i \left( \mathbf{z} \right) x_i + K \sum_{i=1}^{N_c} x_i = L_z \left( \mathbf{x} \right) + K .$$

То есть значение касательной к функции энергии Гиббса, проведенной в точке, соответствующей стационарной точке функции TPD, отличается от касательной, проведенной в точке с рассматриваемым компонентным составом, на константу $K$, следовательно, они являются параллельными.
```

Рассмотрим значение функции TPD в стационарной точке:

$$ D \left( \mathbf{y} \right) = \sum_{i=1}^{N_c} y_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) = K. $$

Тогда условие стабильности рассматриваемой системы $D \left( \mathbf{y} \right) \geq 0$ можно представить в виде $K \geq 0$.

При этом условие стационарности функции TPD представляет собой систему нелинейных уравнений:

$$ \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) = K, \; i = 1 \, \ldots \, N_c. $$

Эта система имеет тривиальное решение $\mathbf{y} = \mathbf{z}$, в этом случае $K = 0$.

Для квази-стационарного изотермического процесса разность химических потенциалов [можно](../1-TD/TD-15-Fugacity.md#pvt-td-fugacity-realgasmixture) заменить разностью логарифмов летучестей компонентов. Следовательно, условие стационарности функции TPD записывается следующим образом:

$$ \begin{align}
RT \left( \ln f_i \left( \mathbf{y} \right) - \ln f_i \left( \mathbf{z} \right) \right) = K, \; i = 1 \, \ldots \, N_c, \\
\ln f_i \left( \mathbf{y} \right) - \ln f_i \left( \mathbf{z} \right) = \bar{K}, \; i = 1 \, \ldots \, N_c,
\end{align} $$

где $\bar{K} = K \, / \, RT$.

Преобразуем данное выражение с учетом [определения коэффициента летучести](../1-TD/TD-15-Fugacity.md):

$$ \ln y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = \bar{K}, \; i = 1 \, \ldots \, N_c. $$

Здесь под переменной $h_i$ обозначено следующее:

$$ h_i = \ln \phi_i \left( \mathbf{z} \right) + \ln z_i, \; i = 1 \, \ldots \, N_c. $$

С учетом изложенного выше функцию TPD преобразуем к следующему виду:

$$ \begin{align}
D \left( \mathbf{y} \right) &= \sum_{i=1}^{N_c} y_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right), \\
\bar{D} \left( \mathbf{y} \right) &= \sum_{i=1}^{N_c} y_i \left( \ln y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \right).
\end{align} $$

Пусть $Y_i = y_i \exp \left( -\bar{K} \right), \, i = 1 \, \ldots \, N_c,$ тогда условие стационарности функции TPD:

$$ \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = 0, \; i = 1 \, \ldots \, N_c. $$

При этом условие стабильности $\bar{K} \geq 0$ можно представить в виде $\sum_{i=1}^{N_c} Y_i \leq 1$, поскольку

$$ \sum_{i=1}^{N_c} Y_i = \sum_{i=1}^{N_c} y_i \mathrm{e}^{-\bar{K}} = \mathrm{e}^{-\bar{K}} \sum_{i=1}^{N_c} y_i = \mathrm{e}^{-\bar{K}}. $$

Логарифмируя левую и правую части, получим:

$$ \ln \sum_{i=1}^{N_c} Y_i = - \bar{K}. $$

С учетом $\bar{K} \geq 0$ можно записать следующее неравенство:

$$ \ln \sum_{i=1}^{N_c} Y_i \leq 0 \Leftrightarrow \sum_{i=1}^{N_c} Y_i \leq 1. $$

Стоит отметить, что значение $Y_i$ можно условно интерпретировать как количество вещества $i$-го компонента, действительно:

$$ \frac{Y_i}{\sum_{i=1}^{N_c} Y_i} = \frac{y_i \mathrm{e}^{-\bar{K}}}{\sum_{i=1}^{N_c} y_i \mathrm{e}^{-\bar{K}}} = \frac{y_i \mathrm{e}^{-\bar{K}}}{\mathrm{e}^{-\bar{K}} \sum_{i=1}^{N_c} y_i} = y_i. $$

Таким образом, система нелинейных уравнений, определяющая условие стационарности функции TPD, записывается следующим образом:

$$ g_i = \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = 0, \; i = 1 \, \ldots \, N_c. $$

После решения данной системы нелинейных уравнений относительно основных перменных $Y_i, \, i = 1 \, \ldots \, N_c,$ выполняется проверка стабильности рассматриваемой многокомпонентной системы. Фазовое состояние будет считаться стабильным, если:

$$ \sum_{i=1}^{N_c} Y_i \leq 1. $$

Рассмотрим некоторые численные алгоритмы решения данной системы нелинейных уравнений.

(pvt-sec-stability-pt-ss)=
### Метод последовательных подстановок

Одним из наиболее распространенных численных алгоритмов, среди применяемых к определению стабильности фазового состояния многокомпонентной системы, является *метод последовательных подстановок (successive substitution method)*, также называемый [методом простой итерации](https://en.wikipedia.org/wiki/Fixed-point_iteration), суть которого заключается в итерационном обновлении основных переменных с использованием следующего выражения:

$$ \mathbf{t}^{k+1} = f \left( \mathbf{t}^{k} \right), $$

где $\mathbf{t}^{k+1} \in {\rm I\!R}^n$ – вектор основных переменных на $\left( k+1 \right)$-й итерации, $\mathbf{t}^{k} \in {\rm I\!R}^n$ – вектор основных переменных на $\left( k \right)$-й итерации, $f \, : \, {\rm I\!R}^n \rightarrow {\rm I\!R}^n$ – функция, принимающая на вход вектор основных переменных размерности $n$ и возвращающая вектор размерности $n$, состоящий из значений нелинейных уравнений решаемой системы. Соответственно, такая система уравнений должна иметь решение, удовлетворяющее следующему соотношению:

$$ \mathbf{t}^{*} = f \left( \mathbf{t}^{*} \right), $$

где $\mathbf{t}^{*} \in {\rm I\!R}^n$ – вектор основных переменных, соответствующий решению системы нелинейных уравнений. Проверим, удовлетворяет ли рассматриваемая система нелинейных уравнений данному условию. Для этого преобразуем выражение, определяеющее положение стационарных точек функции TPD, следующим образом:

$$ \begin{align}
g_i
&= \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \\
&= \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right) - \ln z_i \\
&= \ln k_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right), \; i = 1 \, \ldots \, N_c.
\end{align} $$

В процессе данного преобразования было введено обозначение для вектора отношений количеств вещества компонентов $Y_i, \, i = 1 \, \ldots \, N_c,$ в произвольной фазе к соответствующим мольным долям в рассматриваемой системе $z_i, \, i = 1 \, \ldots \, N_c$:

$$ k_i = \frac{Y_i}{z_i}, \; i = 1 \, \ldots \, N_c. $$

Тогда рассматриваемую систему нелинейных уравнений можно преобразовать к следующему виду:

$$ \begin{align}
\ln k_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right) &= 0, \; i = 1 \, \ldots \, N_c, \\
\ln k_i &= \ln \phi_i \left( \mathbf{z} \right) - \ln \phi_i \left( \mathbf{y} \right), \; i = 1 \, \ldots \, N_c, \\
\ln k_i &= \ln k_i - \left( \ln k_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right) \right), \; i = 1 \, \ldots \, N_c, \\
\ln k_i &= \ln k_i - g_i, \; i = 1 \, \ldots \, N_c. \\
\end{align} $$

Таким образом, метод последовательных подстановок может быть использован для решения рассматриваемой системы нелинейных уравнений относительно основных переменных $k_i, \, i = 1 \, \ldots \, N_c$, обновление которых на некоторой итерации осуществляется с использованием следующего выражения:

$$ \begin{align}
\ln k_i^{k+1} &= \ln k_i^{k} - g_i^{k}, \; i = 1 \, \ldots \, N_c, \\
k_i^{k+1} &= k_i^{k} \cdot \exp \left(- g_i^{k} \right), \; i = 1 \, \ldots \, N_c.
\end{align} $$

С учетом вышеизложенного далее будет представлен алгоритм метода последовательных постановок для решения задачи проверки стабильности фазового состояния системы.

```{eval-rst}
.. role:: comment
    :class: comment
```

```{admonition} Алгоритм. Анализ стабильности с использованием метода SS
:class: algorithm

**Дано:** Вектор компонентного состава исследуемой системы $\mathbf{z} \in {\rm I\!R}^{N_c}$; термобарические условия $P$ и $T$; необходимые свойства компонентов для нахождения коэффициентов летучести компонентов с использованием уравнения состояния; максимальное число итераций $N_{iter}$; точность решения системы нелинейных уравнений $\epsilon_1$; численная погрешность расчета $0 < \epsilon_2 \leq 10^{-4}$.

**Определить:** Является ли однофазное состояние системы с компонентным составом $\mathbf{z}$ при давлении $P$ и температуре $T$ стабильным.

**Псевдокод:**  
**def** $\phi \left( \mathbf{y} \in {\rm I\!R}^{N_c}, \, \ldots \right) \rightarrow \boldsymbol{\varphi} \in {\rm I\!R}^{N_c}$ {comment}`# Функция для расчета вектора коэффициентов летучести`  
$\mathbf{K} := \left\{ \mathbf{k}_0, \, \mathbf{k}_1, \, \ldots, \, \mathbf{k}_N \right\}$ {comment}`# Инициализация набора (матрицы) начальных приближений`  
$\mathbf{h} := \ln \phi \left( \mathbf{z} \right) + \ln \mathbf{z}$  {comment}`# Расчет коэффициентов летучести для начального состава`  
**for** $i := 1$ **to** $N$ **do** {comment}`# Цикл перебора начальных приближений`  
&emsp;$\mathbf{k} := \mathbf{K}\left[ i \right]$ {comment}`# Вектор основных переменных`  
&emsp;$\mathbf{Y} := \mathbf{k} \cdot \mathbf{z}$  
&emsp;$\mathbf{y} := \mathbf{Y} \, / \, \sum_{i=1}^{N_c} Y_i$  
&emsp;$\mathbf{g} := \ln \mathbf{Y} + \ln \phi \left( \mathbf{y} \right) - \mathbf{h}$ {comment}`# Вектор невязок`  
&emsp;$c := 1$ {comment}`# Счетчик итераций решения системы нелинейных уравнений`  
&emsp;**while** $\lVert \mathbf{g} \rVert_2 > \epsilon_1$ **and** $c < N_{iter}$ **do** {comment}`# Цикл решения системы нелинейных уравнений`  
&emsp;&emsp;$\mathbf{k} := \mathbf{k} \cdot \exp \left( - \mathbf{g} \right)$ {comment}`# Расчет новых значений вектора основных переменных`  
&emsp;&emsp;$\mathbf{Y} := \mathbf{k} \cdot \mathbf{z}$  
&emsp;&emsp;$\mathbf{y} := \mathbf{Y} \, / \, \sum_{i=1}^{N_c} Y_i$  
&emsp;&emsp;$\mathbf{g} := \ln \mathbf{Y} + \ln \phi \left( \mathbf{y} \right) - \mathbf{h}$ {comment}`# Новые значения вектора невязок`  
&emsp;&emsp;$c := c + 1$ {comment}`# Обновление счетчика итераций`  
&emsp;**end while**  
&emsp;$TPD := - \ln \sum_{i=1}^{N_c} Y_i$ {comment}`# Расчет значения функции TPD`  
&emsp;**if** $TPD < -\epsilon_2$ **and** $c < N_{iter}$ **then** {comment}`# Проверка условия стабильности`  
&emsp;&emsp;$is\_stable := \mathrm{False}$  
&emsp;&emsp;**exit for** {comment}`# Выход из цикла перебора начальных приближений`  
&emsp;**else**  
&emsp;&emsp;**continue**  
&emsp;**end if**  
**else**  
&emsp;$is\_stable := \mathrm{True}$  
**end for**  
```

(pvt-sec-stability-pt-ss-init)=
#### Начальные приближения

Итак, рассматриваемая задача анализа стабильности фазового состояния системы заключается в проверке значений функции TPD в ее стационарных точках. Как уже было отмечено ранее, для нахождения различных стационарных точек необходимо задаться множеством начальных приближений. В связи с этим очевидным недостатком данного подхода является конечность набора начальных приближений (и с точки зрения времени счета – их количество, ведь чем больше начальных приближений мы рассмотрим, тем с большей вероятностью найдем глобальный минимум функции TPD, однако это приведет к увеличению времени работы алгоритма). Таким образом, корректный выбор начальных приближений является одним из залогов успешного решения задачи определения стабильности фазового состояния системы.

В работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать корреляцию Уилсона для генерации начальных приближений углеводородной системы:

$$ k_i^{go} = \frac{{P_c}_i}{P} \cdot \exp \left( 5.3727 \left(1 + \omega_i \right) \left(1 - \frac{{T_c}_i}{T} \right) \right), \; i = 1 \, \ldots \, N_c. $$

То есть в качестве начальных приближений $k_i$ в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] применялся набор из следующих векторов:

$$ k_i = \left\{ k_i^{go}, \; \frac{1}{k_i^{go}} \right\}, \; i = 1 \, \ldots \, N_c. $$

Использование этих двух начальных приближений зачастую бывает достаточным для проверки стабильности фазового равновесия, если заранее известно, что в системе могут быть только жидкая и газовая углероводородные фазы. Впоследствии, в работе \[[Li and Firoozabadi, 2012](https://doi.org/10.2118/129844-PA)\] было предложено дополнить данный набор следующими начальными приближениями:

$$ k_i = \left\{ k_i^{go}, \; \frac{1}{k_i^{go}}, \; \sqrt[3]{k_i^{go}}, \; \frac{1}{\sqrt[3]{k_i^{go}}}, \; k_i^{pure} \right\}, \; i = 1 \, \ldots \, N_c, $$

где:

$$ k_i^{pure} = \begin{cases} \left(1 - \epsilon \right) / z_i, & i = \mathrm{specific \, component}, \\ \left( \epsilon / \left( N_c - 1 \right) \right) / z_i, & i = \mathrm{others}. \end{cases} $$

Данный набор начальных приближений хорошо подходит для проверки стабильности систем, где мольная доля одного компонента много больше мольных долей других. Например, к таким системам относятся системы с водой в качестве компонента, в этом случае $\epsilon = 1\mathrm{e}-3$, согласно \[[Connolly et al, 2019](https://doi.org/10.1021/acs.iecr.9b00695)\] (для водных растворов иногда имеет смысл задать $\epsilon = 1\mathrm{e}-15$, согласно \[[Li and Li, 2019](https://doi.org/10.1016/j.fuel.2019.02.026)\]). Для систем с высоким содержанием диоксида углерода рекомендуется $\epsilon = 0.05$, согласно \[[Imai at al, 2019](https://doi.org/10.1016/j.fluid.2019.06.002)\].

(pvt-sec-stability-pt-ss-examples)=
#### Примеры

Рассмотрим реализацию данного алгоритма для приведенных выше примеров.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $40 \; ^{\circ} C$ и давлении $2 \; МПа$ с мольной долей метана $0.85$. Необходимо определить, является ли однофазное состояние данной системы стабильным, с использованием численного алгоритма.
```

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = np.float64(2e6) # Pressure [Pa]
T = np.float64(40. + 273.15) # Temperature [K]
yi = np.array([.15, .85]) # Mole fractions [fr.]
```

Также зададим максимальное число итераций $N_{iter}$, точность решения системы нелинейных уравнений $\epsilon_1$, численную погрешность расчета $\epsilon_2$:

``` python
Niter = 50 # Number of iterations
eps1 = np.float64(1e-6) # Tolerance
eps2 = np.float64(1e-4)
```

Рассчитаем матрицу начальных приближений $\mathbf{K}$. Для данного примера нам будет достаточно два приближения, рассчитанных по уравнению Уилсона:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Создадим функцию, которая будет принимать на вход кортеж из результатов предыдущей итерации, точность и максимальное число итераций, и возвращать необходимость расчета следующей итерации цикла решения системы нелинейных уравнений:

``` python
def condit_ss(carry, tol, Niter):
    k, ki, gi = carry
    return (k < Niter) & (np.linalg.norm(gi) > tol)
```

Также создадим функцию, которая будет принимать на вход результаты предыдущей итерации в виде кортежа, и рассчитывать результаты для новой итерации:

``` python
def update_ss(carry, hi, yi, plnphi):
    k, ki_k, gi_k = carry
    ki_kp1 = ki_k * np.exp(-gi_k)
    ni = ki_kp1 * yi
    gi_kp1 = np.log(ni) + plnphi(yi=ni/ni.sum()) - hi
    return k + 1, ki_kp1, gi_kp1
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Проинициализируем функции `condit` и `update`:

``` python
from functools import partial

pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tsolution: {ni}\n'
          f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out1
```

По результатам расчетов видно, что для обоих начальных приближений алгоритм сошелся на тривиальном решении, в котором значение TPD равно нулю. Таким образом, можно сделать вывод, что система стабильна.
````

```{code-cell} python
:tags: [remove-cell]

P = np.float64(2e6) # Pressure [Pa]
T = np.float64(40. + 273.15) # Temperature [K]
yi = np.array([.15, .85]) # Mole fractions [fr.]

Niter = 50 # Number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

def condit_ss(carry, tol, Niter):
    k, ki, gi = carry
    return (k < Niter) & (np.linalg.norm(gi) > tol)

def update_ss(carry, hi, yi, plnphi):
    k, ki_k, gi_k = carry
    ki_kp1 = ki_k * np.exp(-gi_k)
    ni = ki_kp1 * yi
    gi_kp1 = np.log(ni) + plnphi(yi=ni/ni.sum()) - hi
    return k + 1, ki_kp1, gi_kp1

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

from functools import partial

pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))

out1 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    out1 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tsolution: {ni}\n'
             f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

out1 += f'The system is stable: {is_stable}'

class MultilineText(object):
    def __init__(self, text):
        self.text = text
        self.template = """
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre id="codecell20" tabindex="0"><span></span>{}
</pre><button class="copybtn o-tooltip--left" data-tooltip="Copy" data-clipboard-target="#codecell20">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#000000" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <title>Copy to clipboard</title>
  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
  <rect x="8" y="8" width="12" height="12" rx="2"></rect>
  <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path>
</svg>
    </button></div>
</div>
"""

    def _repr_html_(self):
        return self.template.format(self.text.replace('\n', '<br>'))

glue('glued_out1', MultilineText(out1))

```

Рассмотрим применение данного алгоритма для следующего примера.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $10 \; ^{\circ} C$ и давлении $6 \; МПа$ с мольной долей метана $0.1$. Необходимо определить, является ли однофазное состояние данной системы стабильным, с использованием численного алгоритма.
```

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = np.float64(6e6) # Pressure [Pa]
T = np.float64(10. + 273.15) # Temperature [K]
yi = np.array([.9, .1]) # Mole fractions [fr.]
```

Рассчитаем матрицу начальных приближений $\mathbf{K}$:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Проинициализируем функции `condit` и `update`:

``` python
pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tsolution: {ni}\n'
          f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out2
```

Реализованный алгоритм проверки стабильности уже для первого начального приближения нашел решение системы нелинейных уравнений, характеризующееся отрицательным значением функции TPD, следовательно, однофазное состояние не является стабильным.
````

```{code-cell} python
:tags: [remove-cell]

P = np.float64(6e6) # Pressure [Pa]
T = np.float64(10. + 273.15) # Temperature [K]
yi = np.array([.9, .1]) # Mole fractions [fr.]

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))

out2 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    out2 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tsolution: {ni}\n'
             f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

out2 += f'The system is stable: {is_stable}'

glue('glued_out2', MultilineText(out2))

```

Важно отметить, что метод последовательных подстановок может характеризоваться малой скоростью сходимости, в особенности для термобарических условий вблизи границы двухфазной области. Проиллюстрируем данное свойство следующим примером.

<!-- TODO: добавить анализ сходимости метода SS. См. 10.1016/0378-3812(82)85001-2, 10.1021/ie00042a032, 10.1002/aic.690210314 -->

````{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси следующего мольного состава:

```{table}
:width: 100%
:widths: "1, 1, 1, 1, 1, 1"
| Компонент | $\mathrm{CH_4}$ | $\mathrm{C_2 H_6}$ | $\mathrm{C_3 H_8}$ | $\mathrm{n \mbox{-} C_4}$ | $\mathrm{C_{5+}}$ |
| :---: | :---: | :---: | :---: | :---: | :---: |
| Мольная доля | 0.7167 | 0.0895 | 0.0917 | 0.0448 | 0.0573 |
```

<br>

Необходимо определить является ли однофазное состояние стабильным при давлении $17 \; МПа$ и температуре $68 \; ^{\circ} C$.
````

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = np.float64(17e6) # Pressure [Pa]
T = np.float64(68. + 273.15) # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]
```

Зададим свойства компонентов, необходимые для уравнения состояния Пенга-Робинсона, и выполним инициализацию класса.

``` python
Pci = np.array([4.599, 4.872, 4.248, 3.796, 2.398]) * 1e6 # Critical pressures [Pa]
Tci = np.array([190.56, 305.32, 369.83, 425.12, 551.02]) # Critical temperatures [K]
wi = np.array([0.012, 0.100, 0.152, 0.200, 0.414]) # Acentric factors
mwi = np.array([0.016043, 0.03007, 0.044097, 0.058123, 0.120]) # Molar mass [kg/gmole]
vsi = np.array([-0.1595, -0.1134, -0.0863, -0.0675, 0.05661]) # Volume shift parameters
dij = np.array([
    0.002689,
    0.008537, 0.001662,
    0.014748, 0.004914, 0.000866,
    0.039265, 0.021924, 0.011676, 0.006228,
]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Рассчитаем матрицу начальных приближений $\mathbf{K}$:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Зададим максимальное число итераций $N_{iter}$, точность решения системы нелинейных уравнений $\epsilon_1$, численную погрешность расчета $\epsilon_2$. Для данного примера увеличим максимальное число итераций:

``` python
Niter = 100 # Number of iterations
eps1 = np.float64(1e-6) # Tolerance
eps2 = np.float64(1e-4)
```

Проинициализируем функции `condit` и `update`:

``` python
pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tsolution: {ni}\n'
          f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out3
```

По результатам расчетов метод последовательных подстановок для первого начального приближения сошелся к тривиальному решению за 186 итераций, а для следующего начального приближения нашел решение, характеризующееся отрицательным значением функции TPD, за 72 итерации. Таким образом, рассматриваемое однофазное состояние не является стабильным.
````

```{code-cell} python
:tags: [remove-cell]

P = np.float64(17e6) # Pressure [Pa]
T = np.float64(68. + 273.15) # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]

Pci = np.array([4.599, 4.872, 4.248, 3.796, 2.398]) * 1e6 # Critical pressures [Pa]
Tci = np.array([190.56, 305.32, 369.83, 425.12, 551.02]) # Critical temperatures [K]
wi = np.array([0.012, 0.100, 0.152, 0.200, 0.414]) # Acentric factors
mwi = np.array([0.016043, 0.03007, 0.044097, 0.058123, 0.120]) # Molar mass [kg/gmole]
vsi = np.array([-0.1595, -0.1134, -0.0863, -0.0675, 0.05661]) # Volume shift parameters
dij = np.array([
    0.002689,
    0.008537, 0.001662,
    0.014748, 0.004914, 0.000866,
    0.039265, 0.021924, 0.011676, 0.006228,
]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

Niter = 200 # Number of iterations
eps1 = np.float64(1e-6) # Tolerance
eps2 = np.float64(1e-4)

pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))

out3 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    out3 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tsolution: {ni}\n'
             f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

out3 += f'The system is stable: {is_stable}'

glue('glued_out3', MultilineText(out3))

```

<!-- TODO: показать на примере увеличение количества итераций метода последовательных подстановок вблизи критической точки -->

Существует также множество работ, посвященных разработке алгоритмов, направленных на оптимизацию метода последовательных подстановок. В работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать метод GDEM. В работах \[[Nghiem, 1983](https://doi.org/10.2118/12242-MS); [Nghiem and Li, 1984](https://doi.org/10.1016/0378-3812(84)80013-8)\] авторы рассмотрели различные подходы к оптимизации метода последовательных подстановок путем введения длины шага итерации и его расчета на основе результатов предыдущей итерации. Примеры реализации некоторых из алгоритмов представлены [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/stability.py).

(pvt-sec-stability-pt-newton)=
### Метод минимизации функции

К решению задачи определения стабильности некоторой системы можно подойти с точки зрения минимизации функции TPD:

$$ \bar{D} \left( \mathbf{y} \right) = \sum_{i=1}^{N_c} y_i \left( \ln y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \right). $$

Если использовать в качестве основных переменных мольные доли компонентов для произвольного состава $y_i, \, i = 1 \, \ldots \, N_c,$, то такая задача будет являться *задачей условной минимизации или задачей минимизации с ограничениями (constrained minimization)*. В качестве условий будут выступать следующие соотношения:

$$ \begin{align}
& y_i > 0, \; i = 1 \, \ldots \, N_c, \\
& \sum_{i=1}^{N_c} y_i = 1.
\end{align} $$

Решение задачи условной минимизации зачастую сложнее *безусловной (unconstrained minimization)*. В связи с этим имеет смысл исключить второе условие из рассмотрения путем замены основных переменных, например, на уже упомянутые ранее количества вещества компонентов в произвольной (мнимой) фазе:

$$ Y_i = y_i \mathrm{e}^{-\bar{K}}, \; i = 1 \, \ldots \, N_c. $$

В связи с изложенным выше при использовании $Y_i, \, i = 1 \, \ldots \, N_c,$ в качестве основных переменных положение стационарных точек функции TPD будет определяться следующей системой нелинейных уравнений:

$$ g_i = \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = 0, \; i = 1 \, \ldots \, N_c. $$

При этом в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать вместо функции TPD ее модификацию:

$$ \bar{D}^* \left( \mathbf{Y} \right) = 1 + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right). $$

Докажем, что замена функции $\bar{D} \left( \mathbf{y} \right)$ на модифицированную $\bar{D}^* \left( \mathbf{Y} \right)$ является допустимой для рассматриваемой задачи проверки стабильности фазового состояния.

````{margin}
```{admonition} Дополнительно
:class: note
Используя [уравнение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md) при постоянных (фиксированных) давлении и температуре, получим:

$$ \sum_{i=1}^{N_c} n_i d \mu_i = 0. $$

С учетом [соотношения](../1-TD/TD-15-Fugacity.md) между дифференциалом химического потенциала $i$-го компонента и дифференциалом логарифма его летучести данное равенство преобразуется следующим образом:

$$ \begin{align}
\sum_{i=1}^{N_c} n_i RT d \ln f_i = 0, \\
\sum_{i=1}^{N_c} n_i d \ln f_i = 0.
\end{align} $$

Разделив левую и правую части на $\partial n_j, \, j = 1 \, \ldots \, N_c,$, получим:

$$ \begin{align}
& \sum_{i=1}^{N_c} n_i \frac{\partial \ln f_i}{\partial n_j} = 0, \\
& j = 1 \, \ldots \, N_c.
\end{align} $$

Далее воспользуемся соотношением между частными производными логарифма летучести и логарифма коэффициента летучести, полученным [ранее](../2-EOS/EOS/Appendix-A-PD.md):

$$ \frac{\partial \ln f_i}{\partial n_j}  = \frac{\partial \ln \phi_i}{\partial n_j} + \frac{\delta_{ij}}{n_i} - \frac{1}{n}. $$

Подставив данное выражение в уравнение Гиббса-Дюгема и выполнив некоторые преобразования, получим:

$$ \begin{align}
& \sum_{i=1}^{N_c} n_i \frac{\partial \ln \phi_i}{\partial n_j} = 0, \\
& j = 1 \, \ldots \, N_c.
\end{align} $$

```
````

```{admonition} Доказательство
:class: proof
В рамках решения задачи стабильности многокомпонентной системы, сводимой к решению задачи поиска локальных минимумов функции TPD и проверки ее значений в них, замена функции TPD возможна при условии одинаковости положения (координат) стационарных точек и знака функции в них. Для проверки соответствия положения стационарных точек модифицированной функции TPD получим систему уравнений, характеризующую их координаты, которая определяется равенством нулю частных производных функции по основным переменным:

$$ \begin{align}
\frac{\partial \bar{D}^*}{\partial Y_j}
&= \frac{\partial}{\partial Y_j} \left( 1 + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) \right) \\
&= \sum_{i=1}^{N_c} \frac{\partial Y_i}{\partial Y_j} \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) + \sum_{i=1}^{N_c} Y_i \left( \frac{\partial \ln Y_i}{\partial Y_j} + \frac{\partial \ln \phi_i \left( \mathbf{y} \right)}{\partial Y_j} \right) \\
&= \sum_{i=1}^{N_c} \delta_{ij} \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) + \sum_{i=1}^{N_c} Y_i \left( \frac{1}{Y_i} \delta_{ij} + \frac{\partial \ln \phi_i \left( \mathbf{y} \right)}{\partial Y_j} \right) \\
&= \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j - 1 + \sum_{i=1}^{N_c} \delta_{ij} + \sum_{i=1}^{N_c} Y_i \frac{\partial \ln \phi_i \left( \mathbf{y} \right)}{\partial Y_j} \\
&= \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j, \; j = 1 \, \ldots \, N_c.
\end{align} $$

При выводе данного выражения использовалось [уравнение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md).

Таким образом, положение стационарных точек исходной и модифицированной функций TPD определяется одной и той же системой нелинейных уравнений. Получим выражение для модифицированной функции TPD в стационарных точках, в которых значения частных производных функции по основным переменным равны нулю:

$$ \begin{align}
\bar{D}^*_{sp}
&= 1 + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) \\
&= 1 - \sum_{i=1}^{N_c} Y_i + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \right) \\
&= 1 - \sum_{i=1}^{N_c} Y_i \\
&= 1 - \exp \left( -\bar{K} \right) \\
&= 1 - \exp \left( -\bar{D}_{sp} \right).
\end{align} $$

Таким образом, при $\bar{D}_{sp} \geq 0$ значения модифицированной функции TPD в стационарных точках также $D^*_{sp} \geq 0$. Если же $\bar{D}_{sp} < 0$, то и $D^*_{sp} < 0$. То есть модифицированная функция TPD имеет идентичные положения стационарных точек, как и исходная функция TPD, а также сохраняет знак в этих точках. Следовательно, в рамках задачи определения стабильности многокомпонентной системы замена функции TPD $\bar{D} \left( \mathbf{Y} \right)$ на модифицированную $\bar{D}^* \left( \mathbf{Y} \right)$ допустима.
```

Задачу минимизации функции TPD можно решать, используя метод Ньютона, являющийся алгоритмом второго порядка, то есть характеризующийся более быстрой сходимостью, по сравнению с рассмотренным ранее методом последовательных подстановок, относящимся к алгоритмам первого порядка. Для использования метода Ньютона необходимо получить аналитические выражения для вторых частных производных модифицированной функции TPD по основным переменным, формирующих матрицу гессиана $\mathbf{H} \in {\rm I\!R}^{N_c \times N_c}$:

$$ \begin{align}
H_{ij}
&= \frac{\partial^2 \bar{D}^*}{\partial Y_i \partial Y_j} \\
&= \frac{\partial}{\partial Y_j} \left( \frac{\partial \bar{D}^*}{\partial Y_i} \right) \\
&= \frac{\partial}{\partial Y_j} \left( \ln Y_i + \ln \phi_i - h_i \right) \\
&= \frac{\delta_{ij}}{Y_i} + \frac{\partial \ln \phi_i}{\partial Y_j}, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_c.
\end{align} $$

Аналитические выражения частных производных логарифма коэффициента летучести с использованием уравнений состояния были получены [ранее](../2-EOS/EOS/Appendix-A-PD.md).

При этом задача минимизации модифицированной функции $\bar{D}^* \left( \mathbf{Y} \right)$ по-прежнему является условной, поскольку должны рассматриваться значения вектора $\mathbf{Y}$ имеющие физический смысл, то есть $Y_i > 0, \, i = 1 \, \ldots \, N_c$. Для исключения данного условия автором работы \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено ввести следующую замену основных переменных:

$$ \alpha_i = 2 \sqrt{Y_i}, \; i = 1 \, \ldots \, N_c. $$

В этом случае значения вектора $\mathbf{Y}$ всегда будут неотрицательными, поскольку $Y_i = \alpha_i^2 \, / \, 4, \, i = 1 \, \ldots \, N_c$. При использовании $\alpha_i, \, i = 1 \, \ldots \, N_c,$ в качестве основных переменных положения стационарных точек модифицированной функции TPD будут определяться равенством нулю частных производных функции по основным переменным:

$$ \begin{align}
\frac{\partial \bar{D}^*}{\partial \alpha_j}
&= \frac{\partial \bar{D}^*}{\partial Y_j} \frac{\partial Y_j}{\partial \alpha_j} \\
&= \left( \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j \right) \frac{\partial}{\partial \alpha_j} \left( \frac{\alpha_j^2}{4} \right) \\
&= \left( \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j \right) \frac{\alpha_j}{2} \\
&= \sqrt{Y_j} \left( \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j \right), \; j = 1 \, \ldots \, N_c.
\end{align} $$

При этом изменится и аналитическое выражение элемента матрицы гессиана при использовании $\alpha_i, \, i = 1 \, \ldots \, N_c,$ в качестве основных переменных:

$$ \begin{align}
\frac{\partial^2 \bar{D}^*}{\partial \alpha_j \partial \alpha_k}
&= \frac{\partial \bar{D}^*}{\partial \alpha_k} \left( \frac{\partial \bar{D}^*}{\partial \alpha_j} \right) \\
&= \frac{\partial \bar{D}^*}{\partial \alpha_k} \left( \sqrt{Y_j} \left( \ln Y_j + \ln \phi_j - h_j \right) \right) \\
&= \left( \ln Y_j + \ln \phi_j - h_j \right) \frac{\partial \sqrt{Y_j}}{\partial \alpha_k} + \sqrt{Y_j} \frac{\partial}{\partial \alpha_k} \left( \ln Y_j + \ln \phi_j - h_j \right) \\
&= \left( \ln Y_j + \ln \phi_j - h_j \right) \frac{1}{2 Y_j} \frac{\partial Y_j}{\alpha_k} + \sqrt{Y_j} \frac{\partial}{\partial Y_k} \left( \ln Y_j + \ln \phi_j - h_j \right) \frac{\partial Y_k}{\partial \alpha_k} \\
&= \frac{1}{2} \delta_{jk} \left( \ln Y_j + \ln \phi_j - h_j \right) + \sqrt{Y_j} \left( \frac{\delta_{jk}}{Y_j} + \frac{\partial \ln \phi_j}{\partial Y_k} \right) \\
&= \frac{1}{2} \delta_{jk} \left( \ln Y_j + \ln \phi_j - h_j \right) + \frac{\sqrt{Y_j Y_k} \delta_{jk}}{Y_j} + \sqrt{Y_j Y_k} \frac{\partial \ln \phi_j}{\partial Y_k} \\
&= \frac{1}{2} \delta_{jk} \left( \ln Y_j + \ln \phi_j - h_j \right) + \delta_{jk} + \sqrt{Y_j Y_k} \frac{\partial \ln \phi_j}{\partial Y_k}, \; j = 1 \, \ldots \, N_c, \; k = 1 \, \ldots \, N_c.
\end{align} $$

В процессе получения данного выражения было использовано следующее соотношение: $\sqrt{Y_j Y_k} \delta_{jk} = Y_j \delta_{jk}, \, j = 1 \, \ldots \, N_c, \, k = 1 \, \ldots \, N_c$. То есть в результате поэлементного произведения некоторой матрицы с единичной матрицей получится диагональная матрица с элементами, соответствующими главной диагонали умножаемой матрицы.

При использовании метода Ньютона для решения задачи оптимизации обновление основных переменных $\alpha_i, \, i = 1 \, \ldots \, N_c,$ на $\left( k+1 \right)$-й итерации осуществляется с использованием следующего выражения:

$$ \boldsymbol{\alpha}^{k+1} = \boldsymbol{\alpha}^{k} + \Delta \boldsymbol{\alpha}^{k}, $$

где вектор $\Delta \boldsymbol{\alpha}^{k} \in {\rm I\!R}^{N_c}$ определяется при решении системы линейных уравнений:

$$ \mathbf{H}^{k} \Delta \boldsymbol{\alpha}^{k} = - \mathbf{g}^{k}. $$

Таким образом, алгоритм определения стабильности фазового состояния с использованием метода Ньютона можно представить следующим образом:

```{eval-rst}
.. role:: multilinecomment
    :class: multilinecomment
```

```{admonition} Алгоритм. Анализ стабильности с использованием метода Ньютона
:class: algorithm

**Дано:** Вектор компонентного состава исследуемой системы $\mathbf{z} \in {\rm I\!R}^{N_c}$; термобарические условия $P$ и $T$; необходимые свойства компонентов для нахождения коэффициентов летучести компонентов с использованием уравнения состояния; максимальное число итераций $N_{iter}$; точность решения системы нелинейных уравнений $\epsilon_1$; численная погрешность расчета $0 < \epsilon_2 \leq 10^{-4}$.

**Определить:** Является ли однофазное состояние системы с компонентным составом $\mathbf{z}$ при давлении $P$ и температуре $T$ стабильным.

**Псевдокод:**  
**def** $\phi \left( \mathbf{y} \in {\rm I\!R}^{N_c}, \, \ldots \right) \rightarrow \boldsymbol{\varphi} \in {\rm I\!R}^{N_c}, \, \mathbf{\Phi} \in {\rm I\!R}^{N_c \times N_c}$ {multilinecomment}`# Функция, возвращающая вектор коэффициентов летучести и матрицу их частных производных по количеству вещества компонентов`  
$\mathbf{K} := \left\{ \mathbf{k}_0, \, \mathbf{k}_1, \, \ldots, \, \mathbf{k}_N \right\}$  
$\mathbf{h} := \ln \phi \left( \mathbf{z} \right) + \ln \mathbf{z}$   
**for** $i := 1$ **to** $N$ **do**  
&emsp;$\mathbf{k} := \mathbf{K}\left[ i \right]$  
&emsp;$\mathbf{n} := \mathbf{k} \cdot \mathbf{z}$  
&emsp;$\boldsymbol{\alpha} := 2 \sqrt{\mathbf{n}}$ {comment}`# Вектор основных переменных`  
&emsp;$\mathbf{y} := \mathbf{n} \, / \, \sum_{i=1}^{N_c} n_i$  
&emsp;$\boldsymbol{\varphi}, \, \mathbf{\Phi} := \phi \left( \mathbf{y} \right)$ {comment}`# Расчет вектора коэффициентов летучести и матрицы их частных производных`  
&emsp;$\mathbf{g} := \sqrt{\mathbf{n}} \cdot \left(\ln \mathbf{n} + \ln \boldsymbol{\varphi} - \mathbf{h} \right)$ {comment}`# Вектор невязок`  
&emsp;$c := 1$  
&emsp;**while** $\lVert \mathbf{g} \rVert_2 > \epsilon_1$ **and** $c < N_{iter}$ **do**  
&emsp;&emsp;$\mathbf{H} := \mathrm{diag} \left( {\frac{1}{2} \mathbf{g} }\right) + \mathbf{I} + \sqrt{\mathbf{n} \mathbf{n}^\top} \cdot \mathbf{\Phi}$ {comment}`# Гессиан`  
&emsp;&emsp;$\Delta \boldsymbol{\alpha} := -\mathbf{H}^{-1} \mathbf{g}$ {comment}`# Вектор изменения основных переменных`  
&emsp;&emsp;$\boldsymbol{\alpha} := \boldsymbol{\alpha} + \Delta \boldsymbol{\alpha}$ {comment}`# Обновление вектора основных переменных`  
&emsp;&emsp;$\mathbf{n} := \boldsymbol{\alpha} \cdot \boldsymbol{\alpha} \, / \, 4$  
&emsp;&emsp;$\mathbf{y} := \mathbf{n} \, / \, \sum_{i=1}^{N_c} n_i$  
&emsp;&emsp;$\boldsymbol{\varphi}, \, \mathbf{\Phi} := \phi \left( \mathbf{y} \right)$ {comment}`# Вектор коэффициентов летучести и матрица их частных производных`  
&emsp;&emsp;$\mathbf{g} := \sqrt{\mathbf{n}} \cdot \left(\ln \mathbf{n} + \ln \boldsymbol{\varphi} - \mathbf{h} \right)$ {comment}`# Вектор невязок`  
&emsp;&emsp;$c := c + 1$  
&emsp;**end while**  
&emsp;$TPD := - \ln \sum_{i=1}^{N_c} n_i$  
&emsp;**if** $TPD < -\epsilon_2$ **and** $c < N_{iter}$ **then**  
&emsp;&emsp;$is\_stable := \mathrm{False}$  
&emsp;&emsp;**exit for**  
&emsp;**else**  
&emsp;&emsp;**continue**  
&emsp;**end if**  
**else**  
&emsp;$is\_stable := \mathrm{True}$  
**end for**  
```

(pvt-sec-stability-pt-newton-init)=
#### Начальные приближения

Начальные значения вектора $\alpha_i, \, i = 1 \, \ldots \, N_c,$ при использовании метода Ньютона для минимизации функции TPD могут быть получены аналогично способу, рассмотренному [ранее](pvt-sec-stability-pt-ss-init) для метода последовательных подстановок. Однако поскольку метод Ньютона является алгоритмом второго порядка, то [обычно является менее стабильным](https://en.wikipedia.org/wiki/Fixed-point_iteration#Iterative_methods) по сравнению с алгоритмами первого порядка для не полностью выпуклых функций. В связи с этим начальные приближения вектора основных переменных для метода Ньютона, рассчитанные с использованием корреляции Уилсона или другим способом, могут быть уточнены в ходе нескольких итераций метода последовательных подстановок. При этом, например, в работе \[[Hoteit and Firoozabadi, 2006](https://doi.org/10.1002/aic.10908)\] количество итераций метода последовательных подстановок перед переключением на метод Ньютона для анализа стабильности определялось следующим условием:

$$ \lVert \mathbf{g} \rVert_2 > \epsilon_{ssi}, $$

где $\lVert \mathbf{g} \rVert_2$ – длина вектора невязки, а $\epsilon_{ssi} = 10^{-2}$.

(pvt-sec-stability-pt-newton-examples)=
#### Примеры

Рассмотрим применение метода Ньютона для определения стабильности однофазного состояния следующей системы:

````{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси следующего мольного состава:

```{table}
:width: 100%
:widths: "1, 1, 1, 1, 1, 1"
| Компонент | $\mathrm{CH_4}$ | $\mathrm{C_2 H_6}$ | $\mathrm{C_3 H_8}$ | $\mathrm{n \mbox{-} C_4}$ | $\mathrm{C_{5+}}$ |
| :---: | :---: | :---: | :---: | :---: | :---: |
| Мольная доля | 0.7167 | 0.0895 | 0.0917 | 0.0448 | 0.0573 |
```

<br>

Необходимо определить является ли однофазное состояние стабильным при давлении $17 \; МПа$ и температуре $68 \; ^{\circ} C$.
````

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = np.float64(17e6) # Pressure [Pa]
T = np.float64(68. + 273.15) # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]
```

Зададим свойства компонентов, необходимые для уравнения состояния Пенга-Робинсона, и выполним инициализацию класса.

``` python
Pci = np.array([4.599, 4.872, 4.248, 3.796, 2.398]) * 1e6 # Critical pressures [Pa]
Tci = np.array([190.56, 305.32, 369.83, 425.12, 551.02]) # Critical temperatures [K]
wi = np.array([0.012, 0.100, 0.152, 0.200, 0.414]) # Acentric factors
mwi = np.array([0.016043, 0.03007, 0.044097, 0.058123, 0.120]) # Molar mass [kg/gmole]
vsi = np.array([-0.1595, -0.1134, -0.0863, -0.0675, 0.05661]) # Volume shift parameters
dij = np.array([
    0.002689,
    0.008537, 0.001662,
    0.014748, 0.004914, 0.000866,
    0.039265, 0.021924, 0.011676, 0.006228,
]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Начальные приближения рассчитаем по корреляции Уилсона:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Зададим максимальное число итераций $N_{iter}$, точность решения системы нелинейных уравнений $\epsilon_1$, численную погрешность расчета $\epsilon_2$:

``` python
Niter = 100 # Number of iterations
eps1 = np.float64(1e-6) # Tolerance
eps2 = np.float64(1e-4)
```

Проинициализируем функции `condit` и `update`:

``` python
pcondit = partial(condit_ss, tol=eps1, Niter=Niter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (1, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {np.linalg.norm(gi)}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tsolution: {ni}\n'
          f'\tTPD: {TPD}\n')
    if (TPD < -eps2) & (c < Niter):
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out3
```

По результатам расчетов метод последовательных подстановок для первого начального приближения сошелся к тривиальному решению за 186 итераций, а для следующего начального приближения нашел решение, характеризующееся отрицательным значением функции TPD, за 72 итерации. Таким образом, рассматриваемое однофазное состояние не является стабильным.
````


В работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать метод BFGS. Впоследствии применение метода BFGS для решение задачи стабильности получило свое развитие в работах \[[Hoteit and Firoozabadi, 2006](https://doi.org/10.1002/aic.10908); [Nichita and Petitfrere, 2015](https://doi.org/10.1016/j.fluid.2015.07.035)\].

Таким образом, в этом подразделе был выведен критерий стабильности для PT-термодинамики, а также рассмотрены некоторые численные алгоритмы проверки стабильности фазового состояния. [Следующие разделы](SEC-2-RR.md) будут посвящены изучению уравнения Речфорда-Райса (уравнения фазовых концентраций).

(pvt-sec-stability-vt)=
## VT-термодинамика
