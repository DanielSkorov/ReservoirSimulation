---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 3.0.1
    jupytext_version: 1.16.3
kernelspec:
  display_name: Python 3 (ipykernel)
  language: python
  name: python3
---

(pvt-sec-stability)=
# Определение стабильности фазового состояния системы

В данном разделе будут представлены критерии стабильности фазового состояния системы, позволяющие определить, является ли рассматриваемое фазовое состояние системы стабильным для различных формулировок ([PT-термодинамика](#pvt-sec-stability-pt) и [VT-термодинамика](pvt-sec-stability-vt)), а также численные алгоритмы и их реализации. Выбор той или иной формулировки зачастую определяется теми переменными, через которые удобнее выражать уравнение состояния, а также моделируемым процессом. Проверка стабильности фазового равновесия является первым из двух последовательных шагов к определению равновесного фазового состояния системы.

(pvt-sec-stability-pt)=
## PT-термодинамика

(pvt-sec-stability-pt-theory)=
### Теоретические основы анализа стабильности фазового состояния системы

Пусть некоторая многокомпонентная макроскопическая система находится в равновесном состоянии и характеризуется давлением $P$, температурой $T$ и количеством вещества всех компонентов $n_i, \, i = 1 \, \ldots \, N_c,$ где $N_c$ – число компонентов, составляющих рассматриваемую систему. Можем ли мы использовать некоторое уравнение состояния для описания взаимосвязей между термодинамическими параметрами? Ответ на этот вопрос зависит от того, является ли рассматриваемая система гомогенной, то есть состоящей из одной сплошной фазы. Иными словами, является ли однофазное состояние рассматриваемой системы *стабильным*. Именно исследованию данного вопроса будет посвящен настоящий раздел. Однако, прежде чем переходить к рассмотрению темы стабильности фазового состояния системы, необходимо ввести ряд определений. Некоторые из них будут перекликаться с рассмотренными ранее темами, но при этом являться более обобщенными. Теоретическое изложение рассматриваемой проблемы соответствует работе \[[Baker et al, 1982](https://doi.org/10.2118/9806-PA)\].

````{margin}
```{admonition} Дополнительно
:class: note
При использовании двойного индексирования здесь и далее первый индекс будет обозначать фазу, второй – компонент. То есть под $n_{ji}$ следует понимать количество вещества $i$-го компонента в $j$-й фазе, а под, например, $\mu_{N_pk}$ – химический потенциал $k$-го компонента в $N_p$-й фазе. При использовании одинарного индексирования будет явно указано отношение данного элемента к вектору, характеризующему свойства фаз или компонентов.
```
````

```{admonition} Определение
:class: tip
Пусть имеется некоторая $j$-ая фаза многофазной системы, состоящая из $N_c$ компонентов, при этом количество вещества компонентов в фазе $j$ определяется следующим [вектором](../../0-Math/0-LAB/LAB-1-Vectors.md):

$$ \mathbf{n}_j = \begin{bmatrix} n_{j1} \\ n_{j2} \\ \vdots \\ n_{jN_c} \end{bmatrix}, \; j = 1 \, \ldots \, N_p. $$

Если количество вещества компонентов в системе в целом определяется вектором

$$ \mathbf{n} = \begin{bmatrix} n_1 \\ n_2 \\ \vdots \\ n_{N_c} \end{bmatrix}, $$

то фаза $j$ является ***допустимой*** *(admissible)*, если

$$ 0 < n_{ji} < n_i, \; j = 1 \, \ldots \, N_p, \; i = 1 \, \ldots \, N_c. $$
```

Иными словами, фаза является *допустимой*, если количество вещества каждого компонента, в нее входящего, меньше количества вещества этого же компонента в системе в целом. Все дальнейшие выкладки будут касаться допустимых фаз, в которых представлены все компоненты, не взаимодействующие друг с другом с образованием новых компонентов, то есть не вступающие в реакции. Для допустимых фаз справедливо следущее соотношение:

$$ \sum_{j=1}^{N_p} n_{ji} = n_i, \; i = 1 \, \ldots \, N_c, $$

где $N_p$ – количество фаз в системе, а $N_c$ – число компонентов. При известных и заданных давлении и температуре рассматриваемой системы, а также количествах вещества компонентов в ней [энергия Гиббса](../1-TD/TD-10-MixtureGibbsEnergy.md) некоторой фазы определяется количеством вещества каждого компонента в фазе, то есть:

$$ G_j = G_j \left( \mathbf{n}_j \right), \; j = 1 \, \ldots \, N_p. $$

Учитывая [экстенсивность](../1-TD/TD-9-Observables.md#pvt-td-observables-extensive) энергии Гиббса, для многофазной системы справедливо следующее соотношение:

$$ G \left( \mathbf{n} \right) = G \left( \mathbf{n}_1, \, \mathbf{n}_2, \, \ldots, \, \mathbf{n}_{N_p} \right) = \sum_{j=1}^{N_p} G_j \left( \mathbf{n}_j \right). $$

Здесь и далее вместо перечисления векторов количеств вещества компонентов в фазах, соответствующих некоторому состоянию, будем использовать обозначение $G \left( \mathbf{n}_1, \, \mathbf{n}_2, \, \ldots, \, \mathbf{n}_{N_p} \right) \equiv G \left( \hat{M} \right)$.

```{admonition} Определение
:class: tip
Некоторое $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$ состояние системы, характеризующееся $N_p$ количеством *допустимых* фаз, удовлетворяющих закону сохранения масс, является ***равновесным***, если:

$$ G \left( \hat{M} \right) = \min_{\hat{K}} G \left( \hat{K} \right), $$

где минимум берется по всем состояниям $\hat{K} = \left\{ \mathbf{r}_k, \, k = 1 \, \ldots \, K_p \right\}$, характеризующимся $K_p$ количеством *допустимых* фаз, удовлетворяющих закону сохранения масс.
```

В данном определении необходимо отметить два момента. Первый: *равновесное состояние* характеризуется минимумом энергии Гиббса всей многофазной системы. Более подробно это рассматривалось [ранее](../1-TD/TD-14-PhaseEquilibrium.md). Второй: для того чтобы доказать, что некоторое состояние $\hat{M}$ многофазной системы из $N_p$ фаз является *равновесным*, мы можем рассмотреть множество других состояний $\hat{K}$, каждое из которых будет характеризоваться своим числом фаз $K_p$, и если в состоянии $\hat{M}$ с количеством фаз $N_p$ энергия Гиббса меньше всего, то оно и будет равновесным.

Представленное в предыдущем определении условие идентификации равновесного состояния, по сути, аналогично условию нахождения [глобального минимума функции](https://en.wikipedia.org/wiki/Maximum_and_minimum). [Известно](https://en.wikipedia.org/wiki/First_derivative_test), что необходимым условием для соответствия некоторой точки (состояния) глобальному минимуму функции (энергии Гиббса) является равенство нулю производной этой функции по независимым переменным в этой точке (этом состоянии). Такое состояние, в котором энергия Гиббса всей многофазной многокомпонентной системы характеризуется равенством нулю частной производной по количеству вещества $i$-го компонента в $j$-ой фазе при фиксированных давлении и температуре, будет характеризоваться равенством химических потенциалов соответствующих компонентов в фазах.

```{admonition} Теорема
:class: danger
Пусть многофазная многокомпонентная система находится при фиксированных давлении $P$, температуре $T$ и количествах вещества компонентов в ней $n_i, \, i = 1 \, \ldots \, N_c,$ в некотором состоянии с количеством фаз $N_p$ с соответствующими количествами вещества компонентов $n_{ji}, \, j = 1 \, \ldots \, N_p, \, i = 1 \, \ldots \, N_c$, в котором частная производная энергии Гиббса всей системы по $n_{ji}$ равна нулю:

$$ \left( \frac{\partial G}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i} = 0, \; j = 1 \, \ldots \, N_p, \; i = 1 \, \ldots \, N_c. $$

Тогда для такого состояния системы будет справедливо следующее равенство:

$$ \mu_{ji} = \mu_{N_pi}, \; j = 1 \, \ldots \, N_p - 1, \; i = 1 \, \ldots \, N_c. $$
```

Докажем  это следующим образом.

```{admonition} Доказательство
:class: proof
Учитывая экстенсивность энергии Гиббса, преобразуем частную производную энергии Гиббса всей системы по $n_{ji}$ следующим образом:

$$ \begin{align}
\left( \frac{\partial G}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i}
&= \frac{\partial}{\partial n_{ji}} \left( \sum_{l=1}^{N_p} G_l \left( \mathbf{n}_l \right) \right)_{P,T,n_{lk}, l \neq j, k \neq i} \\
&= \frac{\partial}{\partial n_{ji}} \left( \sum_{l=1}^{N_p-1} G_l \left( \mathbf{n}_l \right) \right)_{P,T,n_{lk}, l \neq j, k \neq i} + \left( \frac{\partial G_{N_p} \left( \mathbf{n}_{N_p} \right)}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i} \\
&= \sum_{l=1}^{N_p-1} \left( \frac{\partial G_l \left( \mathbf{n}_l \right)}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i} + \left( \frac{\partial G_{N_p} \left( \mathbf{n}_{N_p} \right)}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i}.
\end{align} $$

Принимая во внимание, что энергия Гиббса $j$-й фазы зависит от количеств вещества компонентов в этой $j$-й фазе, то есть:

$$ \left( \frac{\partial G_l \left( \mathbf{n}_l \right)}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i} = \begin{cases} \left( \frac{\partial G_j \left( \mathbf{n}_j \right)}{\partial n_{ji}} \right)_{P,T,n_{jk}, k \neq i}, \; & \mathrm{if} \; l = j, \; l = 1 \, \ldots \, N_p - 1, \; j = 1 \, \ldots \, N_p, \\ 0, \; & \mathrm{if} \; l \neq j, \; l = 1 \, \ldots \, N_p - 1, \; j = 1 \, \ldots \, N_p, \end{cases} $$

частная производная энергии Гиббса всей системы по $n_{ji}$:

$$ \left( \frac{\partial G}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i} = \left( \frac{\partial G_j \left( \mathbf{n}_j \right)}{\partial n_{ji}} \right)_{P,T,n_{jk}, k \neq i} + \left( \frac{\partial G_{N_p} \left( \mathbf{n}_{N_p} \right)}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i}. $$

Учитывая правило нахождения сложной функции, данное выражение преобразуется следующим образом:

$$ \left( \frac{\partial G}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i} = \left( \frac{\partial G_j \left( \mathbf{n}_j \right)}{\partial n_{ji}} \right)_{P,T,n_{jk}, k \neq i} + \left( \frac{\partial G_{N_p} \left( \mathbf{n}_{N_p} \right)}{\partial n_{N_pi}} \right)_{P,T,n_{N_pk},k \neq i} \left( \frac{\partial n_{N_pi}}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i}. $$

Выразим количество вещества $i$-го компонента в $N_p$-й фазе через количество вещества $i$-го компонента в системе в целом и в других фазах:

$$ \sum_{l=1}^{N_p} n_{li} = n_i, \; i = 1 \, \ldots \, N_c \Rightarrow n_{N_pi} = n_i - \sum_{l=1}^{N_p-1} n_{li}, \; i = 1 \, \ldots \, N_c. $$

Тогда частная прозводная количества вещества $i$-го компонента в $N_p$-й фазе по количеству вещества $i$-го компонента в $j$-ой фазе:

$$ \left( \frac{\partial n_{N_pi}}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i} = \left( \frac{\partial n_i}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i} - \sum_{l=1}^{N_p-1} \left( \frac{\partial n_{li}}{\partial n_{ji}} \right)_{P,T,n_{lk},k \neq i,l \neq j}. $$

Первое слагаемое в данном выражении равно нулю, поскольку количество вещества каждого компонента в системе в целом зафиксировано. Второе слагаемое можно представить следующим образом:

$$ \left( \frac{\partial n_{li}}{\partial n_{ji}} \right)_{P,T,n_{lk},k \neq i,l \neq j} = \begin{cases} 1, & \mathrm{if} \; l = j, \; l = 1 \ldots N_p - 1, \; j = 1 \, \ldots N_p, \\ 0, & \mathrm{if} \; l \neq j, \; l = 1 \ldots N_p - 1, \; j = 1 \, \ldots N_p. \end{cases} $$

Таким образом,

$$ \left( \frac{\partial n_{N_pi}}{\partial n_{ji}} \right)_{P,T,n_{N_pk},k \neq i} = \begin{cases} -1, & \mathrm{if} \; j = N_p, \; j = 1 \, \ldots \, N_p, \\ 0, & \mathrm{if} \; j \neq N_p, \; j = 1 \, \ldots \, N_p. \end{cases} $$

С учетом этого частная производная энергии Гиббса всей системы по $n_{ji}$:

$$ \left( \frac{\partial G}{\partial n_{ji}} \right)_{P,T,n_{lk}, l \neq j, k \neq i} = \left( \frac{\partial G_j \left( \mathbf{n}_j \right)}{\partial n_{ji}} \right)_{P,T,n_{jk}, k \neq i} - \left( \frac{\partial G_{N_p} \left( \mathbf{n}_{N_p} \right)}{\partial n_{N_pi}} \right)_{P,T,n_{N_pk},k \neq i} = 0. $$

Поскольку частная производная энергии Гиббса некоторой фазы по количеству вещества $i$-го компонента в этой фазе при фиксированных давлении и температуре [соответствует](../1-TD/TD-10-MixtureGibbsEnergy.md) химическому потенциалу $i$-го компонента в этой фазе, то:

$$ \mu_{ji} - \mu_{N_pi} = 0, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p. $$

```

Поскольу условие равенства нулю частной производной энергии Гиббса системы в целом по количеству вещества $i$-го компонента в $j$-ой фазе при фиксированных давлении и температуре является необходимым для определения глобального минимума функции, но не достаточным, то рассматриваемая система может характеризоваться набором состояний, удовлетворяющих данному условию. Такие состояния будем называть *стационарными*.

```{admonition} Определение
:class: tip
Cостояние $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$ является ***стационарным***, если:

$$ \left( \frac{\partial G}{\partial n_{ji}} \right)_{P,T,n_{lk},k \neq i, l \neq j} = 0, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_p. $$

```

Используя термин *стационарного* состояния, можно заменить данное выше определение *равновесного* состояния на следующее:

```{admonition} Определение
:class: tip
Некоторое *стационарное* состояние системы $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$, характеризующееся $N_p$ количеством *допустимых* фаз, удовлетворяющих закону сохранения масс, является ***равновесным***, если:

$$ G \left( \hat{M} \right) \leq G \left( \hat{K} \right), $$

где $\hat{K} = \left\{ \mathbf{r}_k, \, k = 1 \, \ldots \, K_p \right\}$ обозначает другие *стационарные* состояния системы, характеризующиеся $K_p$ количеством *допустимых* фаз, удовлетворяющих закону сохранения масс.
```

Центральным для анализа стабильности фазового состояния системы является положение, определяющее, что стационарное состояние системы может быть установлено путем идентификации общих точек касательной [гиперплоскости](https://en.wikipedia.org/wiki/Hyperplane) к [гиперповерхности](https://en.wikipedia.org/wiki/Hypersurface) функции энергии Гиббса. Приставки "гипер" необходимы при рассмотрении $N_c$-мерного пространства. Например, для двух компонентов функция энергии Гиббса представляет собой кривую на плоскости, касательной к которой является прямая. Для трех компонентов функция энергии Гиббса представляет собой поверхность, а касательная к ней – плоскость. Для $N_c$ компонентов функция энергии Гиббса – гиперповерхность, касательная к ней – гиперплоскость. Далее под поверхностью и плоскостью будут пониматься именно гиперповерхность и гиперплоскость соответственно.

```{admonition} Теорема
:class: danger
Пусть $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$ является некоторым состоянием системы, определяемым $N_p$ допустимыми фазами, удовлетворяющими закону сохранения масс. Тогда $G \left( \hat{M} \right)$ является стационарной точкой тогда и только тогда, когда функция $G$ дифференциируема для всех $\mathbf{n}_j, \, j = 1 \, \ldots \, N_p,$ и имеет одинаковую касательную плоскость для каждого $\mathbf{n}_j, \, j = 1 \, \ldots \, N_p$.
```

Приведем доказательство данной теоремы.

```{admonition} Доказательство
:class: proof
Пусть $L_j \left( \mathbf{r} \right), \, j = 1 \, \ldots \, N_p,$ является касательной плоскостью к поверхности $G_j \left( \mathbf{r} \right)$ в точке $\mathbf{n}_j, \, j = 1 \, \ldots \, N_p,$ являющейся стационарной. Тогда [уравнение касательной](https://en.wikipedia.org/wiki/Tangent) плоскости $L_j \left( \mathbf{r} \right)$ к поверхности $G_j \left( \mathbf{r} \right)$ в точке $\mathbf{n}_j$ описывается следующим выражением:

$$ L_j \left( \mathbf{r} \right) = G_j \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \frac{\partial G_j}{\partial r_i} \bigg|_{n_{ji}} \left( r_i - n_{ji} \right), \; j = 1 \, \ldots \, N_p. $$

При фиксированных давлении и температуре для энергии Гиббса выполняется следующее [свойство](../1-TD/TD-10-MixtureGibbsEnergy.md):

$$ G_j \left( \mathbf{n}_j \right) = \sum_{i=1}^{N_c} \frac{\partial G_j}{\partial r_i} \bigg|_{n_{ji}} n_{ji} = \sum_{i=1}^{N_c} \mu_{ji} n_{ji}, \; j = 1 \, \ldots \, N_p. $$

Подставляя данное выражение в уравнение касательной поверхности, получим:

$$ \begin{align}
L_j \left( \mathbf{r} \right)
&= \sum_{i=1}^{N_c} \frac{\partial G_j}{\partial r_i} \bigg|_{n_{ji}} n_{ji} + \sum_{i=1}^{N_c} \frac{\partial G_j}{\partial r_i} \bigg|_{n_{ji}} r_i - \sum_{i=1}^{N_c} \frac{\partial G_j}{\partial r_i} \bigg|_{n_{ji}} n_{ji} \\
&= \sum_{i=1}^{N_c} \frac{\partial G_j}{\partial r_i} \bigg|_{n_{ji}} r_i \\
&= \sum_{i=1}^{N_c} \mu_{ji} r_i, \; j = 1 \, \ldots \, N_p.
\end{align} $$

Поскольку для стационарного состояния выполняется условие постоянства химического потенциала компонентов, то есть химический потенциал каждого компонента не зависит от фазы, то есть $\mu_{ji} = \mu_{N_pi}, \, j = 1 \, \ldots \, N_p - 1, \, i = 1 \, \ldots \, N_c,$ в соответствии с приведенной выше леммой, то $L_j \left( \mathbf{r} \right)$ также не будет зависеть от фазы $j$, следовательно, для всех $j$ в стационарном состоянии уравнение касательной плоскости к поверхности энергии Гиббса одинаково. Верно и обратное: если все $L_j$ одинаковы, то химические потенциалы компонентов равны, и состояние является стационарным.
```

Представленная выше теорема говорит о том, что в стационарном состоянии $\hat{M}$ касательная плоскость $L_j \left( \mathbf{r} \right)$ к поверхности энергии Гиббса $G_j \left( \mathbf{r} \right)$ одинакова для всех составов фаз $\mathbf{n}_j, \; j = 1 \, \ldots \, N_p,$ определяющих рассматриваемое стационарное состояние $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots N_p \right\}$. Данное свойство будет проиллюстрировано примером в [разделе](./SEC-5-Equilibrium.md), посвященном определению равновесного состояния системы. Однако целью данного раздела является установление стабильности некоторого стационарного состояния системы. Для этого введем следующие обозначения.

Пусть $D \left( \mathbf{r} \right)$ является функцией разности между энергией Гиббса $G \left( \mathbf{r} \right)$ и функцией касательной плоскости к ней $L \left( \mathbf{r} \right)$:

$$ D \left( \mathbf{r} \right) = G \left( \mathbf{r} \right) - L \left( \mathbf{r} \right). $$

Для равновесного состояния (которое также является стационарным) в соответствии с представленной выше леммой преобразуем уравнение касательной плоскости:

$$ D \left( \mathbf{r} \right) = G \left( \mathbf{r} \right) - \sum_{i=1}^{N_c} \mu_i r_i.$$

Далее будет показано, что при любых значениях $\mathbf{r}$ в равновесном состоянии функция $D \left( \mathbf{r} \right)$ не принимает отрицательных значений. Однако прежде чем переходить к доказательству этого утверждения необходимо рассмотреть следующую лемму:

```{admonition} Лемма
:class: danger
Разница между энергией Гиббса системы в *любом состоянии* $\hat{K} = \left\{ \mathbf{r}_k, \, k = 1 \, \ldots \, K_p \right\}$, состоящем из $K_p$ приемлемых фаз, компонентный состав которых удовлетворяет закону сохранения масс, и энергией Гиббса в *стационарном состоянии* $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$ с $N_p$ приемлемыми фазами, причем $K_p$ может быть неравно $N_p$, есть сумма $D_k \left( \mathbf{r}_k \right), \, k = 1 \, \ldots \, K_p,$ по количеству фаз $K_p$, то есть:

$$ \sum_{k=1}^{K_p} G_k \left( \mathbf{r}_k \right) - \sum_{j=1}^{N_p} G_j \left( \mathbf{n}_j \right) = \sum_{k=1}^{K_p} D_k \left( \mathbf{r}_k \right). $$
```

Доказательство:

```{admonition} Доказательство
:class: proof
Поскольку система одна и та же, то выполняется закон сохранения масс:

$$ n_i = \sum_{j=1}^{N_p} n_{ji} = \sum_{k=1}^{K_p} r_{ki}, \; i = 1 \, \ldots \, N_c. $$

Для стационарного состояния характерно постоянство химического потенциала компонента $\mu_{ji}$ среди всех фаз $j = 1 \, \ldots \, N_p$. То есть справедливо следующее равенство:

$$ \mu_{ji} = \mu_{N_pi}, \; j = 1 \, \ldots \, N_p, \; i = 1 \, \ldots \, N_c. $$

Следовательно:

$$ \begin{align}
\sum_{j=1}^{N_p} G_j \left( \mathbf{n}_j \right)
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} \mu_{ji} n_{ji} \\
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} \mu_{N_pi} n_{ji} \\
&= \sum_{i=1}^{N_c} \mu_{N_pi} \sum_{j=1}^{N_p} n_{ji} \\
&= \sum_{i=1}^{N_c} \mu_{N_pi} \sum_{k=1}^{K_p} r_{ki} \\
&= \sum_{k=1}^{K_p} \sum_{i=1}^{N_c} \mu_{N_pi} r_{ki} \\
&= \sum_{k=1}^{K_p} L_k \left( \mathbf{r}_k \right).
\end{align} $$

Тогда

$$ \begin{align}
\sum_{k=1}^{K_p} G_k \left( \mathbf{r}_k \right) - \sum_{j=1}^{N_p} G_j \left( \mathbf{n}_j \right)
& = \sum_{k=1}^{K_p} G_k \left( \mathbf{r}_k \right) - \sum_{k=1}^{K_p} L_k \left( \mathbf{r}_k \right) \\
& = \sum_{k=1}^{K_p} \left( G_k \left( \mathbf{r}_k \right) - L_k \left( \mathbf{r}_k \right) \right) \\
& = \sum_{k=1}^{K_p} D_k \left( \mathbf{r}_k \right).
\end{align} $$
```

Теперь можем перейти к доказательству основной теоремы:

```{admonition} Теорема
:class: danger
Пусть система находится в некотором *стационарном* состоянии $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$. Причем значение энергии Гиббса в *любом другом состоянии* $\hat{K} = \left\{ \mathbf{r}_k, \, k = 1 \, \ldots \, K_p \right\}$ больше или равно касательной плоскости $L_k \left( \mathbf{r}_k \right), \, k = 1 \, \ldots \, K_p,$ иными словами $D_k \left( \mathbf{r}_k \right) \geq 0, \, k = 1 \, \ldots \, K_p,$ тогда данное стационарное состояние $\hat{M}$ является ***равновесным***.
```

Докажем данную теорему.

```{admonition} Доказательство
:class: proof
Рассмотрим любое состояние системы $\hat{K} = \left\{ \mathbf{r}_k, \, k = 1 \, \ldots \, K_p \right\}$. Тогда из условия $D_k \left( \mathbf{r}_k \right) \geq 0, \, k = 1 \, \ldots \, K_p,$ следует, что

$$ \sum_{k=1}^{K_p} D_k \left( \mathbf{r}_k \right) \geq 0. $$

Согласно доказанной ранее лемме, данное неравество можно записать следующим образом:

$$ \sum_{k=1}^{K_p} G_k \left( \mathbf{r}_k \right) - \sum_{j=1}^{N_p} G_j \left( \mathbf{n}_j \right) \geq 0. $$

Или:

$$ \begin{align}
\sum_{j=1}^{N_p} G_j \left( \mathbf{n}_j \right) & \leq \sum_{k=1}^{K_p} G_k \left( \mathbf{r}_k \right), \\
G \left( \hat{M} \right) & \leq G \left( \hat{K} \right).
\end{align} $$

То есть для любых $\mathbf{r}_k, \, k = 1 \, \ldots \, K_p,$ энергия Гиббса системы получается больше, чем при $\mathbf{n}_j, \, j = 1 \, \ldots \, N_p,$ то есть стационарное состояние $\hat{M} = \left\{ \mathbf{n}_j, \, j = 1 \, \ldots \, N_p \right\}$ характеризуется наименьшей энергией Гиббса, следовательно, оно является равновесным по определению.
```

Таким образом, доказанная теорема позволяет утверждать, что если для каждой из $K_p$ фаз стационарного состояния некоторой системы выполняется условие:

$$ D_k \left( \mathbf{r}_k \right) \geq 0 \; \forall \; \mathbf{r}_k \in {\rm I\!R}^{N_c} \, : \, \sum_{i=1}^{N_c} r_i \leq \sum_{i=1}^{N_c} n_i, \; k = 1 \, \ldots \, K_p, $$

то такое состояние является равновесным. Следовательно, данное ранее определение равновесного состояния, как стационарного состояния, характеризующегося наименьшей энергией Гиббса, можно переформулировать следующим образом:

```{admonition} Определение
:class: tip
***Равновесным состоянием*** называется такое *стационарное* состояние системы, при котором касательные гиперплоскости к гиперповерхностям энергии Гиббса фаз многофазной системы, проведенные в точках с компонентными составами этих фаз, не пересекают соответствующие гиперповерхности энергии Гиббса в любых других точках.
```

Таким образом, анализ стабильности некоторого стационарного состояния многофазной многокомпонентной системы можно проводить посредством исследования функции $D \left( \mathbf{r} \right)$, определяемой расстоянием от гиперповерхности энергии Гиббса до касательной гиперплоскости, проведенной в точке с компонентным составом рассматриваемого стационарного состояния. Эту функцию обычно называют *TPD – tangent plane distance*. Прежде чем переходить к рассмотрению примеров анализа стабильности графическим способом, необходимо выразить энергию Гиббса многофазной системы через [летучести](../1-TD/TD-15-Fugacity.md) компонентов в фазах:

$$ \begin{align}
\sum_{j=1}^{N_p} G_j \left( P, \, T, \, \mathbf{n}_j \right)
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \mu_{ji} \left( P, \, T, \, \mathbf{n}_j \right) \\
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \left( \mu_i \left( P^*, \, T \right) +  R T \ln \frac{f_{ji} \left( P, \, T, \, \mathbf{n}_j \right)}{P^*} \right) \\
&= \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \left( \mu_i \left( P^*, \, T \right) - R T \ln P^* \right) + R T \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( P, \, T, \, \mathbf{n}_j \right) \\
&= \sum_{i=1}^{N_c} \left( \mu_i \left( P^*, \, T \right) - R T \ln P^* \right) \sum_{j=1}^{N_p} n_{ji} + R T \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( P, \, T, \, \mathbf{n}_j \right) \\
&= \sum_{i=1}^{N_c} n_i \left( \mu_i \left( P^*, \, T \right) - R T \ln P^* \right) + R T \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( P, \, T, \, \mathbf{n}_j \right) \\
&= \Lambda \left( T, \, \mathbf{n} \right) + R T \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( P, \, T, \, \mathbf{n}_j \right).
\end{align} $$

Первое слагаемое в данном выражении $\Lambda \left( T, \mathbf{n} \right)$ является функцией от температуры и количеств вещества компонентов в системе в целом, которые являются фиксированными для рассматриваемой задачи анализа стабильности. То есть данное слагаемое можно рассматривать в качестве константы в выражении для энергии Гиббса. Следовательно, приведенные выше теоретические выкладки анализа стабильности будут применимы для *приведенной добавочной энергии Гиббса*, определяемой выражением:

$$ \tilde{G}^E \left( P, \, T, \, \hat{M} \right) = \sum_{j=1}^{N_p} \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( P, \, T, \, \mathbf{n}_j \right). $$

```{admonition} NB
Важно отметить, что при использовании одного и того же уравнения состояния для каждой из фаз выражение для приведенной добавочной энергии Гиббса будет одинаковым:

$$ \tilde{G}^E_j \left( P, \, T, \, \mathbf{n}_j \right) = \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( P, \, T, \, \mathbf{n}_j \right), \; j = 1 \, \ldots \, N_p. $$

Это обуславливает возможность проведения анализа стабильности для любой фазы многофазной системы вместо проверки условия положительности функции TPD для каждой из фаз.
```

С учетом этого получим выражение для расчета касательной к функции приведенной добавочной энергии Гиббса в точке, соответствующей стационарному состоянию $\mathbf{n}_j,   \, j = 1 \, \ldots \, N_p$:

````{margin}
```{admonition} Дополнительно
:class: note
При выводе данного выражения было использовано [уравнение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md).
```
````

$$ \begin{align}
\tilde{L}_j^E \left( \mathbf{r} \right)
&= \tilde{G}^E_j \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \frac{\partial \tilde{G}^E_j \left( \mathbf{r} \right) }{\partial r_i} \bigg|_{\mathbf{n}_j} \left(r_i - n_{ji} \right) \\
&= \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \frac{\partial}{\partial r_i} \left( \sum_{k=1}^{N_c} r_k \ln f_{jk} \left( \mathbf{r} \right) \right) \bigg|_{\mathbf{n}_j} \left(r_i - n_{ji} \right) \\
&= \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \sum_{k=1}^{N_c} \left( \frac{\partial r_k}{\partial r_i} \ln f_{jk} \left( \mathbf{r} \right) + \frac{\partial \ln f_{jk} \left( \mathbf{r} \right)}{\partial r_i} r_k \right) \bigg|_{\mathbf{n}_j} \left(r_i - n_{ji} \right) \\
&= \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \left( \sum_{k=1}^{N_c} \frac{\partial r_k}{\partial r_i} \ln f_{jk} \left( \mathbf{r} \right) + \sum_{k=1}^{N_c} \frac{\partial \ln f_{jk} \left( \mathbf{r} \right)}{\partial r_i} r_k \right) \bigg|_{\mathbf{n}_j} \left(r_i - n_{ji} \right) \\
&= \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \ln f_{ji} \left( \mathbf{r} \right) \bigg|_{\mathbf{n}_j} \left(r_i - n_{ji} \right) \\
&= \sum_{i=1}^{N_c} n_{ji} \ln f_{ji} \left( \mathbf{n}_j \right) + \sum_{i=1}^{N_c} \ln f_{ji} \left( \mathbf{n}_j \right) \left(r_i - n_{ji} \right) \\
&= \sum_{i=1}^{N_c} \ln f_{ji} \left( \mathbf{n}_j \right) r_i, \; j = 1 \, \ldots \, N_p.
\end{align} $$

Рассмотрим применение анализа стабильности с использованием функции *TPD* на следующих примерах.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $40 \; ^{\circ} C$ и давлении $2 \; МПа$ с мольной долей метана $0.85$. Необходимо определить, является ли однофазное состояние данной системы стабильным.
```

````{dropdown} Решение
Для решения данной задачи будем использовать [уравнение состояния Пенга-Робинсона](../2-EOS/EOS-2-SRK-PR.md), реализованное [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/eos.py).

Импортирурем необходимые библиотеки:

``` python
import numpy as np
from matplotlib import pyplot as plt
import sys
sys.path.append('../../_src/')
from eos import pr78
```

Зададим исходные термобарические условия и компонентный состав.

``` python
P = 2e6 # Pressure [Pa]
T = 40. + 273.15 # Temperature [K]
yi = np.array([0.15, 0.85]) # Mole fractions [fr.]
```

Зададим свойства компонентов, необходимые для уравнения состояния Пенга-Робинсона.

``` python
Pci = np.array([7.37646, 4.600155]) * 1e6 # Critical pressures [Pa]
Tci = np.array([304.2, 190.6]) # Critical temperatures [K]
wi = np.array([0.225, 0.008]) # Acentric factors
mwi = np.array([0.04401, 0.016043]) # Molar mass [kg/gmole]
vsi = np.array([0., 0.]) # Volume shift parameters
dij = np.array([0.025]) # Binary interaction parameters
```

Проинициализируем класс с используемым уравнением состояния.

``` python
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Выполним расчет приведенной энергии Гиббса для всех возможных компонентных составов рассматриваемой смеси. Для расчета коэффициентов летучестей компонентов для различных составов будем использовать метод `getPT_lnphiji_Zj`, принимающий в качестве аргументов давление (в Па), температуру (в K) и набор компонентных составов в виде двумерного массива (размерностью `(Np, Nc)`, где `Np` – количество наборов компонентных составов, `Nc` – количество компонентов в каждом компонентном составе) и возвращающий соответствующие коэффициенты летучести компонентов в виде двумерного массива такой же размерности и коэффициенты сверхсжимаемости в виде одномерного массива для каждого компонентного состава. Затем вычислим летучести компонентов и энергии Гиббса для соответствующих компонентных составов.

``` python
xj1 = np.linspace(1e-4, 0.9999, 100, endpoint=True)
xji = np.vstack([xj1, 1. - xj1]).T
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, xji)
lnfji = lnphiji + np.log(P * xji)
Gj = np.vecdot(xji, lnfji)
```

Теперь вычислим летучести компонентов для заданного компонентного состава. Для этого будем использовать метод `getPT_lnfi`, принимающий на вход давление (в Па), температуру (в K) и компонентный состав в виде одномерного масива (размерностью `(Nc,)`) и возвращающий логарифмы летучести компонентов в виде одномерного массива такой же размерности. Затем вычислим значения касательной к функции энергии Гиббса в точке с рассматриваемым компонентным составом.

``` python
lnfi = pr.getPT_lnfi(P, T, yi)
Lj = xji.dot(lnfi)
```

Построим зависимости энергии Гиббса и касательной к ней от количества вещества диоксида углерода в системе.

``` python
fig1, ax1 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax1.plot(xj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная добавочная энергия Гиббса')
ax1.plot(xj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax1.grid(zorder=1)
ax1.set_xlim(0., 1.)
ax1.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax1.set_ylabel('Приведенная добавочная энергия Гиббса')
ax1.legend(loc=3)
plt.show()
```

```{glue:} glued_fig1
```

<br>
<br>

Из представленного результата видно, что при рассматриваемых термобарических условиях касательная, проведенная в точке с заданным компонентным составом, не пересекает функцию энергии Гиббса, следовательно, можно сделать вывод о том, что однофазное состояние является стабильным. Более того, учитывая выпуклую вниз форму функции энергии Гиббса, можно заключить, что при любых компонентных составах данная система будет стабильна в однофазовом состоянии при рассматриваемых термобарических условиях.

Вычислим и построим зависимость функции TPD от количества вещества диоксида углерода в системе.

``` python
Dj = Gj - Lj
fig2, ax2 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax2.plot(xj1, Dj, lw=2., c='lime', zorder=2)
ax2.grid(zorder=1)
ax2.set_xlim(0., 1.)
ax2.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax2.set_ylabel('Tangent plane distance (TPD)')
plt.show()
```

```{glue:} glued_fig2
```

<br>
<br>

Функция TPD на всем интервале количества вещества диоксида углерода в системе не принимает отрицательных значений, что также свидетельствует об отсутствии пересечении касательной и функции энергии Гиббса, то есть о стабильности однофазного состояния рассматриваемой системы.

````

```{code-cell} python
:tags: [remove-cell]

import numpy as np
from matplotlib import pyplot as plt
import sys
sys.path.append('../../_src/')
from eos import pr78

P = 2e6 # Pressure [Pa]
T = 40. + 273.15 # Temperature [K]
yi = np.array([0.15, 0.85]) # Mole fractions [fr.]

Pci = np.array([7.37646, 4.600155]) * 1e6 # Critical pressures [Pa]
Tci = np.array([304.2, 190.6]) # Critical temperatures [K]
wi = np.array([0.225, 0.008]) # Acentric factors
mwi = np.array([0.04401, 0.016043]) # Molar mass [kg/gmole]
vsi = np.array([0., 0.]) # Volume shift parameters
dij = np.array([0.025]) # Binary interaction parameters

pr = pr78(Pci, Tci, wi, mwi, vsi, dij)

xj1 = np.linspace(1e-4, 0.9999, 100, endpoint=True)
xji = np.vstack([xj1, 1. - xj1]).T
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, xji)
lnfji = lnphiji + np.log(P * xji)
Gj = np.vecdot(xji, lnfji)

lnfi = pr.getPT_lnfi(P, T, yi)
Lj = xji.dot(lnfi)

fig1, ax1 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax1.plot(xj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная добавочная энергия Гиббса')
ax1.plot(xj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax1.grid(zorder=1)
ax1.set_xlim(0., 1.)
ax1.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax1.set_ylabel('Приведенная добавочная энергия Гиббса')
ax1.legend(loc=3)

Dj = Gj - Lj
fig2, ax2 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax2.plot(xj1, Dj, lw=2., c='lime', zorder=2)
ax2.grid(zorder=1)
ax2.set_xlim(0., 1.)
ax2.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax2.set_ylabel('Tangent plane distance (TPD)')

from myst_nb import glue
glue('glued_fig1', fig1)
glue('glued_fig2', fig2)
```

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $10 \; ^{\circ} C$ и давлении $6 \; МПа$ с мольной долей метана $0.1$. Необходимо определить, является ли однофазное состояние данной системы стабильным.
```

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = 6e6 # Pressure [Pa]
T = 10. + 273.15 # Temperature [K]
yi = np.array([0.9, 0.1]) # Mole fractions [fr.]
```

Выполним расчет приведенной энергии Гиббса для всех возможных компонентных составов рассматриваемой смеси. Затем определим летучести компонентов и энергии Гиббса для соответствующих компонентных составов. Для выполнения вычислений будем использовать проинициализированный в предыдущем примере класс с уравнением состояния.

``` python
xj1 = np.linspace(1e-4, 0.9999, 100, endpoint=True)
xji = np.vstack([xj1, 1. - xj1]).T
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, xji)
lnfji = lnphiji + np.log(P * xji)
Gj = np.vecdot(xji, lnfji)
```

Теперь вычислим летучести компонентов для заданного компонентного состава. Затем определим значения касательной к функции энергии Гиббса в точке с рассматриваемым компонентным составом.

``` python
lnfi = pr.getPT_lnfi(P, T, yi)
Lj = xji.dot(lnfi)
```

Построим зависимости энергии Гиббса и касательной к ней от количества вещества диоксида углерода в системе.

``` python
fig3, ax3 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax3.plot(xj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная добавочная энергия Гиббса')
ax3.plot(xj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax3.grid(zorder=1)
ax3.set_xlim(0., 1.)
ax3.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax3.set_ylabel('Приведенная добавочная энергия Гиббса')
ax3.legend(loc=4)
plt.show()
```

```{glue:} glued_fig3
```

<br>
<br>

Поскольку видно, что касательная, проведенная к функции энергии Гиббса в точке с рассматриваемым компонентным составом пересекает функцию энергии Гиббса, то однофазное состояние данной системы нестабильно. Построим зависимость функции TPD.

``` python
Dj = Gj - Lj
fig4, ax4 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax4.plot(xj1, Dj, lw=2., c='lime', zorder=2)
ax4.grid(zorder=1)
ax4.set_xlim(0., 1.)
ax4.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax4.set_ylabel('Tangent plane distance (TPD)')
plt.show()
```

```{glue:} glued_fig4
```

<br>
<br>

Функция TPD имеет отрицательные значения, что свидетельствует о пересечении касательной и функции энергии Гиббса, то есть о нестабильности однофазного состояния рассматриваемой системы.

````

```{code-cell} python
:tags: [remove-cell]

P = 6e6 # Pressure [Pa]
T = 10. + 273.15 # Temperature [K]
yi = np.array([0.9, 0.1]) # Mole fractions [fr.]

xj1 = np.linspace(1e-4, 0.9999, 100, endpoint=True)
xji = np.vstack([xj1, 1. - xj1]).T
lnphiji, Zj = pr.getPT_lnphiji_Zj(P, T, xji)
lnfji = lnphiji + np.log(P * xji)
Gj = np.vecdot(xji, lnfji)

lnfi = pr.getPT_lnfi(P, T, yi)
Lj = xji.dot(lnfi)

fig3, ax3 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax3.plot(xj1, Gj, lw=2., c='teal', zorder=2, label='Приведенная добавочная энергия Гиббса')
ax3.plot(xj1, Lj, lw=2., c='orchid', zorder=2, label='Касательная')
ax3.grid(zorder=1)
ax3.set_xlim(0., 1.)
ax3.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax3.set_ylabel('Приведенная добавочная энергия Гиббса')
ax3.legend(loc=4)

Dj = Gj - Lj
fig4, ax4 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax4.plot(xj1, Dj, lw=2., c='lime', zorder=2)
ax4.grid(zorder=1)
ax4.set_xlim(0., 1.)
ax4.set_xlabel('Количество вещества диоксида углерода в системе, моль')
ax4.set_ylabel('Tangent plane distance (TPD)')

glue('glued_fig3', fig3)
glue('glued_fig4', fig4)
```

(pvt-sec-stability-pt-num)=
### Численный подход к проверке стабильности фазового состояния системы

Представленные выше примеры наглядно демонстрируют применение графического метода, основанного на пересечении гиперповерхности функции энергии Гиббса и касательной гиперплоскости, проведенной в точке с заданным компонентным составом. Однако применение графического метода не подходит для решения задач гидродинамического моделирования. В связи с этим в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] был впервые представлен численный подход к проведению анализа стабильности, суть которого заключается в следующем. Для того чтобы определить, является ли фазовое состояние некоторой системы стабильным, необходимо понять, имеет ли функция *TPD (tangent plane distance)* отрицательные значения.

```{admonition} NB
:class: note
Необходимым критерием стабильности рассматриваемого фазового состояния системы с количествами вещества компонентов $\mathbf{n}$ является:

$$ \begin{align}
D \left( \mathbf{r} \right)
&= G \left( \mathbf{r} \right) - L \left( \mathbf{r} \right) \\
&= \sum_{i=1}^{N_c} \mu_i \left( \mathbf{y} \right) r_i - \sum_{i=1}^{N_c} \mu_i \left( \mathbf{z} \right) r_i \\
&= \sum_{i=1}^{N_c} r_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) \geq 0, \; \forall \, \mathbf{r} \, : \, \sum_{i=1}^{N_c} r_i \leq \sum_{i=1}^{N_c} n_i, \; \mathbf{r} > 0,
\end{align} $$

где:
$\mathbf{r}$ – произвольный состав рассматриваемой системы, моль;
$\mathbf{y} = \mathbf{r} \, / \sum_{i=1}^{N_c} r_i$ – мольные доли компонентов для произвольного состава, д.ед.;
$\mathbf{\mu} \left( \mathbf{y} \right)$ – химические потенциалы компонентов для произвольного состава системы, Дж/моль.;
$\mathbf{z} = \mathbf{n} \, / \sum_{i=1}^{N_c} n_i$ – заданный компонентный состав системы, д.ед.;
$\mathbf{\mu} \left( \mathbf{z} \right)$ – химические потенциалы компонентов для заданного компонентного состава системы, Дж/моль.
```

````{margin}
```{admonition} Дополнительно
:class: note
Важно отметить, что рассматриваемый подход к проверке стабильности фазового состояния однофазной системы можно использовать и для проверки стабильности многофазной системы: для этого достаточно проверить на стабильность компонентный состав любой из фаз, применив данный метод.
<!--- TODO: При условии, если свойства фаз рассчитываются с использованием одного и того же уравнения состояния. -->
```
````

Естественно, нет необходимости проверять значение функции TPD для всех составов системы, достаточно проверить значение функции TPD в ее глобальном минимуме: если в этой точке функция TPD неотрицательна, то систему можно считать стабильной. Однако поиск глобального минимума является достаточно сложной задачей для не выпуклых вниз функций. В связи с этим в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено заменить поиск глобального минимума функции TPD на проверку ее значений в локальных минимумах (стационарных точках). Для этого, задаваясь некоторым начальным приближением, находится первый локальный минимум, и проверяется значение функции TPD в нем. Если это значение меньше нуля, то рассматриваемое фазовое состояние считается нестабильным, и проверка заканчивается. Если же это значение неотрицательно, то рассматривается следующее начальное приближение. Алгоритм повторяется, пока не будут рассмотрены все начальные приближения. Если после рассмотрения всех начальных приближений не было получено отрицательное значение функции TPD, то система считается стабильной. Прежде чем переходить к рассмотрению реализаций данного алгоритма, необходимо получить условие стационарности (выражение, определяющее положение стационарных точек) функции TPD.

Для этого в представленном выше критерии стабильности фазового состояния системы разделим левую и правую часть на $\sum_{i=1}^{N_c} r_i > 0$:

$$ D \left( \mathbf{y} \right) = \sum_{i=1}^{N_c} y_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) .$$

Положение стационарных точек функции определяется равенством нулю частных производных по независимым переменным. В качестве независимых переменных будут выступать мольные доли компонентов $y_j, \; j = 1 \, \ldots \, N_c - 1,$ поскольку:

$$ y_{N_c} = 1 - \sum_{i=1}^{N_c-1} y_i. $$

Запишем и преобразуем выражение для частных производных функции TPD:

$$ \begin{align}
\frac{\partial D}{\partial y_j}
&= \sum_{i=1}^{N_c} \frac{\partial y_i}{\partial y_j} \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) + \sum_{i=1}^{N_c} y_i \frac{\partial \mu_i \left( \mathbf{y} \right)}{\partial y_j} \\
&= \sum_{i=1}^{N_c} \frac{\partial y_i}{\partial y_j} \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) \\
&= \left( \mu_j \left( \mathbf{y} \right) - \mu_j \left( \mathbf{z} \right) \right) - \left( \mu_{N_c} \left( \mathbf{y} \right) - \mu_{N_c} \left( \mathbf{z} \right) \right) \\
&= 0, \; j = 1 \, \ldots \, N_c - 1.
\end{align} $$

В процессе этого преобразования было использовано [соотношение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md) при постоянных давлении и температуре:

$$ \sum_{i=1}^{N_c} y_i \frac{\partial \mu_i \left( \mathbf{y} \right)}{\partial y_j} = 0. $$

Кроме того, частная производная $\frac{\partial y_i}{\partial y_j}$ принимает следующие значения:

$$ \frac{\partial y_i}{\partial y_j} = \begin{cases} 1, & i=j, \, i = 1 \, \ldots \, N_c -1; \\ -1, & i \neq j, \, i = N_c; \\ 0, & i \neq j. \end{cases} $$

Следовательно,

$$ \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) = \mu_{N_c} \left( \mathbf{y} \right) - \mu_{N_c} \left( \mathbf{z} \right) = K, \; i = 1 \, \ldots \, N_c - 1. $$

В данном выражении разность химических потенциалов последнего компонента обозначена константой $K$, поскольку она не зависит от индекса $i$, то есть является одинаковой (постоянной) для всех компонентов. Иными словами, разность химических потенциалов одинакова для соответствующих компонентов в стационарных точках функции TPD. Из этого следует, что касательные, проведенные к функции энергии Гиббса в точках, соответствующих стационарным точкам функции TPD, будут параллельны друг другу и касательной, проведенной в точке с рассматриваемым компонентным составом. Докажем данное утверждение.

```{admonition} Доказательство
:class: proof
Из приведенного выше соотношения выразим значения химического потенциала в точке, соответствующей стационарной точке функции TPD:

$$ \mu_i \left( \mathbf{y} \right) = \mu_i \left( \mathbf{z} \right) + K, \; i = 1 \, \ldots \, N_c - 1. $$

Тогда, согласно представленной выше теореме, уравнение касательной к функции энергии Гиббса в этой точке с компонентным составом $\mathbf{y}$:

$$ L_y \left( \mathbf{x} \right) = \sum_{i=1}^{N_c} \mu_i \left( \mathbf{y} \right) x_i = \sum_{i=1}^{N_c} \mu_i \left( \mathbf{z} \right) x_i + K \sum_{i=1}^{N_c} x_i = L_z \left( \mathbf{x} \right) + K .$$

То есть значение касательной к функции энергии Гиббса, проведенной в точке, соответствующей стационарной точке функции TPD, отличается от касательной, проведенной в точке с рассматриваемым компонентным составом, на константу $K$, следовательно, они являются параллельными.
```

Рассмотрим значение функции TPD в стационарной точке:

$$ D \left( \mathbf{y} \right) = \sum_{i=1}^{N_c} y_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right) = K. $$

Тогда условие стабильности рассматриваемой системы $D \left( \mathbf{y} \right) \geq 0$ можно представить в виде $K \geq 0$.

При этом условие стационарности функции TPD представляет собой систему нелинейных уравнений:

$$ \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) = K, \; i = 1 \, \ldots \, N_c. $$

Эта система имеет тривиальное решение $\mathbf{y} = \mathbf{z}$, в этом случае $K = 0$.

Для квази-стационарного изотермического процесса разность химических потенциалов [можно](../1-TD/TD-15-Fugacity.md#pvt-td-fugacity-realgasmixture) заменить разностью логарифмов летучестей компонентов. Следовательно, условие стационарности функции TPD записывается следующим образом:

$$ \begin{align}
RT \left( \ln f_i \left( \mathbf{y} \right) - \ln f_i \left( \mathbf{z} \right) \right) = K, \; i = 1 \, \ldots \, N_c, \\
\ln f_i \left( \mathbf{y} \right) - \ln f_i \left( \mathbf{z} \right) = \bar{K}, \; i = 1 \, \ldots \, N_c,
\end{align} $$

где $\bar{K} = K \, / \, RT$.

Преобразуем данное выражение с учетом [определения коэффициента летучести](../1-TD/TD-15-Fugacity.md):

$$ \ln y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = \bar{K}, \; i = 1 \, \ldots \, N_c. $$

Здесь под переменной $h_i$ обозначено следующее:

$$ h_i = \ln \phi_i \left( \mathbf{z} \right) + \ln z_i, \; i = 1 \, \ldots \, N_c. $$

С учетом изложенного выше функцию TPD преобразуем к следующему виду:

$$ \begin{align}
D \left( \mathbf{y} \right) &= \sum_{i=1}^{N_c} y_i \left( \mu_i \left( \mathbf{y} \right) - \mu_i \left( \mathbf{z} \right) \right), \\
\bar{D} \left( \mathbf{y} \right) &= \sum_{i=1}^{N_c} y_i \left( \ln y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \right).
\end{align} $$

Пусть $Y_i = y_i \exp \left( -\bar{K} \right), \, i = 1 \, \ldots \, N_c,$ тогда условие стационарности функции TPD:

$$ \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = 0, \; i = 1 \, \ldots \, N_c. $$

При этом условие стабильности $\bar{K} \geq 0$ можно представить в виде $\sum_{i=1}^{N_c} Y_i \leq 1$, поскольку

$$ \sum_{i=1}^{N_c} Y_i = \sum_{i=1}^{N_c} y_i \mathrm{e}^{-\bar{K}} = \mathrm{e}^{-\bar{K}} \sum_{i=1}^{N_c} y_i = \mathrm{e}^{-\bar{K}}. $$

Логарифмируя левую и правую части, получим:

$$ \ln \sum_{i=1}^{N_c} Y_i = - \bar{K}. $$

С учетом $\bar{K} \geq 0$ можно записать следующее неравенство:

$$ \ln \sum_{i=1}^{N_c} Y_i \leq 0 \Leftrightarrow \sum_{i=1}^{N_c} Y_i \leq 1. $$

Стоит отметить, что значение $Y_i, \, i = 1 \, \ldots \, N_c,$ можно условно интерпретировать как количество вещества $i$-го компонента, действительно:

$$ \frac{Y_i}{\sum_{i=1}^{N_c} Y_i} = \frac{y_i \mathrm{e}^{-\bar{K}}}{\sum_{i=1}^{N_c} y_i \mathrm{e}^{-\bar{K}}} = \frac{y_i \mathrm{e}^{-\bar{K}}}{\mathrm{e}^{-\bar{K}} \sum_{i=1}^{N_c} y_i} = y_i, \; i = 1 \, \ldots \, N_c. $$

Таким образом, система нелинейных уравнений, определяющая условие стационарности функции TPD, записывается следующим образом:

$$ g_i = \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = 0, \; i = 1 \, \ldots \, N_c. $$

После решения данной системы нелинейных уравнений относительно основных перменных $Y_i, \, i = 1 \, \ldots \, N_c,$ выполняется проверка стабильности рассматриваемой многокомпонентной системы. Фазовое состояние будет считаться стабильным, если:

$$ \sum_{i=1}^{N_c} Y_i \leq 1. $$

Рассмотрим некоторые численные алгоритмы решения данной системы нелинейных уравнений.

(pvt-sec-stability-pt-ss)=
### Метод последовательных подстановок

Одним из наиболее распространенных численных алгоритмов, используемых для определения стабильности фазового состояния многокомпонентной системы, является *метод последовательных подстановок (successive substitution method)*, также называемый [методом простой итерации](https://en.wikipedia.org/wiki/Fixed-point_iteration), суть которого заключается в итерационном обновлении основных переменных с использованием следующего выражения:

$$ \mathbf{t}^{k+1} = f \left( \mathbf{t}^{k} \right), $$

где $\mathbf{t}^{k+1} \in {\rm I\!R}^n$ – вектор основных переменных на $\left( k+1 \right)$-й итерации, $\mathbf{t}^{k} \in {\rm I\!R}^n$ – вектор основных переменных на $\left( k \right)$-й итерации, $f \, : \, {\rm I\!R}^n \rightarrow {\rm I\!R}^n$ – функция, принимающая на вход вектор размерности $n$ и возвращающая вектор такой же размерности. Соответственно, такая система уравнений должна иметь решение, удовлетворяющее следующему соотношению:

$$ \mathbf{t}^{*} = f \left( \mathbf{t}^{*} \right), $$

где $\mathbf{t}^{*} \in {\rm I\!R}^n$ – вектор основных переменных, соответствующий решению системы нелинейных уравнений. Прежде чем переходить к применению метода последовательных подстановок, выполним некоторые преобразования рассматриваемой системы нелинейных уравнений:

$$ \begin{align}
g_i
&= \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \\
&= \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right) - \ln z_i \\
&= \ln k_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right), \; i = 1 \, \ldots \, N_c.
\end{align} $$

В процессе данного преобразования было введено обозначение для вектора отношений количеств вещества компонентов $Y_i, \, i = 1 \, \ldots \, N_c,$ в произвольной фазе к соответствующим мольным долям в рассматриваемой системе $z_i, \, i = 1 \, \ldots \, N_c$:

$$ k_i = \frac{Y_i}{z_i}, \; i = 1 \, \ldots \, N_c. $$

Тогда рассматриваемую систему нелинейных уравнений можно преобразовать к следующему виду:

$$ \begin{align}
\ln k_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right) &= 0, \; i = 1 \, \ldots \, N_c, \\
\ln k_i &= \ln \phi_i \left( \mathbf{z} \right) - \ln \phi_i \left( \mathbf{y} \right), \; i = 1 \, \ldots \, N_c, \\
\ln k_i &= \ln k_i - \left( \ln k_i + \ln \phi_i \left( \mathbf{y} \right) - \ln \phi_i \left( \mathbf{z} \right) \right), \; i = 1 \, \ldots \, N_c, \\
\ln k_i &= \ln k_i - g_i, \; i = 1 \, \ldots \, N_c. \\
\end{align} $$

````{margin}
```{admonition} Дополнительно
:class: note
Метод последовательных подстановок может быть выражен относительно и других основных переменных, например, $Y_i, \, i = 1 \, \ldots \, N_c,$ или $\ln Y_i, \, i = 1 \, \ldots \, N_c$. Анализ сходимости численных алгоритмов проверки стабильности при использовании различных основных переменных был выполнен авторами \[[Petitfrere and Nichita, 2015](https://doi.org/10.1016/j.fluid.2014.11.017)\].
```
````

Таким образом, метод последовательных подстановок может быть использован для решения рассматриваемой системы нелинейных уравнений относительно основных переменных $k_i, \, i = 1 \, \ldots \, N_c$, обновление которых на некоторой итерации осуществляется с использованием следующего выражения:

$$ \begin{align}
\ln k_i^{k+1} &= \ln k_i^{k} - g_i^{k}, \; i = 1 \, \ldots \, N_c, \\
k_i^{k+1} &= k_i^{k} \cdot \exp \left(- g_i^{k} \right), \; i = 1 \, \ldots \, N_c.
\end{align} $$

С учетом вышеизложенного представим алгоритм метода последовательных постановок для решения задачи проверки стабильности фазового состояния системы.

```{eval-rst}
.. role:: comment
    :class: comment
```

```{admonition} Алгоритм. Анализ стабильности с использованием метода SS
:class: algorithm

**Дано:** Вектор компонентного состава исследуемой системы $\mathbf{z} \in {\rm I\!R}^{N_c}$; термобарические условия $P$ и $T$; необходимые свойства компонентов для нахождения коэффициентов летучести компонентов с использованием уравнения состояния; максимальное число итераций $N_{iter}$; точность решения системы нелинейных уравнений $\epsilon_1$; численная погрешность расчета $0 < \epsilon_2 \leq 10^{-4}$.

**Определить:** Является ли однофазное состояние системы с компонентным составом $\mathbf{z}$ при давлении $P$ и температуре $T$ стабильным.

**Псевдокод:**  
**def** $\phi \left( \mathbf{y} \in {\rm I\!R}^{N_c}, \, \ldots \right) \rightarrow \boldsymbol{\varphi} \in {\rm I\!R}^{N_c}$ {comment}`# Функция для расчета вектора коэффициентов летучести`  
$\mathbf{K} := \left\{ \mathbf{k}_0, \, \mathbf{k}_1, \, \ldots, \, \mathbf{k}_N \right\}$ {comment}`# Инициализация набора (матрицы) начальных приближений`  
$\mathbf{h} := \ln \phi \left( \mathbf{z} \right) + \ln \mathbf{z}$  {comment}`# Расчет коэффициентов летучести для начального состава`  
**for** $i := 1$ **to** $N$ **do** {comment}`# Цикл перебора начальных приближений`  
&emsp;$\mathbf{k} := \mathbf{K}\left[ i \right]$ {comment}`# Вектор основных переменных`  
&emsp;$\mathbf{Y} := \mathbf{k} \cdot \mathbf{z}$  
&emsp;$\mathbf{y} := \mathbf{Y} \, / \, \sum_{i=1}^{N_c} Y_i$  
&emsp;$\mathbf{g} := \ln \mathbf{Y} + \ln \phi \left( \mathbf{y} \right) - \mathbf{h}$ {comment}`# Вектор невязок`  
&emsp;$c := 1$ {comment}`# Счетчик итераций решения системы нелинейных уравнений`  
&emsp;**while** $\lVert \mathbf{g} \rVert_2 > \epsilon_1$ **and** $c < N_{iter}$ **do** {comment}`# Цикл решения системы нелинейных уравнений`  
&emsp;&emsp;$\mathbf{k} := \mathbf{k} \cdot \exp \left( - \mathbf{g} \right)$ {comment}`# Расчет новых значений вектора основных переменных`  
&emsp;&emsp;$\mathbf{Y} := \mathbf{k} \cdot \mathbf{z}$  
&emsp;&emsp;$\mathbf{y} := \mathbf{Y} \, / \, \sum_{i=1}^{N_c} Y_i$  
&emsp;&emsp;$\mathbf{g} := \ln \mathbf{Y} + \ln \phi \left( \mathbf{y} \right) - \mathbf{h}$ {comment}`# Новые значения вектора невязок`  
&emsp;&emsp;$c := c + 1$ {comment}`# Обновление счетчика итераций`  
&emsp;**end while**  
&emsp;$TPD := - \ln \sum_{i=1}^{N_c} Y_i$ {comment}`# Расчет значения функции TPD`  
&emsp;**if** $\lVert \mathbf{g} \rVert_2 < \epsilon_1$ **and** $TPD < -\epsilon_2$ **then** {comment}`# Проверка условия стабильности`  
&emsp;&emsp;$is\_stable := \mathrm{False}$  
&emsp;&emsp;**exit for** {comment}`# Выход из цикла перебора начальных приближений`  
&emsp;**else**  
&emsp;&emsp;**continue**  
&emsp;**end if**  
**else**  
&emsp;$is\_stable := \mathrm{True}$  
**end for**  
```

В данном алгоритме в качестве критерия, определяющего нестабильность рассматриваемого однофазового состояния, использовалось следующее выражение:

$$ TPD = - \ln \sum_{i=1}^{N_c} Y_i < -\epsilon_2, $$

где значение $\epsilon_2$ выбирается из диапазона $0 < \epsilon_2 \leq 10^{-4}$ \[[Nghiem and Li, 1984](https://doi.org/10.1016/0378-3812(84)80013-8)\]. Использование такого подхода необходимо в связи с применением численного метода, в ходе которого система нелинейных уравнений разрешается с некоторой точностью. Его преимуществом является сравнительная простота вычисления, а недостатком – ложное отнесение состояний, характеризующихся $- \epsilon_2 < TPD < 0$, к стабильным. В связи с этим в работе \[[Liang, 2018](https://doi.org/10.1021/acs.iecr.8b03956)\] в качестве параметра $\epsilon_2$ используется значение $10^{-8}$. При этом очевидно, что значение данного параметра должно зависеть от допустимой точности решения системы нелинейных уравнений $\epsilon_1$. Так, например, автором работы \[[Liang, 2018](https://doi.org/10.1021/acs.iecr.8b03956)\] применяется еще более строгое значение $\epsilon_1 = 10^{-10}$.

Учитывая влияние параметра $\epsilon_1$ на $\epsilon_2$, можно сформулировать альтернативный критерий следующим образом:

$$ \left( - \ln \sum_{i=1}^{N_c} Y_i < 0 \right) \land \left( \max_i k_i - \min_i k_i > \epsilon_1 \right). $$

Недостатком данной формулировки является необходимость нахождения минимального и максимального элемента вектора основных переменных $k_i, \, i = 1 \, \ldots \, N_c$.

(pvt-sec-stability-pt-ss-init)=
#### Начальные приближения

Итак, рассматриваемая задача анализа стабильности фазового состояния системы заключается в проверке значений функции TPD в ее стационарных точках. Как уже было отмечено ранее, для нахождения различных стационарных точек необходимо задаться множеством начальных приближений. В связи с этим очевидным недостатком данного подхода является конечность набора начальных приближений (и с точки зрения времени счета – их количество, ведь чем больше начальных приближений мы рассмотрим, тем с большей вероятностью найдем глобальный минимум функции TPD, однако это приведет к увеличению времени работы алгоритма). Таким образом, корректный выбор начальных приближений является одним из залогов успешного решения задачи определения стабильности фазового состояния системы.

В работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать корреляцию Уилсона для генерации начальных приближений углеводородной системы:

$$ k_i^{go} = \frac{{P_c}_i}{P} \cdot \exp \left( 5.3727 \left(1 + \omega_i \right) \left(1 - \frac{{T_c}_i}{T} \right) \right), \; i = 1 \, \ldots \, N_c. $$

То есть в качестве начальных приближений $k_i, \, i = 1 \, \ldots \, N_c,$ в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] применялся набор из следующих векторов:

$$ k_{ji} = \left\{ k_i^{go}, \; \frac{1}{k_i^{go}} \right\}, \; j = \left\{ 1, \, 2 \right\}, \; i = 1 \, \ldots \, N_c. $$

Автором отмечается, что если рассматривать системы, состоящие из углеводородных компонентов, то при использовании одного из данных векторов в качестве начального приближения алгоритм сходится к тривиальному решению, а при использовании другого – к искомому решению системы нелинейных уравнений. Следовательно, для многих углеводородных смесей необходим только один из данных векторов: если заданный компонентный состав рассматриваемой системы больше походит на жидкость, то в качестве начального приближения подходит вектор $k_i^{go}, \, i = 1 \, \ldots \, N_c,$ иначе: $1 \, / \, k_i^{go}, \, i = 1 \, \ldots \, N_c$. Однако для систем, находящихся вблизи критической точки, необходимо использование обоих начальных приближений, поскольку значения плотностей фаз становятся близкими друг к другу, и заранее неизвестно, к какому фазовому состоянию (жидкому или газообразному) ближе исходный компонентный состав рассматриваемой системы.

````{margin}
```{admonition} Дополнительно
:class: note
Вблизи [критической точки](SEC-7-Criticality.md) компонентные составы фаз становятся похожими друг на друга, а отношения мольных долей компонентов в фазах стремятся к единице. Это обуславливает возведение элементов векторов начальных приближений в степень $\left( 1 \, / \, 3 \right)$, позволяющее снизить различие между максимальным и минимальным значениями элементов вектора.
```
````

Для систем вблизи критической точки и систем, включающих неуглеводородные компоненты, в работе \[[Li and Firoozabadi, 2012](https://doi.org/10.2118/129844-PA)\] было предложено дополнить данный набор следующими начальными приближениями:

$$ k_i = \left\{ k_i^{go}, \; \frac{1}{k_i^{go}}, \; \sqrt[3]{k_i^{go}}, \; \frac{1}{\sqrt[3]{k_i^{go}}}, \; k_i^{pure} \right\}, \; i = 1 \, \ldots \, N_c, $$

где:

$$ k_i^{pure} = \begin{cases} \left(1 - \epsilon \right) / z_i, & i = \mathrm{specific \, component}, \\ \left( \epsilon / \left( N_c - 1 \right) \right) / z_i, & i = \mathrm{others}. \end{cases} $$

Данный набор начальных приближений хорошо подходит для проверки стабильности систем, где мольная доля одного компонента в потенциальной (мнимой) фазе много больше мольных долей других. Например, к таким системам относится смесь углеводородов с водой, в этом случае $\epsilon = 1\mathrm{e}-3$, согласно \[[Connolly et al, 2019](https://doi.org/10.1021/acs.iecr.9b00695)\] (для водных растворов иногда имеет смысл задать $\epsilon = 1\mathrm{e}-15$, согласно \[[Li and Li, 2019](https://doi.org/10.1016/j.fuel.2019.02.026)\]). Для систем с высоким содержанием диоксида углерода рекомендуется $\epsilon = 0.05$, согласно \[[Imai at al, 2019](https://doi.org/10.1016/j.fluid.2019.06.002)\].

(pvt-sec-stability-pt-ss-examples)=
#### Примеры

Рассмотрим реализацию данного алгоритма для приведенных выше примеров.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $40 \; ^{\circ} C$ и давлении $2 \; МПа$ с мольной долей метана $0.85$. Необходимо определить, является ли однофазное состояние данной системы стабильным, с использованием численного алгоритма.
```

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = 2e6 # Pressure [Pa]
T = 40. + 273.15 # Temperature [K]
yi = np.array([0.15, 0.85]) # Mole fractions [fr.]
```

Также зададим максимальное число итераций $N_{iter}$, точность решения системы нелинейных уравнений $\epsilon_1$, численную погрешность расчета $\epsilon_2$:

``` python
maxiter = 50 # Maximum number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4
```

Для выполнения вычислений будем использовать свойства компонентов и класс с уравнением состояния, заданные при рассмотрении предыдущих примеров. Рассчитаем матрицу начальных приближений $\mathbf{K}$. Для данного примера нам будет достаточно два приближения, рассчитанных по уравнению Уилсона:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Создадим функцию, которая будет принимать на вход кортеж из результатов предыдущей итерации, точность и максимальное число итераций, и возвращать необходимость расчета следующей итерации цикла решения системы нелинейных уравнений:

``` python
def condit_ss(carry, tol, maxiter):
    k, ki, gi = carry
    return k < maxiter and np.linalg.norm(gi) > tol
```

Также создадим функцию, которая будет принимать на вход результаты предыдущей итерации в виде кортежа и рассчитывать результаты для новой итерации:

``` python
def update_ss(carry, hi, yi, plnphi):
    k, ki, gi = carry
    ki_kp1 = ki_k * np.exp(-gi_k)
    ni = ki_kp1 * yi
    gi_kp1 = np.log(ni) + plnphi(yi=ni/ni.sum()) - hi
    return k + 1, ki_kp1, gi_kp1
```

Выполним расчет коэффициентов летучести для начального компонентного состава. Для этого будем использовать метод `getPT_lnphii` инициализированного класса с уравнением состояния, принимающий на вход давление (в Па), температуру (в K) и компонентный состав в виде одномерного массива (размерностью `(Nc,)`) и возвращающий массив логарифмов коэффициентов летучести компонента такой же размерности:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Проинициализируем функции `condit_ss` и `update_ss`:

``` python
from functools import partial

pcondit = partial(condit_ss, tol=eps1, maxiter=maxiter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (0, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {gnorm}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tk-values: {ki}\n'
          f'\tTPD: {TPD}')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out1
```

По результатам расчетов видно, что для обоих начальных приближений алгоритм сошелся на тривиальном решении, в котором значение TPD равно нулю. Таким образом, можно сделать вывод, что система стабильна.
````

```{code-cell} python
:tags: [remove-cell]

P = 2e6 # Pressure [Pa]
T = 40. + 273.15 # Temperature [K]
yi = np.array([0.15, 0.85]) # Mole fractions [fr.]

maxiter = 50 # Maximum number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

def condit_ss(carry, tol, maxiter):
    k, ki, gi = carry
    return k < maxiter and np.linalg.norm(gi) > tol

def update_ss(carry, hi, yi, plnphi):
    k, ki_k, gi_k = carry
    ki_kp1 = ki_k * np.exp(-gi_k)
    ni = ki_kp1 * yi
    gi_kp1 = np.log(ni) + plnphi(yi=ni/ni.sum()) - hi
    return k + 1, ki_kp1, gi_kp1

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

from functools import partial

pcondit = partial(condit_ss, tol=eps1, maxiter=maxiter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))

out1 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (0, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    out1 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {gnorm}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tk-values: {ki}\n'
             f'\tTPD: {TPD}\n')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

out1 += f'The system is stable: {is_stable}'

class MultilineText(object):
    def __init__(self, text):
        self.text = text
        self.template = """
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre id="codecell20" tabindex="0"><span></span>{}
</pre><button class="copybtn o-tooltip--left" data-tooltip="Copy" data-clipboard-target="#codecell20">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#000000" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <title>Copy to clipboard</title>
  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
  <rect x="8" y="8" width="12" height="12" rx="2"></rect>
  <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path>
</svg>
    </button></div>
</div>
"""

    def _repr_html_(self):
        return self.template.format(self.text.replace('\n', '<br>'))

glue('glued_out1', MultilineText(out1))

```

Рассмотрим применение данного алгоритма для следующего примера.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода при температуре $10 \; ^{\circ} C$ и давлении $6 \; МПа$ с мольной долей метана $0.1$. Необходимо определить, является ли однофазное состояние данной системы стабильным, с использованием численного алгоритма.
```

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = 6e6 # Pressure [Pa]
T = 10. + 273.15 # Temperature [K]
yi = np.array([0.9, 0.1]) # Mole fractions [fr.]
```

Для выполнения вычислений будем использовать свойства компонентов и класс с уравнением состояния, заданные при рассмотрении предыдущих примеров. Рассчитаем матрицу начальных приближений $\mathbf{K}$:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Проинициализируем функции `condit_ss` и `update_ss`:

``` python
pcondit = partial(condit_ss, tol=eps1, maxiter=maxiter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (0, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {gnorm}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tk-values: {ki}\n'
          f'\tTPD: {TPD}')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out2
```

Реализованный алгоритм проверки стабильности уже для первого начального приближения нашел решение системы нелинейных уравнений, характеризующееся отрицательным значением функции TPD, следовательно, однофазное состояние не является стабильным.
````

```{code-cell} python
:tags: [remove-cell]

P = 6e6 # Pressure [Pa]
T = 10. + 273.15 # Temperature [K]
yi = np.array([0.9, 0.1]) # Mole fractions [fr.]

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

pcondit = partial(condit_ss, tol=eps1, maxiter=maxiter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))

out2 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (0, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    out2 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {gnorm}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tk-values: {ki}\n'
             f'\tTPD: {TPD}\n')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

out2 += f'The system is stable: {is_stable}'

glue('glued_out2', MultilineText(out2))

```

Важно отметить, что метод последовательных подстановок может характеризоваться малой скоростью сходимости, в особенности для термобарических условий вблизи границы двухфазной области. Проиллюстрируем данное свойство следующим примером.

<!-- TODO: добавить анализ сходимости метода SS. См. 10.1016/0378-3812(82)85001-2, 10.1021/ie00042a032, 10.1002/aic.690210314 -->

````{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси следующего мольного состава:

```{table}
:width: 100%
:widths: "1, 1, 1, 1, 1, 1"
| Компонент | $\mathrm{CH_4}$ | $\mathrm{C_2 H_6}$ | $\mathrm{C_3 H_8}$ | $\mathrm{n \mbox{-} C_4}$ | $\mathrm{C_{5+}}$ |
| :---: | :---: | :---: | :---: | :---: | :---: |
| Мольная доля | 0.7167 | 0.0895 | 0.0917 | 0.0448 | 0.0573 |
```

<br>

Необходимо определить является ли однофазное состояние стабильным при давлении $17 \; МПа$ и температуре $68 \; ^{\circ} C$.
````

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = 17e6 # Pressure [Pa]
T = 68. + 273.15 # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]
```

Зададим свойства компонентов, необходимые для уравнения состояния Пенга-Робинсона, и выполним инициализацию класса.

``` python
Pci = np.array([4.599, 4.872, 4.248, 3.796, 2.398]) * 1e6 # Critical pressures [Pa]
Tci = np.array([190.56, 305.32, 369.83, 425.12, 551.02]) # Critical temperatures [K]
wi = np.array([0.012, 0.100, 0.152, 0.200, 0.414]) # Acentric factors
mwi = np.array([0.016043, 0.03007, 0.044097, 0.058123, 0.120]) # Molar mass [kg/gmole]
vsi = np.array([-0.1595, -0.1134, -0.0863, -0.0675, 0.05661]) # Volume shift parameters
dij = np.array([
    0.002689,
    0.008537, 0.001662,
    0.014748, 0.004914, 0.000866,
    0.039265, 0.021924, 0.011676, 0.006228,
]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Рассчитаем матрицу начальных приближений $\mathbf{K}$:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Зададим максимальное число итераций $N_{iter}$, точность решения системы нелинейных уравнений $\epsilon_1$, численную погрешность расчета $\epsilon_2$. Для данного примера увеличим максимальное число итераций:

``` python
maxiter = 200 # Maximum number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4
```

Проинициализируем функции `condit` и `update`:

``` python
pcondit = partial(condit_ss, tol=eps1, maxiter=maxiter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (0, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {gnorm}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tk-values: {ki}\n'
          f'\tTPD: {TPD}\n')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out3
```

По результатам расчетов метод последовательных подстановок для первого начального приближения сошелся к тривиальному решению за 185 итераций, а для следующего начального приближения нашел решение, характеризующееся отрицательным значением функции TPD, за 71 итерацию. Таким образом, рассматриваемое однофазное состояние не является стабильным.
````

```{code-cell} python
:tags: [remove-cell]

P = 17e6 # Pressure [Pa]
T = 68. + 273.15 # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]

Pci = np.array([4.599, 4.872, 4.248, 3.796, 2.398]) * 1e6 # Critical pressures [Pa]
Tci = np.array([190.56, 305.32, 369.83, 425.12, 551.02]) # Critical temperatures [K]
wi = np.array([0.012, 0.100, 0.152, 0.200, 0.414]) # Acentric factors
mwi = np.array([0.016043, 0.03007, 0.044097, 0.058123, 0.120]) # Molar mass [kg/gmole]
vsi = np.array([-0.1595, -0.1134, -0.0863, -0.0675, 0.05661]) # Volume shift parameters
dij = np.array([
    0.002689,
    0.008537, 0.001662,
    0.014748, 0.004914, 0.000866,
    0.039265, 0.021924, 0.011676, 0.006228,
]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

maxiter = 200 # Maximum number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4

pcondit = partial(condit_ss, tol=eps1, maxiter=maxiter)
pupdate = partial(update_ss, hi=hi, yi=yi, plnphi=partial(pr.getPT_lnphii, P=P, T=T))

out3 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    gi = np.log(ni) + pr.getPT_lnphii(P=P, T=T, yi=ni/ni.sum()) - hi
    carry = (0, ki, gi)
    while pcondit(carry):
        carry = pupdate(carry)
    c, ki, gi = carry
    ni = ki * yi
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    out3 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {gnorm}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tk-values: {ki}\n'
             f'\tTPD: {TPD}\n')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

out3 += f'The system is stable: {is_stable}'

glue('glued_out3', MultilineText(out3))

```

<!-- TODO: показать на примере увеличение количества итераций метода последовательных подстановок вблизи критической точки -->

Существует также множество работ, посвященных разработке алгоритмов, направленных на оптимизацию метода последовательных подстановок. В работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать метод GDEM. В работах \[[Nghiem, 1983](https://doi.org/10.2118/12242-MS); [Nghiem and Li, 1984](https://doi.org/10.1016/0378-3812(84)80013-8)\] авторы рассмотрели различные подходы к оптимизации метода последовательных подстановок путем введения длины шага итерации и его расчета на основе результатов предыдущей итерации. Примеры реализации некоторых из алгоритмов представлены [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/stability.py).

(pvt-sec-stability-pt-newton)=
### Метод минимизации функции

К решению задачи определения стабильности некоторой системы можно подойти с точки зрения минимизации функции TPD:

$$ \bar{D} \left( \mathbf{y} \right) = \sum_{i=1}^{N_c} y_i \left( \ln y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \right). $$

Если использовать в качестве основных переменных мольные доли компонентов для произвольного состава $y_i, \, i = 1 \, \ldots \, N_c,$, то такая задача будет являться *задачей условной минимизации* или *задачей минимизации с ограничениями (constrained minimization)*. В качестве условий будут выступать следующие соотношения:

$$ \begin{align}
& y_i > 0, \; i = 1 \, \ldots \, N_c, \\
& \sum_{i=1}^{N_c} y_i = 1.
\end{align} $$

Решение задачи условной минимизации зачастую сложнее *безусловной (unconstrained minimization)*. В связи с этим имеет смысл исключить данные условия из рассмотрения путем замены основных переменных. Для исключения второго условия в качестве основных переменных можно использовать уже упомянутые ранее количества вещества компонентов в произвольной (мнимой) фазе:

$$ Y_i = y_i \mathrm{e}^{-\bar{K}}, \; i = 1 \, \ldots \, N_c. $$

В связи с изложенным выше при использовании $Y_i, \, i = 1 \, \ldots \, N_c,$ в качестве основных переменных положение стационарных точек функции TPD будет определяться следующей системой нелинейных уравнений:

$$ g_i = \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i = 0, \; i = 1 \, \ldots \, N_c. $$

При этом в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено использовать вместо функции TPD ее модификацию:

$$ \bar{D}^* \left( \mathbf{Y} \right) = 1 + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right). $$

Докажем, что замена функции $\bar{D} \left( \mathbf{y} \right)$ на модифицированную $\bar{D}^* \left( \mathbf{Y} \right)$ является допустимой для рассматриваемой задачи проверки стабильности фазового состояния.

````{margin}
```{admonition} Дополнительно
:class: note
Используя [уравнение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md) при постоянных (фиксированных) давлении и температуре, получим:

$$ \sum_{i=1}^{N_c} n_i d \mu_i = 0. $$

С учетом [соотношения](../1-TD/TD-15-Fugacity.md) между дифференциалом химического потенциала $i$-го компонента и дифференциалом логарифма его летучести данное равенство преобразуется следующим образом:

$$ \begin{align}
\sum_{i=1}^{N_c} n_i RT d \ln f_i = 0, \\
\sum_{i=1}^{N_c} n_i d \ln f_i = 0.
\end{align} $$

Разделив левую и правую части на $\partial n_j, \, j = 1 \, \ldots \, N_c,$, получим:

$$ \begin{align}
& \sum_{i=1}^{N_c} n_i \frac{\partial \ln f_i}{\partial n_j} = 0, \\
& j = 1 \, \ldots \, N_c.
\end{align} $$

Далее воспользуемся соотношением между частными производными логарифма летучести и логарифма коэффициента летучести, полученным [ранее](../2-EOS/Appendix-A-PD.md):

$$ \frac{\partial \ln f_i}{\partial n_j}  = \frac{\partial \ln \phi_i}{\partial n_j} + \frac{\delta_{ij}}{n_i} - \frac{1}{n}. $$

Подставив данное выражение в уравнение Гиббса-Дюгема и выполнив некоторые преобразования, получим:

$$ \begin{align}
& \sum_{i=1}^{N_c} n_i \frac{\partial \ln \phi_i}{\partial n_j} = 0, \\
& j = 1 \, \ldots \, N_c.
\end{align} $$

```
````

```{admonition} Доказательство
:class: proof
В рамках решения задачи стабильности многокомпонентной системы, сводимой к решению задачи поиска локальных минимумов функции TPD и проверки ее значений в них, замена функции TPD возможна при условии одинаковости положения (координат) стационарных точек и знака функции в них. Для проверки соответствия положения стационарных точек модифицированной функции TPD получим систему уравнений, характеризующую их координаты, которая определяется равенством нулю частных производных функции по основным переменным:

$$ \begin{align}
\frac{\partial \bar{D}^*}{\partial Y_j}
&= \frac{\partial}{\partial Y_j} \left( 1 + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) \right) \\
&= \sum_{i=1}^{N_c} \frac{\partial Y_i}{\partial Y_j} \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) + \sum_{i=1}^{N_c} Y_i \left( \frac{\partial \ln Y_i}{\partial Y_j} + \frac{\partial \ln \phi_i \left( \mathbf{y} \right)}{\partial Y_j} \right) \\
&= \sum_{i=1}^{N_c} \delta_{ij} \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) + \sum_{i=1}^{N_c} Y_i \left( \frac{1}{Y_i} \delta_{ij} + \frac{\partial \ln \phi_i \left( \mathbf{y} \right)}{\partial Y_j} \right) \\
&= \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j - 1 + \sum_{i=1}^{N_c} \delta_{ij} + \sum_{i=1}^{N_c} Y_i \frac{\partial \ln \phi_i \left( \mathbf{y} \right)}{\partial Y_j} \\
&= \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j, \; j = 1 \, \ldots \, N_c.
\end{align} $$

При выводе данного выражения использовалось [уравнение Гиббса-Дюгема](../1-TD/TD-12-GibbsDuhemEquation.md).

Таким образом, положение стационарных точек исходной и модифицированной функций TPD определяется одной и той же системой нелинейных уравнений. Получим выражение для модифицированной функции TPD в стационарных точках, в которых значения частных производных функции по основным переменным равны нулю:

$$ \begin{align}
\bar{D}^*_{sp}
&= 1 + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i - 1 \right) \\
&= 1 - \sum_{i=1}^{N_c} Y_i + \sum_{i=1}^{N_c} Y_i \left( \ln Y_i + \ln \phi_i \left( \mathbf{y} \right) - h_i \right) \\
&= 1 - \sum_{i=1}^{N_c} Y_i \\
&= 1 - \exp \left( -\bar{K} \right) \\
&= 1 - \exp \left( -\bar{D}_{sp} \right).
\end{align} $$

Таким образом, при $\bar{D}_{sp} \geq 0$ значения модифицированной функции TPD в стационарных точках также $D^*_{sp} \geq 0$. Если же $\bar{D}_{sp} < 0$, то и $D^*_{sp} < 0$. То есть модифицированная функция TPD имеет идентичные положения стационарных точек, как и исходная функция TPD, а также сохраняет знак в этих точках. Следовательно, в рамках задачи определения стабильности многокомпонентной системы замена функции TPD $\bar{D} \left( \mathbf{Y} \right)$ на модифицированную $\bar{D}^* \left( \mathbf{Y} \right)$ допустима.
```

Задачу минимизации функции TPD можно решать, используя метод Ньютона, являющийся алгоритмом второго порядка, то есть характеризующийся более быстрой сходимостью, по сравнению с рассмотренным ранее методом последовательных подстановок, относящимся к алгоритмам первого порядка. Для использования метода Ньютона необходимо получить аналитические выражения для вторых частных производных модифицированной функции TPD по основным переменным, формирующих матрицу гессиана $\mathbf{H} \in {\rm I\!R}^{N_c \times N_c}$:

$$ \begin{align}
H_{ij}
&= \frac{\partial^2 \bar{D}^*}{\partial Y_i \partial Y_j} \\
&= \frac{\partial}{\partial Y_j} \left( \frac{\partial \bar{D}^*}{\partial Y_i} \right) \\
&= \frac{\partial}{\partial Y_j} \left( \ln Y_i + \ln \phi_i - h_i \right) \\
&= \frac{\delta_{ij}}{Y_i} + \frac{\partial \ln \phi_i}{\partial Y_j}, \; i = 1 \, \ldots \, N_c, \; j = 1 \, \ldots \, N_c.
\end{align} $$

Аналитические выражения частных производных логарифма коэффициента летучести с использованием уравнений состояния были получены [ранее](../2-EOS/Appendix-A-PD.md).

При этом задача минимизации модифицированной функции $\bar{D}^* \left( \mathbf{Y} \right)$ по-прежнему является условной, поскольку должны рассматриваться значения вектора $\mathbf{Y}$ имеющие физический смысл, то есть $Y_i > 0, \, i = 1 \, \ldots \, N_c$. Для исключения данного условия автором работы \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\] было предложено ввести следующую замену основных переменных:

$$ \alpha_i = 2 \sqrt{Y_i}, \; i = 1 \, \ldots \, N_c. $$

В этом случае значения вектора $\mathbf{Y}$ всегда будут неотрицательными, поскольку $Y_i = \alpha_i^2 \, / \, 4, \, i = 1 \, \ldots \, N_c$. При использовании $\alpha_i, \, i = 1 \, \ldots \, N_c,$ в качестве основных переменных положения стационарных точек модифицированной функции TPD будут определяться равенством нулю частных производных функции по основным переменным:

$$ \begin{align}
\frac{\partial \bar{D}^*}{\partial \alpha_j}
&= \frac{\partial \bar{D}^*}{\partial Y_j} \frac{\partial Y_j}{\partial \alpha_j} \\
&= \left( \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j \right) \frac{\partial}{\partial \alpha_j} \left( \frac{\alpha_j^2}{4} \right) \\
&= \left( \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j \right) \frac{\alpha_j}{2} \\
&= \sqrt{Y_j} \left( \ln Y_j + \ln \phi_j \left( \mathbf{y} \right) - h_j \right), \; j = 1 \, \ldots \, N_c.
\end{align} $$

При этом изменится и аналитическое выражение элемента матрицы гессиана при использовании $\alpha_i, \, i = 1 \, \ldots \, N_c,$ в качестве основных переменных:

$$ \begin{align}
\frac{\partial^2 \bar{D}^*}{\partial \alpha_j \partial \alpha_k}
&= \frac{\partial}{\partial \alpha_k} \left( \frac{\partial \bar{D}^*}{\partial \alpha_j} \right) \\
&= \frac{\partial}{\partial \alpha_k} \left( \sqrt{Y_j} \left( \ln Y_j + \ln \phi_j - h_j \right) \right) \\
&= \left( \ln Y_j + \ln \phi_j - h_j \right) \frac{\partial \sqrt{Y_j}}{\partial \alpha_k} + \sqrt{Y_j} \frac{\partial}{\partial \alpha_k} \left( \ln Y_j + \ln \phi_j - h_j \right) \\
&= \left( \ln Y_j + \ln \phi_j - h_j \right) \frac{1}{2 Y_j} \frac{\partial Y_j}{\partial \alpha_k} + \sqrt{Y_j} \frac{\partial}{\partial Y_k} \left( \ln Y_j + \ln \phi_j - h_j \right) \frac{\partial Y_k}{\partial \alpha_k} \\
&= \frac{1}{2} \delta_{jk} \left( \ln Y_j + \ln \phi_j - h_j \right) + \sqrt{Y_j} \left( \frac{\delta_{jk}}{Y_j} + \frac{\partial \ln \phi_j}{\partial Y_k} \right) \sqrt{Y_k} \\
&= \frac{1}{2} \delta_{jk} \left( \ln Y_j + \ln \phi_j - h_j \right) + \frac{\sqrt{Y_j Y_k} \delta_{jk}}{Y_j} + \sqrt{Y_j Y_k} \frac{\partial \ln \phi_j}{\partial Y_k} \\
&= \frac{1}{2} \delta_{jk} \left( \ln Y_j + \ln \phi_j - h_j \right) + \delta_{jk} + \sqrt{Y_j Y_k} \frac{\partial \ln \phi_j}{\partial Y_k}, \; j = 1 \, \ldots \, N_c, \; k = 1 \, \ldots \, N_c.
\end{align} $$

В процессе получения данного выражения было использовано следующее соотношение: $\sqrt{Y_j Y_k} \delta_{jk} = Y_j \delta_{jk}, \, j = 1 \, \ldots \, N_c, \, k = 1 \, \ldots \, N_c$. То есть в результате поэлементного произведения некоторой матрицы с единичной матрицей получится диагональная матрица с элементами, соответствующими главной диагонали умножаемой матрицы.

При использовании метода Ньютона для решения задачи оптимизации обновление основных переменных $\alpha_i, \, i = 1 \, \ldots \, N_c,$ на $\left( k+1 \right)$-й итерации осуществляется с использованием следующего выражения:

$$ \boldsymbol{\alpha}^{k+1} = \boldsymbol{\alpha}^{k} + \Delta \boldsymbol{\alpha}^{k}, $$

где вектор $\Delta \boldsymbol{\alpha}^{k} \in {\rm I\!R}^{N_c}$ определяется при решении системы линейных уравнений:

$$ \mathbf{H}^{k} \Delta \boldsymbol{\alpha}^{k} = - \mathbf{g}^{k}. $$

Таким образом, алгоритм определения стабильности фазового состояния с использованием метода Ньютона можно представить следующим образом:

```{eval-rst}
.. role:: multilinecomment
    :class: multilinecomment
```

```{admonition} Алгоритм. Анализ стабильности с использованием метода Ньютона
:class: algorithm

**Дано:** Вектор компонентного состава исследуемой системы $\mathbf{z} \in {\rm I\!R}^{N_c}$; термобарические условия $P$ и $T$; необходимые свойства компонентов для нахождения коэффициентов летучести компонентов с использованием уравнения состояния; максимальное число итераций $N_{iter}$; точность решения системы нелинейных уравнений $\epsilon_1$; численная погрешность расчета $0 < \epsilon_2 \leq 10^{-4}$.

**Определить:** Является ли однофазное состояние системы с компонентным составом $\mathbf{z}$ при давлении $P$ и температуре $T$ стабильным.

**Псевдокод:**  
**def** $\phi \left( \mathbf{y} \in {\rm I\!R}^{N_c}, \, \ldots \right) \rightarrow \boldsymbol{\varphi} \in {\rm I\!R}^{N_c}, \, \mathbf{\Phi} \in {\rm I\!R}^{N_c \times N_c}$ {multilinecomment}`# Функция, возвращающая вектор коэффициентов летучести и матрицу их частных производных по количеству вещества компонентов`  
$\mathbf{K} := \left\{ \mathbf{k}_0, \, \mathbf{k}_1, \, \ldots, \, \mathbf{k}_N \right\}$  
$\mathbf{h} := \ln \phi \left( \mathbf{z} \right) + \ln \mathbf{z}$   
**for** $i := 1$ **to** $N$ **do**  
&emsp;$\mathbf{k} := \mathbf{K}\left[ i \right]$  
&emsp;$\mathbf{n} := \mathbf{k} \cdot \mathbf{z}$  
&emsp;$\mathbf{t} := \sqrt{\mathbf{n}}$  
&emsp;$\boldsymbol{\alpha} := 2 \cdot \mathbf{t} $ {comment}`# Вектор основных переменных`  
&emsp;$\mathbf{y} := \mathbf{n} \, / \, \sum_{i=1}^{N_c} n_i$  
&emsp;$\boldsymbol{\varphi}, \, \mathbf{\Phi} := \phi \left( \mathbf{y} \right)$ {comment}`# Расчет вектора коэффициентов летучести и матрицы их частных производных`  
&emsp;$\mathbf{g}' := \ln \mathbf{n} + \ln \boldsymbol{\varphi} - \mathbf{h}$ {comment}`# Вектор невязок`  
&emsp;$\mathbf{g} := \mathbf{t} \cdot \mathbf{g}'$ {comment}`# Градиент модифицированной функции TPD по основным переменным`  
&emsp;$c := 1$  
&emsp;**while** $\lVert \mathbf{g} \rVert_2 > \epsilon_1$ **and** $c < N_{iter}$ **do**  
&emsp;&emsp;$\mathbf{H} := \mathrm{diag} \left( \frac{1}{2} \mathbf{g}' + 1 \right) + \mathbf{t} \mathbf{t}^\top \cdot \mathbf{\Phi}$ {comment}`# Гессиан`  
&emsp;&emsp;$\Delta \boldsymbol{\alpha} := -\mathbf{H}^{-1} \mathbf{g}$ {comment}`# Вектор изменения основных переменных`  
&emsp;&emsp;$\boldsymbol{\alpha} := \boldsymbol{\alpha} + \Delta \boldsymbol{\alpha}$ {comment}`# Обновление вектора основных переменных`  
&emsp;&emsp;$\mathbf{t} := \frac{1}{2} \boldsymbol{\alpha}$  
&emsp;&emsp;$\mathbf{n} := \mathbf{t} \cdot \mathbf{t}$  
&emsp;&emsp;$\mathbf{y} := \mathbf{n} \, / \, \sum_{i=1}^{N_c} n_i$  
&emsp;&emsp;$\boldsymbol{\varphi}, \, \mathbf{\Phi} := \phi \left( \mathbf{y} \right)$ {comment}`# Вектор коэффициентов летучести и матрица их частных производных`  
&emsp;&emsp;$\mathbf{g}' := \ln \mathbf{n} + \ln \boldsymbol{\varphi} - \mathbf{h}$ {comment}`# Вектор невязок`  
&emsp;&emsp;$\mathbf{g} := \mathbf{t} \cdot \mathbf{g}'$ {comment}`# Градиент модифицированной функции TPD по основным переменным`  
&emsp;&emsp;$c := c + 1$  
&emsp;**end while**  
&emsp;$TPD := - \ln \sum_{i=1}^{N_c} n_i$  
&emsp;**if** $\lVert \mathbf{g} \rVert_2 < \epsilon_1$ **and** $TPD < -\epsilon_2$ **then**  
&emsp;&emsp;$is\_stable := \mathrm{False}$  
&emsp;&emsp;**exit for**  
&emsp;**else**  
&emsp;&emsp;**continue**  
&emsp;**end if**  
**else**  
&emsp;$is\_stable := \mathrm{True}$  
**end for**  
```

(pvt-sec-stability-pt-newton-init)=
#### Начальные приближения

Начальные значения вектора $\alpha_i, \, i = 1 \, \ldots \, N_c,$ при использовании метода Ньютона для минимизации функции TPD могут быть получены аналогично способу, рассмотренному [ранее](pvt-sec-stability-pt-ss-init) для метода последовательных подстановок. Однако поскольку метод Ньютона является алгоритмом второго порядка, то [обычно является менее стабильным](https://en.wikipedia.org/wiki/Fixed-point_iteration#Iterative_methods) по сравнению с алгоритмами первого порядка для не полностью выпуклых функций. В связи с этим начальные приближения вектора основных переменных для метода Ньютона, рассчитанные с использованием корреляции Уилсона или другим способом, могут быть уточнены в ходе нескольких итераций метода последовательных подстановок. При этом, например, в работе \[[Hoteit and Firoozabadi, 2006](https://doi.org/10.1002/aic.10908)\] количество итераций метода последовательных подстановок перед переключением на метод Ньютона для анализа стабильности определяется нарушением следующего условия:

$$ \lVert \mathbf{g} \rVert_2 > \epsilon_{ssi}, $$

где $\lVert \mathbf{g} \rVert_2$ – длина вектора невязки, а $\epsilon_{ssi} = 10^{-2}$. Несколько отличное значение параметра $\epsilon_{ssi} = 10^{-1}$ было получено авторами работы \[[Pan et al, 2019](https://doi.org/10.1021/acs.iecr.8b05229)\] при сравнении среднего времени работы алгоритма проверки стабильности на исследуемой выборке термодинамических систем.

Стоит также отметить, что для повышения стабильности (*robustness*) метода Ньютона, особенно в тех случаях, когда начальное приближение неидеально, может быть реализовано переключение итерации на метод последовательных подстановок \[[Nichita, 2016](https://doi.org/10.1016/j.fluid.2016.01.015)\] или на метод оптимизации с доверительной областью \[[Petitfrere and Nichita, 2014](https://doi.org/10.1016/j.fluid.2013.08.039); [Pan et al, 2019](https://doi.org/10.1021/acs.iecr.8b05229)\]. В качестве критерия переключения можно рассматривать увеличение длины вектора градиента оптимизируемой функции (длины вектора невязки решаемой системы нелинейных уравнений) или увеличение значения минимизируемой функции.

(pvt-sec-stability-pt-newton-examples)=
#### Примеры

Рассмотрим применение метода Ньютона для определения стабильности однофазного состояния следующей системы:

````{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси следующего мольного состава:

```{table}
:width: 100%
:widths: "1, 1, 1, 1, 1, 1"
| Компонент | $\mathrm{CH_4}$ | $\mathrm{C_2 H_6}$ | $\mathrm{C_3 H_8}$ | $\mathrm{n \mbox{-} C_4}$ | $\mathrm{C_{5+}}$ |
| :---: | :---: | :---: | :---: | :---: | :---: |
| Мольная доля | 0.7167 | 0.0895 | 0.0917 | 0.0448 | 0.0573 |
```

<br>

Необходимо определить является ли однофазное состояние стабильным при давлении $17 \; МПа$ и температуре $68 \; ^{\circ} C$.
````

````{dropdown} Решение
Зададим исходные термобарические условия и компонентный состав.

``` python
P = 17e6 # Pressure [Pa]
T = 68. + 273.15 # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]
```

Для выполнения вычислений будем использовать свойства компонентов и класс с уравнением состояния, заданные при рассмотрении предыдущего примера. Начальные приближения рассчитаем по корреляции Уилсона:

``` python
ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates
```

Выполним расчет коэффициентов летучести для начального компонентного состава:

``` python
hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)
```

Зададим максимальное число итераций $N_{iter}$, точность решения системы нелинейных уравнений $\epsilon_1$, численную погрешность расчета $\epsilon_2$:

``` python
maxiter = 20 # Maximum number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4
```

Создадим функцию, которая будет принимать на вход кортеж из результатов предыдущей итерации, точность и максимальное число итераций, и возвращать необходимость расчета следующей итерации цикла минимизации:

``` python
def condit_newt(carry, tol, maxiter):
    k, alphai, gi, H = carry
    return k < maxiter and np.linalg.norm(gi) > tol
```

Также создадим функцию, которая будет принимать на вход результаты предыдущей итерации в виде кортежа и рассчитывать результаты для новой итерации. Вектор изменения основных переменных будет определяться путем решения системы линейных уравнений с использованием [`numpy.linalg.solve`](https://numpy.org/doc/stable/reference/generated/numpy.linalg.solve.html).

``` python
def update_newt(carry, hi, plnphi):
    k, alphai_k, gi_k, H_k = carry
    dalphai_k = np.linalg.solve(H_k, -gi_k)
    alphai_kp1 = alphai_k + dalphai_k
    sqrtni = alphai_kp1 * 0.5
    ni = sqrtni * sqrtni
    n = ni.sum()
    xi = ni / n
    lnphixi, Zx, dlnphixidnj = plnphi(yi=xi, n=n)
    gpi_kp1 = np.log(ni) + lnphixi - hi
    gi_kp1 = sqrtni * gpi_kp1
    H_kp1 = np.diagflat(0.5 * gpi_kp1 + 1.) + (sqrtni[:,None] * sqrtni) * dlnphixidnj
    return k + 1, alphai_kp1, gi_kp1, H_kp1
```

Проинициализируем функции `condit` и `update`. Для расчета коэффициентов летучестей и их частных производных по количеству вещества компонентов будем использовать метод `getPT_lnphii_Z_dnj` инициализированного класса с уравнением состояния, принимающий в качестве аргументов давление (в Па), температуру (в K) и компонентный состав в виде одномерного массива (размерностью `(Nc,)`) и возвращающий кортеж с логарифмами коэффициентов летучести компонентов в виде одномерного массива такой же размерности, коэффициентом сверхсжимаемости заданного компонентного состава, а также с матрицей размерностью `(Nc, Nc)`, состоящей из значений частных производных логарифмов коэффициентов летучести компонентов по их количеству вещества:

``` python
pcondit = partial(condit_newt, tol=eps1, maxiter=maxiter)
pupdate = partial(update_newt, hi=hi, plnphi=partial(pr.getPT_lnphii_Z_dnj, P=P, T=T))
```

Выполним расчет функции TPD для различных начальных приближений:

``` python
for i, ki in enumerate(K):
    ni = ki * yi
    sqrtni = np.sqrt(ni)
    alphai = 2. * sqrtni
    n = ni.sum()
    xi = ni / n
    lnphixi, Zx, dlnphixidnj = pr.getPT_lnphii_Z_dnj(P, T, xi, n)
    gpi = np.log(ni) + lnphixi - hi
    gi = sqrtni * gpi
    H = np.diagflat(0.5 * gpi + 1.) + (sqrtni[:,None] * sqrtni) * dlnphixidnj
    carry = (0, alphai, gi, H)
    while pcondit(carry):
        carry = pupdate(carry)
    c, alphai, gi, H = carry
    ni = alphai * alphai * 0.25
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    print(f'For the initial guess #{i}:\n'
          f'\ttolerance of equations: {gnorm}\n'
          f'\tnumber of iterations: {c}\n'
          f'\tk-values: {ni/yi}\n'
          f'\tTPD: {TPD}')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

print(f'The system is stable: {is_stable}')
```

```{glue:} glued_out4
```

По результатам расчетов можно отметить, что подход к определению стабильности фазового состояния системы, основанный на минимизации функции TPD с использованием метода Ньютона, позволяет существенно снизить количество итераций по сравнению методом последовательных подстановок.
````

```{code-cell} python
:tags: [remove-cell]

P = 17e6 # Pressure [Pa]
T = 68. + 273.15 # Temperature [K]
yi = np.array([0.7167, 0.0895, 0.0917, 0.0448, 0.0573]) # Mole fractions [fr.]

ki = Pci * np.exp(5.3727 * (1. + wi) * (1. - Tci / T)) / P # Wilson's correlation
K = np.vstack([ki, 1. / ki]) # Matrix of initial estimates

hi = pr.getPT_lnphii(P, T, yi) + np.log(yi)

maxiter = 20 # Maximum number of iterations
eps1 = 1e-6 # Tolerance
eps2 = 1e-4

def condit_newt(carry, tol, maxiter):
    k, alphai, gi, H = carry
    return k < maxiter and np.linalg.norm(gi) > tol

def update_newt(carry, hi, plnphi):
    k, alphai_k, gi_k, H_k = carry
    dalphai_k = np.linalg.solve(H_k, -gi_k)
    alphai_kp1 = alphai_k + dalphai_k
    sqrtni = alphai_kp1 * 0.5
    ni = sqrtni * sqrtni
    n = ni.sum()
    xi = ni / n
    lnphixi, Zx, dlnphixidnj = plnphi(yi=xi, n=n)
    gpi_kp1 = np.log(ni) + lnphixi - hi
    gi_kp1 = sqrtni * gpi_kp1
    H_kp1 = np.diagflat(0.5 * gpi_kp1 + 1.) + (sqrtni[:,None] * sqrtni) * dlnphixidnj
    return k + 1, alphai_kp1, gi_kp1, H_kp1

pcondit = partial(condit_newt, tol=eps1, maxiter=maxiter)
pupdate = partial(update_newt, hi=hi, plnphi=partial(pr.getPT_lnphii_Z_dnj, P=P, T=T))

out4 = ''

for i, ki in enumerate(K):
    ni = ki * yi
    sqrtni = np.sqrt(ni)
    alphai = 2. * sqrtni
    n = ni.sum()
    xi = ni / n
    lnphixi, Zx, dlnphixidnj = pr.getPT_lnphii_Z_dnj(P, T, xi, n)
    gpi = np.log(ni) + lnphixi - hi
    gi = sqrtni * gpi
    H = np.diagflat(0.5 * gpi + 1.) + (sqrtni[:,None] * sqrtni) * dlnphixidnj
    carry = (0, alphai, gi, H)
    while pcondit(carry):
        carry = pupdate(carry)
    c, alphai, gi, H = carry
    ni = alphai * alphai * 0.25
    TPD = -np.log(ni.sum())
    gnorm = np.linalg.norm(gi)
    out4 += (f'For the initial guess #{i}:\n'
             f'\ttolerance of equations: {gnorm}\n'
             f'\tnumber of iterations: {c}\n'
             f'\tk-values: {ni/yi}\n'
             f'\tTPD: {TPD}\n')
    if gnorm < eps1 and TPD < -eps2:
        is_stable = False
        break
else:
    is_stable = True

out4 += f'The system is stable: {is_stable}'

glue('glued_out4', MultilineText(out4))

```

В данном примере начальные приближения рассчитывались с использованием корреляции Уилсона. Пример реализации алгоритма определения стабильности фазового состояния системы, основанного на применении метода последовательных подстановок для уточнения начальных приближений, представлен [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/stability.py).

Кроме того, важно отметить, что метод Ньютона для оптимизации функции нескольких переменных [сходится к ее локальному минимуму](../../0-Math/1-OM/OM-0-Introduction.md), если матрица гессиана является [положительно определенной матрицей](../../0-Math/0-LAB/LAB-8-MatrixDefiniteness.md), то есть если функция является выпуклой для всех значений вектора основных переменных, что в общем не свойственно для рассматриваемой модифицированной функции TPD, за исключением локальных областей вблизи стационарных точек, что обуславливает и подтверждает необходимость наличия хорошего начального приближения. Однако на практике начальные приближения не гарантируют положительную определенность матрицы гессиана в этой точке. Для решения этой проблемы могут применяться различные подходы. Одним из таких является использование модифицированного разложения Шолески для нахождения вектора изменения основных переменных, позволяющего определить такую диагональную матрицу $\mathbf{E}$, элементы которой не на много больше, чем необходимо, чтобы матрица $\hat{\mathbf{H}}$, определяемая выражением:

$$ \hat{\mathbf{H}} = \mathbf{H} + \mathbf{E}, $$

являлась положительно определенной матрицей. Примеры алгоритмов модифицированного разложения Шолески рассмотрены в работах \[[Schnabel and Eskow, 1990](https://doi.org/10.1137/0911064)\] и \[[Schnabel and Eskow, 1999](https://doi.org/10.1137/S105262349833266X)\].

Другим подходом к решению данной проблемы является использование аппроксимации гессиана на основе результатов предыдущих итераций, которая гарантирует положительную определенность. Такой подход лежит в основе квази-ньютоновских методов оптимизации, к которым относится, например, метод [BFGS](https://en.wikipedia.org/wiki/Broyden%E2%80%93Fletcher%E2%80%93Goldfarb%E2%80%93Shanno_algorithm). Применение данного метода к определению стабильности фазового состояния системы было рассмотрено в работе \[[Michelsen, 1982](https://doi.org/10.1016/0378-3812(82)85001-2)\]. Впоследствии применение метода BFGS для решения данной задачи получило свое развитие в работах \[[Hoteit and Firoozabadi, 2006](https://doi.org/10.1002/aic.10908); [Nichita and Petitfrere, 2015](https://doi.org/10.1016/j.fluid.2015.07.035)\].

Кроме того, коррекция гессиана для обеспечения его положительной определенности реализуется при использовании методов оптимизации с доверительной областью \[[Petitfrere and Nichita, 2014](https://doi.org/10.1016/j.fluid.2013.08.039)\].

(pvt-sec-stability-vt)=
## VT-термодинамика

Таким образом, в данном разделе были получены критерии стабильности для различных формулировок, а также рассмотрены некоторые численные алгоритмы проверки стабильности фазового состояния. [Следующие разделы](SEC-2-RR.md) будут посвящены изучению уравнения Речфорда-Райса (уравнения фазовых концентраций).
