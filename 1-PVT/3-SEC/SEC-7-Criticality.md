---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 3.0.1
    jupytext_version: 1.16.3
kernelspec:
  display_name: Python 3 (ipykernel)
  language: python
  name: python3
---

(pvt-esc-criticality)=
# Определение критического состояния системы

Предыдущие разделы были посвящены различным задачам многофазной многокомпонентной термодинамики, а именно вопросам [стабильности](SEC-1-Stability.md) фазового состояния, расчету [равновесного](SEC-5-Equilibrium.md) состояния, а также методам определения [предельно насыщенных](SEC-6-Saturation.md) состояний. Данный раздел является заключительным среди разделов, посвященных теоретическим аспектам PVT-моделирования. Он будет затрагивать методологические и алгоритмические аспекты нахождения критического состояния многокомпонентной системы.

Данная заключительная проблема, как и все предыдущие, достаточно хорошо изучена на теоретическом и практическом уровнях. Впервые термодинамические условия существования критического состояния были получены [Гиббсом](https://en.wikisource.org/wiki/Page%3AScientific_Papers_of_Josiah_Willard_Gibbs.djvu/165). Среди последующих работ, посвященных численным методам определения критического состояния многокомпонентной системы, необходимо отметить следующие \[[Peng and Robinson, 1977](https://doi.org/10.1002/aic.690230202), [Heidemann and Khalil, 1980](https://doi.org/10.1002/aic.690260510), [Michelsen, 1980](https://doi.org/10.1016/0378-3812(80)80001-X), [Michelsen and Heidemann, 1981](https://doi.org/10.1002/aic.690270326); [Michelsen, 1984](https://doi.org/10.1016/0378-3812(84)85021-9)\].

````{margin}
```{admonition} Дополнительно
Под критической состоянием понимается такое состояние системы, где исчезает различие между двумя фазами. Для однокомпонентных систем такое состояние представляет собой точку, то есть, согласно [правилу фаз Гиббса](../1-TD/TD-11-GibbsPhaseRule.md), необходимо знать два параметра (например, давление и температуру), чтобы определить критическое состояние такой системы. Для двухкомпонентной системы количество степеней свободы будет равно трем, то есть такая система будет характеризоваться линией из критических состояний, каждое из которых соответствует своему компонентному составу, ограниченной с двух концов критическими точками чистых компонентов.
```
````

```{admonition} Определение
:class: tip
Под ***критическим состоянием*** многокомпонентной системы заданного состава понимается такое состояние, при котором этот состав и находящаяся с ним в равновесии фаза(ы) характеризуются одинаковыми компонентными составами и плотностями.
```

Однако, прежде чем переходить к рассмотрению алгоритма определения критического состояния многокомпонентной системы, необходимо сформулировать условия нахождения системы в критическом состоянии. Сразу отметим, что предположительно известные читателям выражения:

$$ \begin{align}
T_c &= \sum_{i=1}^{N_c} {T_c}_i y_i, \\
P_c &= \sum_{i=1}^{N_c} {P_c}_i y_i, \; i = 1 \, \ldots \, N_c,
\end{align} $$

где ${T_c}_i, \, {P_c}_i$ – критические свойства компонентов, $y_i$ – мольная доля $i$-го компонента в системе, представляют собой способ вычисления *псевдокритических* температуры и давления многокомпонентной системы, при которых система, на самом деле, может находиться в многофазном состоянии. Рассмотрим следующий пример.

```{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси из метана и диоксида углерода с мольной долей метана $0.1$. Необходимо определить состояние системы при псевдокритических давлении и температуре.
```

Для решения данной задачи будем использовать [уравнение состояние Пенга-Робинсона](../2-EOS/EOS-2-SRK-PR.md) и его [реализацию](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/eos.py). Кроме того, для проверки стабильности системы будет применяться метод QNSS, алгоритм которого был рассмотрен [ранее](SEC-1-Stability.md), реализованный [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/stability.py). Для расчета [равновесного состояния](SEC-5-Equilibrium.md) – также метод QNSS и его [реализацию](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/flash.py).

```{code-cell} python
import sys
sys.path.append('../../_src/')
import numpy as np
from matplotlib import pyplot as plt
from eos import pr78
from stability import stabilityPT
from flash import flash2pPT
```

Универсальная газовая постоянная:

```{code-cell} python
R = np.float64(8.3144598)
```

Зададим свойства компонентов и инициализируем класс с уравнением состояния:

```{code-cell} python
Pci = np.array([7.37646e6, 4.600155e6]) # Critical pressures [Pa]
Tci = np.array([304.2, 190.6]) # Critical temperatures [K]
wi = np.array([.225, .008]) # Acentric factors
mwi = np.array([0.04401, 0.016043]) # Molar mass [kg/gmole]
vsi = np.array([0., 0.]) # Volume shift parameters
dij = np.array([.025]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Зададим компонентный состав и выполним расчет псевдокритических давления и температуры:

```{code-cell} python
yi = np.array([.9, .1])
P = yi.dot(Pci)
T = yi.dot(Tci)
print(f'Pcmix = {P / 1e6} MPa, Tcmix = {T - 273.15} C')
```

Выполним проверку стабильности равновесного состояния:

```{code-cell} python
stab = stabilityPT(pr, method='qnss')
stabres = stab.run(P, T, yi)
stabres
```

Однофазное состояние системы является нестабильным. Выполним расчет двухфазного равновесного состояния:

```{code-cell} python
flash = flash2pPT(pr, stabmethod='qnss', flashmethod='qnss')
flashres = flash.run(P, T, yi)
flashres
```

Определим плотности фаз:

```{code-cell} python
vj = flashres.Zj * R * T / P
denj = flashres.yji.dot(mwi) / vj
print(f'Phase densities: {denj} kg/m3')
```

Таким образом, при псевдокритических давлении и температуре рассматриваемая система представляет собой двухфазную систему, следовательно, эти термобарические условия не соответствуют определению критического состояния системы.

Рассмотрим следующий пример. Пусть имеется вода при атмосферном давлении и температуре, например, $80 \, ^{\circ} C$. Если мы будем изобарно подводить к такой системе тепло, то мы ожидаем, что в определенный момент, а именно при температуре $100 \, ^{\circ} C$, начнется процесс фазового перехода – парообразование. Однако если бы мы могли подавить все центры нуклеации, то вполне можно было бы нагревать сплошную жидкую фазу и несколько выше температуры кипения. Такое состояние системы при температуре, превышающей, но близкой к температуре кипения, можно назвать перегретой жидкостью и является *метастабильным*.

```{admonition} Определение
:class: tip
***Метастабильным состоянием*** системы называется состояние, являющееся устойчивым по отношению к небольшим возмущениям, но при достаточно больших изменениях термодинамических параметров нарушается, что сопровождается фазовым переходом в абсолютно стабильное состояние, характеризующееся глобальным минимумом [термодинамического потенциала](https://en.wikipedia.org/wiki/Thermodynamic_potential).
```

При дальнейшем увеличении температуры все легче было бы появляться центрам нуклеации и начаться процессу самопроизвольного фазового перехода. Существование метастабильных состояний было экспериментально подтверждено в 19 веке. Однако существуют границы существования метастабильного состояния, определяемые, с одной стороны, линией двухфазной области *(бинодалью)*, с другой – линией нестабильной области *(спинодалью)*. На рисунке ниже представлена $Pv$-диаграмма метана, построенная с использованием [уравнения состояния Ван-дер-Ваальса](../2-EOS/EOS-1-VanDerWaals.md).

```{code-cell} python
:tags: [remove-input]

R = 8.3144598

Tc = 190.6
Pc = 4.600155e6
b = 0.125 * R * Tc / Pc
a = (27 / 64) * R * R * Tc * Tc / Pc
vc = 3. * b

eos = lambda v, T, a, b: R * T / (v - b) - a / (v * v)

def cardano(b, c, d):
    p = (3. * c - b * b) / 3.
    q = (2. * b * b * b - 9. * b * c + 27. * d) / 27.
    s = q * q * .25 + p * p * p / 27.
    if s >= 0.:
        s_ = np.sqrt(s)
        u1 = np.cbrt(-q * .5 + s_)
        u2 = np.cbrt(-q * .5 - s_)
        return u1 + u2 - b / 3.
    else:
        t0 = 2. * np.sqrt(-p / 3.) * np.cos(np.arccos(1.5 * q * np.sqrt(-3. / p) / p) / 3.)
        x0 = t0 - b / 3.
        r = b + x0
        k = -d / x0
        D = np.sqrt(r * r - 4. * k)
        x1 = (-r + D) * .5
        x2 = (-r - D) * .5
        return x0, x1, x2

def Psat(T, a, b, tol=1e-5, Niter=50):
    vmax, vmin, _ = cardano(-2. * a / (R * T), 4. * a * b / (R * T), -2. * a * b**2 / (R * T))
    # print(f'{vmin = }, {vmax = }')
    Pmin = eos(vmin, T, a, b)
    Pmax = eos(vmax, T, a, b)
    # print(f'{Pmin = },{Pmax = }')
    if Pmin < 0.:
        Pk = Pmax / 2.
    else:
        Pk = (Pmin + Pmax) / 2.
    A = a * Pk / (R**2 * T**2)
    B = b * Pk / (R * T)
    Zv, _, Zl = cardano(-1. - B, A, -A * B)
    lnphiv = - np.log(Zv - B) + B / (Zv - B) - 2. * A / Zv
    lnphil = - np.log(Zl - B) + B / (Zl - B) - 2. * A / Zl
    g = lnphiv - lnphil
    k = 0
    # print(f'Iteration #{k}:\n{Pk = }\n{g = }\n')
    while (np.abs(g) > tol) & (k < Niter):
        Pkp1 = Pk * np.exp(-g)
        if Pkp1 > Pmax:
            Pk = (Pk + Pmax) / 2.
        elif Pkp1 < Pmin:
            Pk = (Pk + Pmin) / 2.
        else:
            Pk = Pkp1
        k += 1
        A = a * Pk / (R**2 * T**2)
        B = b * Pk / (R * T)
        Zv, _, Zl = cardano(-1. - B, A, -A * B)
        lnphiv = - np.log(Zv - B) + B / (Zv - B) - 2. * A / Zv
        lnphil = - np.log(Zl - B) + B / (Zl - B) - 2. * A / Zl
        g = lnphiv - lnphil
        # print(f'Iteration #{k}:\n{Pk = }\n{g = }\n')
    vv = Zv * R * T / Pk
    vl = Zl * R * T / Pk
    return Pk, vl, vv, Pmin, vmin, Pmax, vmax

TT = np.linspace(80., Tc, 100, endpoint=True)

fig1, ax1 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
Psats = []
vls = []
vvs = []
Pmins = []
Pmaxs = []
vmins = []
vmaxs = []
for i, T in enumerate(TT):
    if T < Tc:
        Ps, vl, vv, Pmin, vmin, Pmax, vmax = Psat(T, a, b)
        # print(f'{T = }: {Ps = }, {vl = }, {vv = }')
        Psats.append(Ps)
        vls.append(vl)
        vvs.append(vv)
        Pmins.append(Pmin)
        Pmaxs.append(Pmax)
        vmins.append(vmin)
        vmaxs.append(vmax)
    if i % 80 == 0 and i > 0:
        vs = np.power(10., np.linspace(np.log10(b*1.2), np.log10(1e-1), 500, endpoint=True))
        PP = R * T / (vs - b) - a / (vs * vs)
        ax1.plot(vs * 1e3, PP / 1e6, lw=1., c='k', zorder=2, label=f'Изотерма {T = :.2f} K')
        vs = np.linspace(vl, vv, 100, endpoint=True)
        Peos = R * T / (vs - b) - a / (vs * vs)
        PsPs = np.full_like(Peos, Ps)
        ax1.fill_between(vs * 1e3, Peos / 1e6, PsPs / 1e6, label='Правило Максвелла', zorder=2, fc='lime', ec='g', alpha=0.2)
Psats.append(Pc)
vls.append(vc)
vvs.append(vc)
Pmins.append(Pc)
Pmaxs.append(Pc)
vmins.append(vc)
vmaxs.append(vc)
Psats = np.array(Psats)
vls = np.array(vls)
vvs = np.array(vvs)
Pmins = np.array(Pmins)
Pmaxs = np.array(Pmaxs)
vmins = np.array(vmins)
vmaxs = np.array(vmaxs)
ax1.plot(vls * 1e3, Psats / 1e6, lw=2., c='c', zorder=3, label='Линия насыщения')
ax1.plot(vvs * 1e3, Psats / 1e6, lw=2., c='m', zorder=3, label='Линия конденсации')
ax1.plot(vmins * 1e3, Pmins / 1e6, lw=2., ls='--', c='c', zorder=3, label='Линия перегретой жидкости')
ax1.plot(vmaxs * 1e3, Pmaxs / 1e6, lw=2., ls='--', c='m', zorder=3, label='Линия переохлажденного пара')
ax1.plot(vc * 1e3, Pc / 1e6, 'o', lw=0., c='r', zorder=4, label='Критическая точка')
ax1.annotate('', (0.2, 4.), (0.13, 7.), arrowprops={'arrowstyle': '->', 'color': 'dimgrey'}, ha='center')
ax1.annotate('', (0.09, 4.), (0.13, 7.), arrowprops={'arrowstyle': '->', 'color': 'dimgrey'}, ha='center')
ax1.text(0.13, 7.1, 'Бинодаль', ha='center', fontsize=9)
ax1.annotate('', (0.29, 1.9), (0.18, 1.), arrowprops={'arrowstyle': '->', 'color': 'dimgrey'}, ha='center')
ax1.annotate('', (0.09, 1.9), (0.18, 1.), arrowprops={'arrowstyle': '->', 'color': 'dimgrey'}, ha='center')
ax1.text(0.18, 0.8, 'Спинодаль', ha='center', fontsize=9)
ax1.set_xlabel('Молярный объем, л/моль')
ax1.set_ylabel('Давление, МПа')
ax1.set_xlim(0., 0.6)
ax1.set_ylim(0., 8.)
ax1.set_yticks(np.linspace(0., 8., 5, endpoint=True))
ax1.legend(loc=1, fontsize=9)
ax1.grid(zorder=1)
```

На данной диаграмме можно выделить несколько регионов (при рассмотрении слева направо). Слева от линии насыщения и до критического объема – область стабильной жидкой фазы. Между линией насыщения и спинодалью находится область перегретой жидкости, представляющей собой метастабильное состояние. Область, ограниченная спинодалью, является нестабильной *(нефизичной)* областью, что обуславливается отрицательной изотермической сжимаемостью в данном регионе (то есть с увеличением давления происходит увеличение молярного объема $\left( \frac{\partial P}{\partial v} \right)_{T,n} > 0$). Затем от линии спинодали и до линии конденсации находится область переохлажденного газа, которая также является метастабильной. Наконец, от линии конденсации начинается область стабильной газовой фазы. При этом линия спинодали определеяется условием $\left( \frac{\partial P}{\partial v} \right)_{T,n} = 0$. Напомним, что линия бинодали является геометрическим местом точек с [равными химическими потенциалами фаз](../1-TD/TD-14-PhaseEquilibrium.md), иными словами, определяется выражением $\mu \left( v_l, \, T \right) = \mu \left( v_v, \, T \right)$. Другим подходом к расчету значений молярных объемов жидкой и газовой фаз на линиях насыщения и конденсации соответственно является [правило Максвелла](https://en.wikipedia.org/wiki/Maxwell_construction), устанавливающее равенство между площадьми под и над горизонтальной прямой, соединяемой эти значения.

Проанализируем, зависимость потенциальной энергии на примере энергии Гельмгольца от молярного объема:

```{code-cell} python
:tags: [remove-input]

T = 169.37
Ps, vl, vv, Pmin, vmin, Pmax, vmax = Psat(T, a, b)

# lnf = lambda v, T, a, b: v / (v - b) - np.log(v - b) - 2. * a / (R * T * v)
lnf = lambda v, T, a, b: -np.log(v - b) - a / (R * T * v)
vref = 6e-4
lnfref = lnf(vref, T, a, b)
Fref = 0.
helm = lambda v, T, a, b: Fref + lnf(v, T, a, b) - lnfref

vs = np.power(10., np.linspace(np.log10(b*1.2), np.log10(1e-1), 500, endpoint=True))
FF = helm(vs, T, a, b)

Fl = helm(vl, T, a, b)
Fv = helm(vv, T, a, b)
Fmin = helm(vmin, T, a, b)
Fmax = helm(vmax, T, a, b)

tt = Fl + (-1. / (vl - b) + a / (R * T * vl * vl)) * (vs - vl)

fig2, ax2 = plt.subplots(1, 1, figsize=(6., 4.), tight_layout=True)
ax2.plot(vs * 1e3, FF, lw=2., c='y', zorder=2, label=r'$\bar{F} \left( v, \, T=169.37 \, K \right)$')
ax2.plot(vs * 1e3, tt, lw=1., c='k', zorder=2, label='Касательная')
ax2.plot(vl * 1e3, Fl, 'o', lw=0., c='c', zorder=3, label='Точка насыщения')
ax2.plot(vv * 1e3, Fv, 'o', lw=0., c='m', zorder=3, label='Точка кипения')
ax2.plot(vmin * 1e3, Fmin, 'o', lw=0., mec='c', mfc='none', zorder=3, label='Точка перегретой жидкости')
ax2.plot(vmax * 1e3, Fmax, 'o', lw=0., mec='m', mfc='none', zorder=3, label='Точка переохлажденного пара')
ax2.set_xlabel('Молярный объем, л/моль')
ax2.set_xlim(0., 0.6)
ax2.set_ylabel('Приведенная энергия Гельмгольца\n' + r'$\bar{F} = F \, / \, (n R T)$')
ax2.set_ylim(0.2, 1.1)
ax2.legend(loc=1, fontsize=9)
ax2.grid(zorder=1)
```

Касательная, проведенная к функции энергии Гельмгольца в точках насыщения и конденсации, по сути, показывает значения термодинамического потенциала в случае двухфазной формулировки. Напомним, поскольку энергия Гельмгольца является [экстенсивным параметром](../1-TD/TD-9-Observables.md), то для многофазной системы значение термодинамического потенциала определяется средневзвешиванием на мольные доли фаз $f_j, \, j = 1 \, \ldots \, N_p,$ то есть $\bar{F} = \sum_j \bar{F}_j f_j$. Таким образом, для двухфазной формулировки рассматриваемой системы значение термодинамического потенциала характеризуется меньшим значением, чем в однофазной формулировке, поэтому на данном отрезке двухфазное состояние является абсолютно стабильным состоянием.

````{margin}
```{admonition} Дополнительно
Стоит отметить, что если критическая точка соответствует состоянию системы, при котором исчезает различие между двумя фазами, то существует такое состояние, называемое [*трикритическим*](https://en.wikipedia.org/wiki/Tricritical_point), при котором исчезает различие между тремя фазами. Согласно [правилу фаз Гиббса](../1-TD/TD-11-GibbsPhaseRule.md), трикритическое состояние возможно только для систем с количеством компонентов больше двух. Численные алгоритмы определения таких состояний не будут рассматриваться в рамках данного раздела. Подробнее с ними можно ознакомиться в работах \[[Michelsen and Heidemann, 1988](https://doi.org/10.1016/0378-3812(88)80003-7); [Kohse and Heidemann, 1993](https://doi.org/10.1002/aic.690390714)\].
```
````

[Правило фаз Гиббса](../1-TD/TD-11-GibbsPhaseRule.md) позволяет установить, какое количество соотношений (равное количеству степеней свободы) необходимо для однозначного определения критической точки. Так, например, однокомпонентная система в критической точке, где исчезает различие между фазами, иными словами, система становится однофазной, характеризуется двумя степенями свободы, то есть положение критической точки определяется двумя соотношениями. Для многокомпонентной системы с заданными $N_c  - 1$ мольными долями компонентов также необходимо два соотношения для однозначного определения критической точки. Поскольку критическая точка принадлежит спинодали, то есть соответствует ее уравнению, то уравнение для спинодали является одним из необходимых соотношений для определения критической точки. Подробнее остановимся на получении данных соотношений для многокомпонентных систем.

Рассмотрим функцию термодинамического потенциала (в данном случае будем рассматривать на примере энергии Гельмгольца, однако использование других потенциальных энергий, например, [внутренней энергии](../1-TD/TD-3-Heat-Work.md) или [энергии Гиббса](../1-TD/TD-8-Helmholtz-Gibbs.md#pvt-td-helmholtzgibbs-gibbs) также допустимо). Для каждой из фаз многокомпонентной системы энергию Гельмгольца $F$ можно представить как функцию от параметров (объема $V$, температуры $T$, количества вещества компонентов $n_i, \, i = 1 \, \ldots \, N_c - 1,$ а также количества вещества фазы $n$) каждой из фаз соответственно:

$$ F = F \left( V, \, T, \, n_1, \, n_2, \, \ldots \, n_{N_c-1}, \, n \right). $$

````{margin}
```{admonition} Дополнительно
Допущение об отсутствии зависимости термодинамического потенциала от размеров системы не является универсальным и перестает работать для мелкодисперсных систем, где играет существенную роль поверхностное натяжение, или, наоборот, для массивных тел (например, звезд), при рассмотрении которых необходимо учитывать влияние гравитации.
```
````

Допуская, что стабильность каждой из фаз является внутренним свойством самой фазы, то есть принимая отсутствие зависимости термодинамических потенциалов от количества вещества системы, дифференциал энергии Гельмгольца записывается следующим образом:

$$ \begin{align}
dF
&= \frac{\partial F}{\partial V} \mathrm{d} V + \frac{\partial F}{\partial T} \mathrm{d} T + \sum_{i=1}^{N_c-1} \frac{\partial F}{\partial n_i} \mathrm{d} n_i \\
&= -P \mathrm{d} V - S \mathrm{d} T + \sum_{i=1}^{N_c-1} \mu_i \mathrm{d} n_i \\
&= \sum_{k=1}^r p_k \zeta_k.
\end{align} $$

Обозначим вектором $\mathbf{x} = \left( V, \, T, \, n_1, \, n_2, \, \ldots \, n_{N_c-1} \right)^\top$ набор независимых термодинамических параметров, а вектором $\mathbf{p} = \left( -P, \, -S, \, \mu_1, \, \mu_2, \, \ldots \, \mu_{N_c-1} \right)^\top$ – набор коэффициентов перед их дифференциалами в представленном выше выражении, равные частным производным термодинамического потенциала по соответствующим параметрам. Причем $\mathbf{x} \in {\rm I\!R}^r, \, \mathbf{p} \in {\rm I\!R}^r, \, r = N_c + 1$. Тогда $\zeta_i = \delta x_i$ будем называть мнимым изменением *(virtual displacement)* $i$-го термодинамического параметра системы.

Здесь также необходимо пояснить, что под *мнимым изменением* термодинамического параметра понимается его изменение в ***мнимом процессе***. Грубо говоря, под равновесным состоянием системы можно понимать такое состояние, при котором с этой системой ничего не происходит. При этом в процессе достижения такого состояния, *релаксации*, энтропия достигает своего максимума, то есть изменение энтропии положительно $\Delta S > 0$. Для мнимных процессов характерно $\Delta S < 0$. Иными словами, под мнимым изменением $i$-го термодинамического параметра $\delta x_i$ понимается локальные и произвольные его вариации (флуктуации), не приводящие к формированию нового равновесного состояния. Например, зафиксировав количество вещества (массу) изолированной системы, мы можем допустить наличие локальной произвольной вариации концентрации компонентов различной молекулярной массы (плотности), например, вследствие стохастического движения молекул.

Пусть рассматриваемая многофазная и многокомпонентная система является изолированной и находится в равновесном состоянии. Тогда все мнимые процессы, протекающие в системе, должны характеризоваться отрицательным изменением энтропии (положительным изменением термодинамических потенциалов). Следовательно, энергия Гельмгольца в окрестности равновесного состояния может быть разложена в [ряд Тейлора](https://en.wikipedia.org/wiki/Taylor_series):

$$ \begin{align}
\Delta F
&= \delta F + \frac{1}{2} \delta^2 F + \frac{1}{6} \delta^3 F + \ldots,
\end{align} $$

где:

$$ \begin{align}
\delta F &= \sum_{k=1}^r \frac{\partial F}{\partial x_k} \delta x_k = \sum_{k=1}^r p_k \zeta_k, \\
\delta^2 F &= \sum_{k=1}^r \sum_{l=1}^r \frac{\partial^2 F}{\partial x_k \partial x_l} \delta x_k \delta x_l = \sum_{k=1}^r \sum_{l=1}^r p_{kl} \zeta_k \zeta_l, \\
\delta^3 F &= \sum_{k=1}^r \sum_{l=1}^r \sum_{m=1}^r \frac{\partial^3 F}{\partial x_k \partial x_l \partial x_m} \delta x_k \delta x_l \delta x_m = \sum_{k=1}^r \sum_{l=1}^r \sum_{m=1}^r p_{klm} \zeta_k \zeta_l \zeta_m.
\end{align} $$

Поскольку рассматривается мнимый процесс для системы в равновесии, то $\delta F = 0$ является [необходимым условием](SEC-1-Stability.md) нахождения системы в равновесном состоянии. Тогда в общей сложности необходимыми и достаточными условиями для описания мнимых процессов $\left( \Delta F > 0 \right)$ в равновесной системе являются:

$$ \begin{align}
\delta F &= 0 && \mathrm{and} \\
\delta^2 F & > 0 && \mathrm{but \, if} = 0, \, \mathrm{then} \\
\delta^3 F & > 0 && \mathrm{but \, if} = 0, \, \mathrm{then} \, \ldots \; \mathrm{until} \, \delta^m F > 0.
\end{align} $$

Кроме того, принцип изолированности рассматриваемой системы можно сформулировать в виде следующих выражений (на примере двухфазной постановки):

$$ \begin{align}
x_k^{\left( 1 \right)} + x_k^{\left( 2 \right)} &= \mathrm{const}, \\
\delta x_k^{\left( 1 \right)} + \delta x_k^{\left( 2 \right)} &= 0, \\
\zeta_k^{\left( 1 \right)} + \zeta_k^{\left( 2 \right)} &= 0, \, k = 1 \, \ldots \, r.
\end{align} $$

Подробнее остановимся на первых двух слагаемых в разложении функции энергии Гельмгольца. Квадратратичный элемент представленного выше разложения является доминирующим, принимая во внимание природу малых *мнимых* изменений термодинамических параметров. При этом одним из сформулированных выше условий для описания мнимого процесса является:

$$ \delta^2 F > 0 \Leftrightarrow \sum_{k=1}^r \sum_{l=1}^r \frac{\partial^2 F}{\partial x_k \partial x_l} \delta x_k \delta x_l > 0 \Leftrightarrow \mathbf{\zeta}^\top \mathbf{Q} \mathbf{\zeta} > 0, $$

где $\mathbf{Q} \in {\rm I\!R}^{r \times r}$ представляет собой матрицу вторых частных производных термодинамического потенциала по независимым параметрам системы, а вектор $\mathbf{\zeta} \in {\rm I\!R}^r$ представляет собой вектор мнимых изменений термодинамических параметров, удовлетворяющих условию изолированности. Следовательно, матрица $\mathbf{Q}$ является [положительно определенной матрицей](../../0-Math/LAB-8-MatrixDefiniteness.md), то есть наименьшее ее собственное значение должно быть положительным:

$$ \lambda_{min} > 0. $$

Поскольку определитель матрицы [равен](https://en.wikipedia.org/wiki/Determinant#Eigenvalues_and_characteristic_polynomial) произведению собственных значений, то граница метастабильной области (спинодаль) определяется следующим выражением:

$$ \det \left( \mathbf{Q} \right) = 0. $$

Равенство нулю определителя матрицы $\mathbf{Q}$ означает, что такая матрица является [*вырожденной*](https://en.wikipedia.org/wiki/Invertible_matrix#Properties) (строки или столбцы такой матрицы линейно зависимы). Одним из свойств вырожденных матриц является наличие нетривиального $\left( \mathbf{\zeta} \neq 0 \right)$ решения уравнения $\mathbf{Q} \mathbf{\zeta} = 0$. Кроме того, поскольку $\lambda_{min} = 0$, то [ранг](https://en.wikipedia.org/wiki/Rank_(linear_algebra)) матрицы $\mathbf{Q}$ уменьшается с $r$ до $r-1$, то есть имеется $r-1=N_c$ независимых термодинамических параметров.

Для однокомпонентной системы, находящейся в изотермическом процессе с постоянным количеством вещества, представленное выше условие можно преобразовать следующим образом:

$$ \begin{align}
\delta^2 F & > 0, \\
\sum_{k=1}^r \sum_{l=1}^r \frac{\partial^2 F}{\partial x_k \partial x_l} \delta x_k \delta x_l & > 0, \\
\left( \frac{\partial^2 F}{\partial V^2} \right)_{T,n} \delta^2 V  & > 0, \\
\left( \frac{\partial^2 F}{\partial V^2} \right)_{T,n} & > 0, \\
-\left( \frac{\partial P}{\partial V} \right)_{T,n} & > 0, \\
\left( \frac{\partial P}{\partial V} \right)_{T,n} & < 0. \\
\end{align} $$

Таким образом, для участков изотермы однокомпонентной системы, характеризующихся отрицательным значением производной давления по объему, характерно протекаение *мнимых процессов*, не приводящих к формированию нового термодинамического состояния. А участки изотермы, характеризующиеся положительным значением производной давления по объему, являются нестабильными.

Если вернуться к $Pv$-диаграмме для метана, можно отметить, что критическая точка не просто лежит на спинодали, определяемой условием $\left( \frac{\partial P}{\partial v} \right)_{T,n} = 0$, но и находится в ее максимуме (экстремуме), для которого справедливо $\left( \frac{\partial^2 P}{\partial v^2} \right)_{T,n} = 0$, или же с точки зрения изменения энергии Гельмгольца $\delta^3 F = 0$. Данное условие также можно получить, если рассматривать критическое равновесное состояние системы, при котором изменение энергии Гельмгольца вследствие мнимых процессов $\Delta F > 0$ с учетом условия стабильности $\delta^2 F = 0$ и принимая во внимание [нечетность](https://en.wikipedia.org/wiki/Even_and_odd_functions) функции $\delta^3 F$. Таким образом, система уравнений:

$$ \begin{cases}
\det \left( \mathbf{Q} \right) = 0, \\
\delta^3 F = 0,
\end{cases} $$

может быть использована для определения объема (или давления, если в качестве термодинамического потенциала рассматривать энергию Гиббса) и температуры системы известного компонентного состава в критической точке. Решение аналогичной системы нелинейных уравнений было предложено авторами работы \[[Heidemann and Khalil, 1980](https://doi.org/10.1002/aic.690260510)\] для нахождения параметров термодинамической системы в критическом состоянии. В качестве термодинамических параметров, относительно которых считаются матрица $\mathbf{Q}$ и величина $\delta^3 F$, удобно использовать количества вещества компонентов, следовательно, одной из основных сложностей в алгоритме расчета критического состояния системы является расчет частных производных термодинамического потенциала по количеству вещества компонентов. Аналитические выражения частных производных логарифмов коэффициентов летучести компонентов с использованием кубических уравнений состояния были получены [ранее](../2-EOS/EOS-Appendix-A-PD.md). Кроме того, частные производные логарифмов коэффициентов летучести компонентов могут быть получены с использованием средств [автоматического дифференцирования](https://en.wikipedia.org/wiki/Automatic_differentiation) при использовании, например, библиотеки [JAX](https://jax.readthedocs.io/en/latest/index.html). Численный подход для расчета $\delta^3 F$ был предложен в работе \[[Michelsen, 1980](https://doi.org/10.1016/0378-3812(80)80001-X)\]:

$$ \begin{align}
\delta^3 F
&= \sum_{k=1}^{r-1} \sum_{l=1}^{r-1} \sum_{m=1}^{r-1} \frac{\partial^3 F}{\partial x_k \partial x_l \partial x_m} \zeta_k \zeta_l \zeta_m \\
&= \sum_{k=1}^{r-1} \sum_{l=1}^{r-1} \zeta_k \zeta_l \sum_{m=1}^{r-1} \zeta_m \frac{\partial^3 F}{\partial x_k \partial x_l \partial x_m} \\
&= \sum_{k=1}^{r-1} \sum_{l=1}^{r-1} \zeta_k \zeta_l \sum_{m=1}^{r-1} \zeta_m \frac{\partial}{\partial x_m} \left( \frac{\partial^2 F}{\partial x_k \partial x_l} \right) \\
&= \sum_{k=1}^{r-1} \sum_{l=1}^{r-1} \zeta_k \zeta_l \sum_{m=1}^{r-1} \zeta_m \frac{\partial \mathbf{Q}}{\partial x_m} \\
&\approx \sum_{k=1}^{r-1} \sum_{l=1}^{r-1} \zeta_k \zeta_l \sum_{m=1}^{r-1} \zeta_m \frac{\Delta \mathbf{Q}}{\delta x_m} \\
&\approx \sum_{k=1}^{r-1} \sum_{l=1}^{r-1} \zeta_k \zeta_l \mathbf{Q}^*,
\end{align} $$

где

$$ \mathbf{Q}^* = \frac{\mathbf{Q} \left( T, \, V, \, \mathbf{n} + \epsilon \mathbf{\zeta} \right) - \mathbf{Q} \left( T, \, V, \, \mathbf{n} \right)}{\epsilon}. $$

Значение коэффициента $\epsilon$ выбирается достаточно малым, например, $\epsilon = 10^{-6}$. Тогда выражение для величины $\delta^3 F$ можно записать в следующем векторном виде:

$$ \delta^3 F \approx \mathbf{\zeta}^\top \mathbf{Q}^* \mathbf{\zeta}. $$

Таким образом, система уравнений может быть записана в следующем виде:

$$ \begin{cases}
\det \left( \mathbf{Q} \right) = 0, \\
\mathbf{\zeta}^\top \mathbf{Q}^* \mathbf{\zeta} = 0, \; \mathbf{Q} \mathbf{\zeta} = 0, \; \mathbf{\zeta}^\top \mathbf{\zeta} = 1.
\end{cases} $$

Именно в такой формулировке была записана система уравнений автором работы \[[Michelsen, 1980](https://doi.org/10.1016/0378-3812(80)80001-X)\] для нахождения критической точки. Однако ввиду влияния численной погрешности вместо использования определителя матрицы $\mathbf{Q}$ надежнее использовать уравнение равенства нулю минимального собственного значения $\lambda_{min} = 0$. Кроме того, в последующей работе \[[Michelsen and Heidemann, 1981](https://doi.org/10.1002/aic.690270326)\] были представлены аналитические выражения для расчета матрицы частных производных логарифма летучести и величины $C = \delta^3 F$ с использованием [кубических уравнений состояния](../2-EOS/EOS-2-SRK-PR.md):

````{margin}
```{admonition} Дополнительно
В оригинальной работе \[[Michelsen and Heidemann, 1981](https://doi.org/10.1002/aic.690270326)\] в уравнении (18) – опечатка в последнем слагаемом.
```
````

$$ n^2 C = R T \left( -\sum_{i=1}^{N_c} \frac{\zeta_i^3}{y_i^2} + 3 \bar{\zeta} \left( \bar{\beta} F_1 \right)^2 + 2 \left( \bar{\beta} F_1 \right)^3 \right) + \frac{\alpha_m}{b_m} \left( 3 \bar{\beta}^2 \left( 2 \bar{\alpha} - \bar{\beta} \right) \left( F_3 + F_6 \right) - 2 \bar{\beta}^3 F_4 - 3 \bar{\beta} \bar{a} F_6 \right), $$

где: \
&emsp;$n$ – количество вещества системы, моль; \
&emsp;$C = \delta^3 F$ – кубический элемент разложения энергии Гельмгольца в ряд Тейлора, Дж; \
&emsp;$\mathbf{\zeta} \in {\rm I\!R}^{N_c}$ – вектор изменений количеств вещества компонентов, $\mathbf{Q} \mathbf{\zeta} = 0, \, \mathbf{\zeta}^\top \mathbf{\zeta} = 1$, моль; \
&emsp;$\mathbf{y}$ – вектор мольных долей компонентов в системе, д.ед.; \
&emsp;$\bar{\zeta} = \sum_{i=1}^{N_c} \zeta_i$; \
&emsp;$\bar{\beta} = \mathbf{\zeta}^\top \mathbf{\beta}$, где $\mathbf{\beta} \in {\rm I\!R}^{N_c} \, : \, \beta_i = b_i \, / \, b_m$; \
&emsp;$\bar{\alpha} = \mathbf{\zeta}^\top \mathbf{\alpha}$, где $\mathbf{\alpha} \in {\rm I\!R}^{N_c} \, : \, \alpha_i = \left( \sum_{j=1}^{N_c} \alpha_{ij} y_j \right) \, / \, \alpha_m$; \
&emsp;$\bar{a} = \sum_{i=1}^{N_c} \sum_{j=1}^{N_c} \alpha_{ij} \zeta_i \zeta_j$; \
&emsp;$F_1 = 1 \, / \, \left( \kappa - 1 \right)$, где $\kappa = v \, / \, b_m$; \
&emsp;$F_2 = 2 \left( \delta_1 \, / \left( \kappa + \delta_1 \right) - \delta_2 \, / \left( \kappa + \delta_2 \right) \right) \, / \left( \delta_1 - \delta_2 \right)$; \
&emsp;$F_3 = \left( \left( \delta_1 \, / \left( \kappa + \delta_1 \right) \right)^2 - \left( \delta_2 \, / \left( \kappa + \delta_2 \right) \right)^2 \right) \, / \left( \delta_1 - \delta_2 \right)$; \
&emsp;$F_4 = \left( \left( \delta_1 \, / \left( \kappa + \delta_1 \right) \right)^3 - \left( \delta_2 \, / \left( \kappa + \delta_2 \right) \right)^3 \right) \, / \left( \delta_1 - \delta_2 \right)$; \
&emsp;$F_5 = 2 \ln \left( \left( \kappa + \delta_1 \right) \, / \left( \kappa + \delta_2 \right) \right) \, / \left( \delta_1 - \delta_2 \right)$; \
&emsp;$F_6 = F_2 - F_5$.

Остальные обозначения, в том числе $v, \, \delta_1, \, \delta_2, \, \alpha_{ij}, \, b_i, \, \alpha_m, \, b_m$, соответствуют обозначениям, используемым при рассмотрении [кубических уравнений состояния](../2-EOS/EOS-2-SRK-PR.md).

Для решения рассматриваемой системы нелинейных уравнений относительно основных переменных (объема и температуры или давления и температуры) будем использовать метод Ньютона. Для нахождения производных данных уравнений по основным переменным может быть применен численный подход. При этом данная система уравнений может решаться как одновременно, так и с использованием вложенных циклов, то есть во внутреннем цикле решается первое уравнение, во внешнем – второе. Далее будет рассмотрен именно подход с использованием вложенных циклов. На $k$-й итерации внутреннего цикла первое нелинейное уравнение решается относительно температуры для заданного объема $V$ (или давления), то есть изохорно ищется ближайшая точка на спинодали.

$$ T_{k+1} = T_k - \frac{\lambda_{min} \left(V, \, T_k \right)}{\frac{\partial \lambda_{min} \left(V, \, T \right)}{\partial T} \bigg|_{T_k}}. $$

На начальной итерации значение производной минимального собственного значения может быть определено численным способом, задавшись небольшим сдвигом по температуре $\delta T = 10^{-5} T$:

$$ \frac{\partial \lambda_{min} \left(V, \, T \right)}{\partial T} \bigg|_{T_k} \approx \frac{\lambda_{min} \left(V, \, T_k + \delta T \right) - \lambda_{min} \left(V, \, T_k \right)}{\delta T}. $$

На последующих итерациях для нахождения этой производной используются значения с предыдущих итераций:

$$ \frac{\partial \lambda_{min} \left(V, \, T \right)}{\partial T} \bigg|_{T_k} \approx \frac{\lambda_{min} \left(V, \, T_k \right) - \lambda_{min} \left(V, \, T_{k-1} \right)}{T_k - T_{k-1}}. $$

Такой квазиньютоновский подход к расчету температуры на $\left( k+1 \right)$-й итерациии позволяет рассчитывать минимальное собственное значение только один раз за итерацию. Начальное приближение для критической температуры смеси авторы работы \[[Heidemann and Khalil, 1980](https://doi.org/10.1002/aic.690260510)\] рекомендуют рассчитывать с использованием следующего выражения:

$$ T_0 = 1.5 \sum_{i=1}^{N_c} {T_c}_i y_i. $$

В работе \[[Michelsen and Heidemann, 1981](https://doi.org/10.1002/aic.690270326)\] было предложено использовать схожее начальное приближение, но с другим коэффициентом:

$$ T_0 = 1.3 \sum_{i=1}^{N_c} {T_c}_i y_i. $$

Стоит также отметить, что для нахождения минимального собственного значения матрицы $\mathbf{Q}$ могут быть использованы различные итерационные методы, например, [обратный степенной метод](https://en.wikipedia.org/wiki/Inverse_iteration), [метод итераций Рэлея](https://en.wikipedia.org/wiki/Rayleigh_quotient_iteration) или [метод Ньютона](https://doi.org/10.2478/cmam-2003-0033). В данном разделе будет применяться [реализация](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/utils.py) метода итераций Рэлея, которая возвращает кортеж из количества затраченных итераций, единичного собственного вектора $\mathbf{\zeta}$ и соответствующего ему собственного значения $\lambda$. Поскольку в результате решения данного уравнения минимальное собственное значение становится равным нулю, $\lambda_{min} = 0$, то соответствующий собственный вектор $\mathbf{\zeta}$ будет являться нетривиальным решением уравнения $\mathbf{Q} \mathbf{\zeta} = 0$ и удовлетворять условию $\mathbf{\zeta}^\top \mathbf{\zeta} = 1$.

Рассмотрим применение данного алгоритма для разрешения первого условия критического состояния на следующем примере:

````{admonition} Пример
:class: exercise
Пусть имеется $1 \; моль$ смеси следующего мольного состава:

```{table}
:width: 100%
:widths: "1, 1, 1, 1, 1, 1, 1"
| $\mathrm{CH_4}$ | $\mathrm{CH_4}$ | $\mathrm{C_2 H_6}$ | $\mathrm{C_3 H_8}$ | $\mathrm{n \mbox{-} C_4}$ | $\mathrm{n \mbox{-} C_5}$ | $\mathrm{n \mbox{-} C_6}$ |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 0.014  | 0.943  | 0.027  | 0.0074 | 0.0049 | 0.001  | 0.0027 |
```

<br>

Необходимо определить критические давление и температуру смеси.
````

В данном примере будем использовать [уравнение состояния Пенга-Робинсона](../2-EOS/EOS-2-SRK-PR.md) и его [реализацию](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/eos.py), позволяющую рассчитывать частные производные логарифмов летучести компонентов по их количеству вещества для известных объема и температуры. Зададим свойства компонентов, компонентный состав и инициализируем класс с уравнением состояния:

```{code-cell} python
yi = np.array([0.014, 0.943, 0.027, 0.0074, 0.0049, 0.001, 0.0027]) # Component composition [fr.]
Pci = np.array([33.5, 45.4, 48.2, 41.9, 37.5, 33.3, 32.46]) * 101325. # Critical pressures [Pa]
Tci = np.array([126.2, 190.6, 305.4, 369.8, 425.2, 469.6, 507.5]) # Critical temperatures [K]
wi = np.array([0.04, 0.008, 0.098, 0.152, 0.193, 0.251, 0.27504]) # Acentric factors
mwi = np.array([28.013, 16.043, 30.07, 44.097, 58.124, 72.151, 86.]) / 1e3 # Molar mass [kg/gmole]
vsi = np.zeros_like(yi) # Volume shift coefficients
dij = np.array([
    0.025,
    0.01, 0.0,
    0.09, 0.0, 0.0,
    0.095, 0.0, 0.0, 0.0,
    0.11, 0.0, 0.0, 0.0, 0.0,
    0.11, 0.0, 0.0, 0.0, 0.0, 0.0,
]) # Binary interaction parameters
pr = pr78(Pci, Tci, wi, mwi, vsi, dij)
```

Также импортируем [реализацию](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/utils.py) метода итераций Рэлея для нахождения минимального собственного значения:

```{code-cell} python
from utils import mineig_rayquot
```

Определим объем, при котором необходимо найти температуру на спинодали:

```{code-cell} python
n = 1. # Mixture mole number [gmole]
kappa = 3.5 # Initial guess for the molar volume to repulsion parameter ratio
bm = yi.dot(pr.bi) # Repulsion parameter [m3/gmole]
V = kappa * bm * n # Volume of the mixture [m3]
```

Вычилим начальное приближение для температуры:

```{code-cell} python
k = 0 # Iteration count for the first critical condition
Tk = 1.3 * yi.dot(Tci) # Initial estimate of temperature [K]
```

Получим матрицу частных производных логарифмов летучести компонентов по их количеству вещества $\mathbf{Q}$ для заданных объема и начального приближения температуры:

```{code-cell} python
lnfi, Q = pr.getVT_lnfi_dnj(V, Tk, yi)
```

Выполним расчет минимального собственного значения $\lambda$ и соответствующего ему вектора $\mathbf{\zeta}$ для начальных приближений:

```{code-cell} python
Nitrq, zetai, lmbdk = mineig_rayquot(Q, yi)
print(f'Rayleigh quotient iteration:\n\t{Nitrq = }\n\t{lmbdk = }')
```

Для начального приближения минимальное собственное значение матрицы $\mathbf{Q}$ получилось больше нуля, то есть начальное приближение не находится на спинодали рассматриваемой смеси. Определим такую темперутуру, решая уравнение $\lambda_{min} \left( T, \, V \right) = 0$ с использованием представленного выше численного метода. На его первой итерации необходимо получить значение частной производной минимального собственного значения по температуре. Зададимся небольшим сдвигом температуры, определим матрицу частных производных для соответствующей температуры и ее минимальное собственное значение. Необходимо отметить, что во избежание влияния погрешности определения минимального собственного значения на его частную производную по температуре, будем использовать метод `np.linalg.eigvals` для определения собственных значений матрицы и метод `np.min` для выбора минимального из них. Данный подход будет использоваться только на начальной итерации:

```{code-cell} python
dT = 1e-5 * Tk
lmbdkdT = np.linalg.eigvals(pr.getVT_lnfi_dnj(V, Tk + dT, yi)[1]).min()
dlmbddT = (lmbdkdT - lmbdk) / dT
dT = -lmbdk / dlmbddT
print(f'Iteration #{k}:\n\t{Tk = }\n\t{lmbdk = }\n\t{dT = }\n')
k = 1
```

Решим первое условие критического состояния с использованием чиленного подхода. Значения производных минимального собственного значения по температуре будем определять с использованием предложенного выше квазиньютоновского подхода.

```{code-cell} python
while (np.abs(lmbdk) > 1e-5) & (k < 25):
    Tkp1 = Tk + dT
    Q = pr.getVT_lnfi_dnj(V, Tkp1, yi)[1]
    Nitrq, zetai, lmbdkp1 = mineig_rayquot(Q, zetai)
    dlmbddT = (lmbdkp1 - lmbdk) / dT
    dT = -lmbdkp1 / dlmbddT
    Tk = Tkp1
    lmbdk = lmbdkp1
    print(f'Iteration #{k}:\n\t{Tk = }\n\t{lmbdk = }\n\t{Nitrq = }\n\t{dT = }\n')
    k += 1
```

Представленный алгоритм нашел решение за семь итераций (включая начальную). На каждой из них методу Рэлея для определения минимального собственного значения требовалось всего 2 – 3 итерации, поскольку в качестве начального приближения собственного вектора передавались результаты предыдущей итерации. Полученный вектор собственных значений является единичным:

```{code-cell} python
zetai.dot(zetai)
```

А также является нетривиальным решением уравнение $\mathbf{Q} \mathbf{\zeta} = 0$:

```{code-cell} python
np.linalg.norm(Q.dot(zetai))
```

В последующем будем использовать [реализацию](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/boundary.py) данного алгоритма в виде функции `getVT_Tspinodal`:

```{code-cell} python
from boundary import getVT_Tspinodal
```

Стоит отметить, что, принимая во внимание неточность определения производной функции минимального собственного значения, а также численную погрешность итерационных методов расчета минимального собственного значения, для надежной работы представленного выше подхода необходимо достаточно хорошее начальное приближение к спинодальной температуре для заданного объема термодинамической системы. В качестве такого начального приближения может быть использована температура с предыдущей итерации внешнего цикла. Кроме того, решением уравнения $\mathbf{Q} \mathbf{\zeta} = 0$ является не только вектор $\mathbf{\zeta}$, но также и вектор $-\mathbf{\zeta}$. Дискретная вариация знака в значениях вектора изменения количеств вещества компонентов на каждой $j$-й итерации внешнего цикла решения уравнения $C = \delta^3 F = 0$ может приводить к плохой сходимости численного метода. В связи с этим, необходимо осуществлять проверку знака элементов решения уравнения $\mathbf{Q} \mathbf{\zeta} = 0$ и умножать вектор $\mathbf{\zeta}$ на $-1$ на $j$-й итерации, если:

$$ {\zeta_1}_{j} {\zeta_1}_{j-1} < 0, $$

где $\zeta_1$ – первый элемент вектора $\mathbf{\zeta}$ на соответствующей итерации.

После решения уравнения $\lambda_{min} = 0$ выполняется $j$-я итерация внешнего цикла решения уравнения $C = \delta^3 F = 0$. Данное уравнение при использовании [кубических уравнений состояния](../2-EOS/EOS-2-SRK-PR.md) рекомендуется решать относительно безразмерного параметра $\kappa$:

$$ \kappa = \frac{v}{b_m}, $$

где $v = V \, / \, n$ – молярный объем системы, представляющий отношение объема $V$ к количеству вещества системы $n$; $b_m$ – параметр, определяющий объем полностью сжатой системы при бесконечно большом давлении и вычисляемый с использованием правил смешивания. Кроме того, для повышения надежности алгоритма авторы работы \[[Heidemann and Khalil, 1980](https://doi.org/10.1002/aic.690260510)\] предложили заменить функцию $C$:

$$ C^* = \left( \kappa - 1 \right)^2 C . $$

Поскольку область допустимых значений молярного объема системы для кубических уравнений состояния $v > b_m \Leftrightarrow \kappa > 1$, то данная модификация не приведет к появлению дополнительного корня. Таким образом, второе условие для критического состояния системы записывается:

$$ C^* = 0. $$

Для решения данного уравнения также может быть использован метод Ньютона, для которого итерация определяется следующим выражением:

$$ \kappa_{j+1} = \kappa_j - \frac{C^* \left( \kappa_j, \, T \right)}{\frac{\partial C^* \left( \kappa, \, T \right)}{\partial \kappa} \bigg|_{\kappa_j}}.$$

Частная производная функции $C^* \left( \kappa, \, T \right)$ по $\kappa$ также может быть определена с использованием квазиньютоновского численного подхода с учетом результатов предыдущей итерации:

$$ \frac{\partial C^* \left( \kappa, \, T \right)}{\partial \kappa} \bigg|_{\kappa_j} \approx \frac{C^* \left( \kappa_j, \, T \right) - C^* \left( \kappa_{j-1}, \, T \right)}{\kappa_j - \kappa_{j-1}}. $$

На первой итерации значение производной может быть определено для небольшого сдвига объема системы $\delta V$ аналогичным способом, как и при нахождения спинодальной температуры для заданного объема. В качестве начального приближения для второго уравнения второго условия критического состояния авторами работы \[[Michelsen and Heidemann, 1981](https://doi.org/10.1002/aic.690270326)\] рекомендуется следующее значение

$$ \kappa = 3.5. $$

Стоит отметить, что иногда такое начальное приближение находится достаточного далеко от критического состояния смеси, что может приводить к несходимости алгоритма. Для улучшения начального приближения может применяться процедура расчета значений величины $C = \delta^3 F$ для серии значений параметра $\kappa$, полученной с равным шагом, например, $0.1$. В качестве минимального и максимального значений допустимо использовать значения $\kappa = 1.1$ и $\kappa = 5.0$ соответственно. Тот отрезок от $\left( \kappa_{l}, \, \kappa_{l+1} \right)$, где происходит смена значений величины $C = \delta^3 F$, может быть впоследствии использован для получения более точного начального приближения.

Ранее для рассматриваемой смеси была определена температура на спинодали, соответствующая начальному приближению $\kappa = 3.5$, а также вектор $\mathbf{\zeta}$, удовлетворяющий условиям $\mathbf{\zeta}^\top \mathbf{\zeta} = 1$ и $\mathbf{Q} \mathbf{\zeta} = 0$.

```{code-cell} python
T = Tk
T, zetai
```

Определим значения параметра $C^*$ для полученной температуры и вектора изменений количества вещества компонентов. Для этого будем использовать представленное выше аналитическое выражение, реализованное в качестве метода `getVT_d3F` инициализированного класса с уравнением состояния:

```{code-cell} python
C = (kappa - 1)**2 * pr.getVT_d3F(V, T, yi, zetai)
C
```

Для выполнения первой итерации необходимо получить значение производной $\frac{\partial C^* \left( \kappa, \, T \right)}{\partial \kappa}$. Для ее определения с использованием метода конечных разностей зададимся небольшим приращением $\delta V = 10^{-5} V$:

```{code-cell} python
dV = 1e-5 * V
Vs = V + dV
kappas = (Vs / n) / bm
Cs = (kappas - 1)**2 * pr.getVT_d3F(Vs, T, yi, zetai)
dCdkappa = (Cs - C) / (kappas - kappa)
dkappa = -C / dCdkappa
```

Таким образом, для итерации $j=0$ решения второго условия критического состояния определены следующие параметры:

```{code-cell} python
j = 0
kappaj = kappa
zetaij = zetai
Cj = C
print(f'Iteration #{j}:\n\t{Cj = }\n\t{kappaj = }\n\t{dkappa = }\n\t{T = }')
j += 1
```

Решим уравнение с использованием представленного выше численного алгоритма:

```{code-cell} python
while (np.abs(dkappa) > 1e-6) & (j < 20):
    kappajp1 = kappaj + dkappa
    V = bm * kappajp1 * n
    T, zetaijp1 = getVT_Tspinodal(V, yi, pr, T, zetaij)
    if zetaijp1[0] * zetaij[0] < 0.:
        zetaijp1 *= -1.
    Cjp1 = (kappajp1 - 1)**2 * pr.getVT_d3F(V, T, yi, zetaijp1)
    dCdkappa = (Cjp1 - Cj) / dkappa
    dkappa = -Cjp1 / dCdkappa
    kappaj = kappajp1
    Cj = Cjp1
    zetaij = zetaijp1
    print(f'Iteration #{j}:\n\t{Cj = }\n\t{kappaj = }\n\t{dkappa = }\n\t{T = }\n')
    j += 1
```

Видим, что в результате применения рассматриваемого алгоритма было найденно решение, удовлетворяющее условиям критического состояния. Таким образом, для рассматриваемого примера критические давление и температура:

```{code-cell} python
Vc = kappaj * bm * n
print(f'Tc = {T - 273.15: .1f} C\nPc = {pr.getVT_P(V, T, yi) / 1e6: .3f} MPa')
```

Пример реализации сфорулированного численного метода определения критического состояния многокомпонентной системы представлен [здесь](https://github.com/DanielSkorov/ReservoirSimulation/blob/main/_src/boundary.py).

Данным разделом завершается часть курса, посвященная PVT-моделированию, рассматривающая теоретические и алгоритмические аспекты определения равновесного состояния, стабильности и критического состояния многокомпонентных систем. Необходимо отметить, что существует еще множество интересных задач, например, определение градиента компонентного состава залежи углеводородов по глубине, без которого невозможна корректная инициализация композиционных гидродинамических моделей нефтегазовых залежей; определение давления многоконтактного смешивания компонентных составов закачиваемого и пластового флюидов; рассмотрение подходов к разделению плюс-фракции и формированию псевдокомпонентов; расчет количества выпавших асфальтенов и других, которым будет посвящен отдельный [раздел](../5-ETC/ETC-0-Introduction.md).

В следующем разделе будут рассматриваться моделирование лабораторных экспериментов, а также некоторые практические особенности построения и адаптации композиционных PVT-моделей залежей углеводородов.
